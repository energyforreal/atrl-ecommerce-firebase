<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Business Dashboard | ATTRAL E-commerce</title>
  <meta name="description" content="Real-time business dashboard for ATTRAL e-commerce management" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #6366f1;
      --secondary: #8b5cf6;
      --accent: #06b6d4;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --dark: #0f172a;
      --light: #f8fafc;
      --card: #ffffff;
      --border: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1);
      --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    .dashboard-container {
      min-height: 100vh;
      padding: 2rem;
      max-width: 1400px;
      margin: 0 auto;
    }

    .dashboard-header {
      background: var(--gradient-primary);
      color: white;
      padding: 3rem;
      border-radius: 24px;
      margin-bottom: 2.5rem;
      box-shadow: var(--shadow-xl);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .dashboard-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, rgba(255,255,255,0.15) 0%, transparent 30%, rgba(255,255,255,0.05) 70%, transparent 100%);
      pointer-events: none;
    }

    .dashboard-header::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      pointer-events: none;
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      50% { transform: translate(-20px, -20px) rotate(180deg); }
    }

    .dashboard-title {
      font-size: 2.75rem;
      font-weight: 800;
      margin-bottom: 0.75rem;
      position: relative;
      z-index: 2;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      letter-spacing: -0.025em;
    }

    .dashboard-subtitle {
      font-size: 1.25rem;
      opacity: 0.95;
      margin-bottom: 1.5rem;
      position: relative;
      z-index: 2;
      font-weight: 500;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      background: rgba(255, 255, 255, 0.25);
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      font-size: 0.9rem;
      font-weight: 600;
      position: relative;
      z-index: 2;
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .live-dot {
      width: 10px;
      height: 10px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--card);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity 0.4s ease;
      border-radius: 20px 20px 0 0;
    }

    .stat-card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-xl);
      border-color: var(--primary);
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .stat-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-icon {
      font-size: 1.5rem;
      opacity: 0.7;
    }

    .stat-value {
      font-size: 2.75rem;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 0.75rem;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .stat-change {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .trend-up { color: var(--success); }
    .trend-down { color: var(--danger); }

    .content-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .content-card {
      background: var(--card);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .content-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border);
    }

    .card-title {
      font-size: 1.375rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.025em;
    }

    .card-action {
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-md);
    }

    .card-action:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th,
    .table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    /* Order Fulfillment Aesthetics */
    .fulfillment-card { background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%); }
    .fulfillment-wrap { border-radius: 14px; overflow: hidden; box-shadow: 0 10px 24px rgba(0,0,0,0.06); border: 1px solid #e5e7eb; }
    .fulfillment-table { border-collapse: separate; border-spacing: 0; }
    .fulfillment-table thead th { background: linear-gradient(135deg, #111827 0%, #1f2937 100%); color: #fff; border: none; }
    .fulfillment-table thead th + th { border-left: 1px solid rgba(255,255,255,0.08); }
    .fulfillment-table tbody tr { background: #fff; transition: transform .15s ease, box-shadow .15s ease, background-color .15s ease; }
    .fulfillment-table tbody tr:nth-child(even) { background: #f9fafb; }
    .fulfillment-table tbody tr:hover { background: #f3f4f6; transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,0.06); }
    .fulfillment-table td { border-right: 1px solid #e5e7eb; }
    .fulfillment-table td:last-child, .fulfillment-table th:last-child { border-right: none; }
    .amount-cell { font-weight: 800; color: #059669; font-size: 1.05rem; }
    .paid-badge { font-size: 0.75rem; padding: 6px 12px; }
    .fulfillment-chip { font-size: 0.8rem; padding: 8px 12px; }

    .table th {
      background: var(--light);
      font-weight: 600;
      color: var(--dark);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .table tbody tr:hover {
      background: var(--light);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.75rem;
      border-radius: 50px;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
    }

    .status-pending { 
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); 
      color: #92400e; 
      border: 1px solid #f59e0b;
      box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
    }
    .status-completed { 
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); 
      color: #065f46; 
      border: 1px solid #10b981;
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
    }
    .status-processing { 
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); 
      color: #1e40af; 
      border: 1px solid #3b82f6;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
    }
    .status-cancelled { 
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); 
      color: #991b1b; 
      border: 1px solid #ef4444;
      box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
    }
    .status-incomplete { 
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); 
      color: #6b7280; 
      border: 1px solid #9ca3af;
      box-shadow: 0 2px 4px rgba(156, 163, 175, 0.2);
    }

    /* Enhanced button hover effects */
    .btn-small:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Modal animations */
    .modal {
      animation: fadeIn 0.3s ease-out;
    }

    .modal-content {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from { 
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Form input focus effects */
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6 !important;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
      transform: translateY(-1px);
    }

    /* Status badge animations */
    .status-badge {
      transition: all 0.2s ease;
    }

    .status-badge:hover {
      transform: scale(1.05);
    }

    /* Table row hover effects */
    .table tbody tr:hover {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Enhanced form styling */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s ease;
      background: white;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      transform: translateY(-1px);
    }

    .form-group input[readonly] {
      background: #f9fafb;
      color: #6b7280;
      cursor: not-allowed;
    }

    /* Button enhancements */
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border: none;
      color: white;
      transition: all 0.2s ease;
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      color: white;
      transition: all 0.2s ease;
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* Modal backdrop blur effect */
    .modal {
      backdrop-filter: blur(4px);
      background: rgba(0, 0, 0, 0.5);
    }

    /* Loading states */
    .btn-loading {
      position: relative;
      color: transparent;
    }

    .btn-loading::after {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 3rem;
      color: #6b7280;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .quick-action {
      background: white;
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      color: inherit;
      position: relative;
      overflow: hidden;
    }

    .quick-action::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
      transition: left 0.5s ease;
    }

    .quick-action:hover {
      border-color: var(--primary);
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.15);
    }

    .quick-action:hover::before {
      left: 100%;
    }

    .quick-action-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      color: var(--primary);
    }

    .quick-action-title {
      font-weight: 600;
      margin: 0 0 0.5rem;
      color: var(--dark);
    }

    .quick-action-desc {
      font-size: 0.875rem;
      color: #6b7280;
      margin: 0;
    }

    .chart-container {
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--light);
      border-radius: 8px;
      color: #6b7280;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #6b7280;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .refresh-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 2rem;
    }

    .refresh-btn:hover {
      background: #059669;
      transform: translateY(-2px);
    }

    @media (max-width: 1024px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .dashboard-container {
        padding: 1rem;
      }
      
      .dashboard-title {
        font-size: 2rem;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .quick-actions {
        grid-template-columns: 1fr;
      }
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2rem;
      border-bottom: 2px solid var(--border);
    }

    .modal-header h2 {
      margin: 0;
      color: var(--dark);
    }

    .close {
      font-size: 2rem;
      font-weight: bold;
      cursor: pointer;
      color: #999;
    }

    .close:hover {
      color: var(--danger);
    }

    .modal-body {
      padding: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--dark);
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: #5a67d8;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    /* Enhanced Footer Styles */
    .enhanced-footer {
      position: relative;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      color: #f8fafc;
      margin-top: 4rem;
      overflow: hidden;
      border-top: 3px solid transparent;
      border-image: linear-gradient(90deg, #6366f1, #8b5cf6, #06b6d4) 1;
    }

    .enhanced-footer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 20%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 60%, rgba(6, 182, 212, 0.05) 0%, transparent 50%);
      pointer-events: none;
    }

    /* Decorative Background Elements */
    .footer-bg-elements {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .footer-wave-1 {
      position: absolute;
      top: -50px;
      left: 0;
      right: 0;
      height: 100px;
      background: linear-gradient(45deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
      border-radius: 50% 50% 0 0;
      transform: rotate(-2deg);
    }

    .footer-wave-2 {
      position: absolute;
      bottom: -30px;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(99, 102, 241, 0.1));
      border-radius: 0 0 50% 50%;
      transform: rotate(1deg);
    }

    .footer-particles {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(99, 102, 241, 0.3);
      border-radius: 50%;
      animation: float-particle 8s infinite ease-in-out;
    }

    .particle:nth-child(1) {
      top: 20%;
      left: 10%;
      animation-delay: 0s;
    }

    .particle:nth-child(2) {
      top: 60%;
      left: 80%;
      animation-delay: 2s;
    }

    .particle:nth-child(3) {
      top: 40%;
      left: 30%;
      animation-delay: 4s;
    }

    .particle:nth-child(4) {
      top: 80%;
      left: 60%;
      animation-delay: 6s;
    }

    .particle:nth-child(5) {
      top: 30%;
      left: 70%;
      animation-delay: 8s;
    }

    @keyframes float-particle {
      0%, 100% {
        transform: translateY(0) scale(1);
        opacity: 0.3;
      }
      50% {
        transform: translateY(-20px) scale(1.2);
        opacity: 0.8;
      }
    }

    /* Newsletter Section */
    .footer-newsletter {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 20px;
      padding: 2.5rem;
      margin-bottom: 3rem;
      position: relative;
      z-index: 2;
      backdrop-filter: blur(10px);
    }

    .newsletter-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
    }

    .newsletter-text h3 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .newsletter-text p {
      color: #cbd5e1;
      font-size: 0.95rem;
      margin: 0;
    }

    .newsletter-form {
      flex-shrink: 0;
      min-width: 300px;
    }

    .input-group {
      display: flex;
      gap: 0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .newsletter-input {
      flex: 1;
      padding: 0.875rem 1.25rem;
      border: none;
      background: #ffffff;
      color: #1e293b;
      font-size: 0.9rem;
      outline: none;
    }

    .newsletter-input::placeholder {
      color: #64748b;
    }

    .newsletter-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.875rem 1.5rem;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      border: none;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .newsletter-btn:hover {
      background: linear-gradient(135deg, #5b21b6, #7c3aed);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.3);
    }

    .newsletter-disclaimer {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-top: 0.5rem;
      text-align: center;
    }

    /* Footer Content */
    .footer-inner {
      position: relative;
      z-index: 2;
      padding: 3rem 0 2rem;
    }

    .footer-content {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr;
      gap: 3rem;
      margin-bottom: 3rem;
    }

    .footer-section h4 {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: #f8fafc;
    }

    .section-icon {
      font-size: 1.25rem;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    /* Company Info */
    .company-info {
      max-width: 400px;
    }

    .footer-logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .logo-icon {
      font-size: 2rem;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .footer-logo h4 {
      font-size: 1.5rem;
      font-weight: 800;
      margin: 0;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .company-description {
      color: #cbd5e1;
      line-height: 1.6;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }

    /* Enhanced Social Links */
    .social-links-enhanced {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .social-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: #cbd5e1;
      text-decoration: none;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .social-link:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
      transform: translateX(4px);
      color: #f8fafc;
    }

    .social-link svg {
      width: 18px;
      height: 18px;
      transition: all 0.3s ease;
    }

    .social-link.facebook:hover {
      background: rgba(24, 119, 242, 0.2);
      border-color: #1877f2;
    }

    .social-link.instagram:hover {
      background: rgba(228, 64, 95, 0.2);
      border-color: #e4405f;
    }

    .social-link.twitter:hover {
      background: rgba(29, 161, 242, 0.2);
      border-color: #1da1f2;
    }

    .social-link.linkedin:hover {
      background: rgba(0, 119, 181, 0.2);
      border-color: #0077b5;
    }

    .social-link span {
      font-size: 0.9rem;
      font-weight: 500;
    }

    /* Footer Links */
    .footer-links {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .footer-links li {
      margin-bottom: 0.75rem;
    }

    .footer-links a {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: #cbd5e1;
      text-decoration: none;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      padding: 0.5rem 0;
    }

    .footer-links a:hover {
      color: #6366f1;
      transform: translateX(4px);
    }

    .link-icon {
      font-size: 1rem;
      opacity: 0.8;
    }

    /* Contact Info */
    .contact-details {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .contact-item {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .contact-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .contact-icon {
      font-size: 1.25rem;
      flex-shrink: 0;
      margin-top: 0.125rem;
    }

    .contact-text {
      flex: 1;
    }

    .contact-label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.25rem;
    }

    .contact-text a {
      color: #6366f1;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
    }

    .contact-text a:hover {
      color: #8b5cf6;
    }

    .contact-text span {
      color: #cbd5e1;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    /* Footer Bottom */
    .footer-bottom {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-top: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .footer-bottom-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
    }

    .copyright p {
      margin: 0;
      color: #cbd5e1;
      font-size: 0.9rem;
    }

    .copyright .tagline {
      font-size: 0.8rem;
      color: #94a3b8;
      font-style: italic;
      margin-top: 0.25rem;
    }

    .footer-nav {
      display: flex;
      gap: 2rem;
      align-items: center;
    }

    .nav-link {
      color: #cbd5e1;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s ease;
      position: relative;
    }

    .nav-link:hover {
      color: #6366f1;
    }

    .nav-link::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 0;
      width: 0;
      height: 2px;
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      transition: width 0.3s ease;
    }

    .nav-link:hover::after {
      width: 100%;
    }

    /* Footer Badges */
    .footer-badges {
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      font-size: 0.8rem;
      color: #cbd5e1;
      font-weight: 500;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .badge:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .newsletter-content {
        flex-direction: column;
        text-align: center;
        gap: 1.5rem;
      }

      .newsletter-form {
        min-width: auto;
        width: 100%;
        max-width: 400px;
      }

      .footer-content {
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
      }

      .company-info {
        grid-column: 1 / -1;
        max-width: none;
        text-align: center;
      }

      .social-links-enhanced {
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
      }
    }

    @media (max-width: 768px) {
      .footer-content {
        grid-template-columns: 1fr;
        gap: 2rem;
        text-align: center;
      }

      .footer-bottom-content {
        flex-direction: column;
        gap: 1.5rem;
        text-align: center;
      }

      .footer-nav {
        justify-content: center;
        flex-wrap: wrap;
        gap: 1.5rem;
      }

      .contact-item {
        flex-direction: column;
        text-align: center;
        gap: 0.75rem;
      }

      .footer-newsletter {
        padding: 2rem;
      }

      .input-group {
        flex-direction: column;
      }

      .newsletter-btn {
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .footer-badges {
        flex-direction: column;
        align-items: center;
      }

      .badge {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <h1 class="dashboard-title">üìä Business Dashboard</h1>
      <p class="dashboard-subtitle">ATTRAL E-commerce - Real-time Business Overview</p>
      <div class="live-indicator">
        <div class="live-dot"></div>
        <span>Live Data</span>
        <span id="statsStatus" style="margin-left: 10px; font-size: 0.8rem; color: #f59e0b;">Loading...</span>
      </div>
    </div>

    <!-- Refresh Buttons -->
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
      <button class="refresh-btn" onclick="refreshDashboard()">
        üîÑ Refresh Data
      </button>
      <button class="refresh-btn" onclick="loadDashboardStats()" style="background: linear-gradient(135deg, #10b981, #059669);">
        üìä Update Stats
      </button>
    </div>

    <!-- Quick Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-title">Orders Pending Today</span>
          <span class="stat-icon">üì¶</span>
        </div>
        <div class="stat-value" id="pending-orders-today">0</div>
        <div class="stat-change trend-up">
          <span>üìã</span>
          <span>Ready to ship</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-title">Orders Shipped This Month</span>
          <span class="stat-icon">üöö</span>
        </div>
        <div class="stat-value" id="shipped-orders-month">0</div>
        <div class="stat-change trend-up">
          <span>üìà</span>
          <span>This month</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-title">Revenue Today</span>
          <span class="stat-icon">üí∞</span>
        </div>
        <div class="stat-value" id="revenue-today">‚Çπ0</div>
        <div class="stat-change trend-up">
          <span>üìä</span>
          <span>Today's earnings</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-title">Revenue This Month</span>
          <span class="stat-icon">üíé</span>
        </div>
        <div class="stat-value" id="revenue-month">‚Çπ0</div>
        <div class="stat-change trend-up">
          <span>üìà</span>
          <span>Monthly total</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-title">Total Affiliates</span>
          <span class="stat-icon">ü§ù</span>
        </div>
        <div class="stat-value" id="total-affiliates">0</div>
        <div class="stat-change trend-up">
          <span>üß≤</span>
          <span>Active partners</span>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <a href="admin-dashboard.html" class="quick-action">
        <div class="quick-action-icon">üéõÔ∏è</div>
        <h3 class="quick-action-title">Full Admin Panel</h3>
        <p class="quick-action-desc">Complete admin control center</p>
      </a>
      
      <a href="coupon-admin.html" class="quick-action">
        <div class="quick-action-icon">üé´</div>
        <h3 class="quick-action-title">Coupon Management</h3>
        <p class="quick-action-desc">Create and manage discount coupons</p>
      </a>
      
      <a href="admin-messages.html" class="quick-action">
        <div class="quick-action-icon">üí¨</div>
        <h3 class="quick-action-title">View All Messages</h3>
        <p class="quick-action-desc">Customer inquiries and support</p>
      </a>
      
      <a href="#" class="quick-action" onclick="openProductManager()">
        <div class="quick-action-icon">üõçÔ∏è</div>
        <h3 class="quick-action-title">Add Products</h3>
        <p class="quick-action-desc">Manage product catalog</p>
      </a>
      
      <a href="admin-affiliate-sync.html" class="quick-action">
        <div class="quick-action-icon">üîÑ</div>
        <h3 class="quick-action-title">Affiliate Sync</h3>
        <p class="quick-action-desc">Sync affiliates to Brevo email list</p>
      </a>
      
      <a href="#" class="quick-action" onclick="openEmailComposer()">
        <div class="quick-action-icon">üìß</div>
        <h3 class="quick-action-title">Email Campaign</h3>
        <p class="quick-action-desc">Send custom emails to customers & affiliates</p>
      </a>
      
      <a href="admin-orders.html" class="quick-action">
        <div class="quick-action-icon">üìã</div>
        <h3 class="quick-action-title">Admin Orders</h3>
        <p class="quick-action-desc">View detailed order information</p>
      </a>
      
    </div>


    <!-- Fulfillment Section -->
    <div class="content-card" style="margin-bottom: 2rem;">
      <div class="card-header">
        <h3 class="card-title">üì¶ Order Fulfillment <span style="font-weight:600; font-size:0.95rem; color:#6b7280; margin-left:8px;">Track and manage shipping statuses</span></h3>
        <button class="card-action" onclick="refreshFulfillment()">Refresh</button>
      </div>
      <div id="fulfillment-content">
        <div class="loading">
          <div class="loading-spinner"></div>
          <span>Loading fulfillment data...</span>
        </div>
      </div>
    </div>

    <!-- Affiliate Monitoring -->
    <div class="content-card" style="margin-bottom: 2rem;">
      <div class="card-header">
        <h3 class="card-title">ü§ù Affiliate Monitoring</h3>
        <div style="display:flex; gap: 8px;">
          <button class="card-action" onclick="refreshAffiliates()">Refresh</button>
          <a class="card-action" href="admin-affiliate-sync.html">Open Affiliate Sync Dashboard</a>
        </div>
      </div>
      <div id="affiliates-content">
        <div class="loading">
          <div class="loading-spinner"></div>
          <span>Loading affiliates...</span>
        </div>
      </div>
    </div>

    <!-- Additional Content Grid -->
    <div class="content-grid">
      <!-- Revenue Chart -->
      <div class="content-card">
        <div class="card-header">
          <h3 class="card-title">Revenue Trend</h3>
          <button class="card-action" onclick="refreshChart()">Refresh</button>
        </div>
        <div class="chart-container" id="revenue-chart">
          <div class="empty-state">
            <div class="empty-state-icon">üìà</div>
            <p>Revenue chart will be displayed here</p>
          </div>
        </div>
      </div>

      <!-- Recent Messages -->
      <div class="content-card">
        <div class="card-header">
          <h3 class="card-title">Recent Messages</h3>
          <button class="card-action" onclick="refreshMessages()">Refresh</button>
        </div>
        <div id="recent-messages">
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Loading messages...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Email Composer Modal -->
  <div id="emailComposerModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2>üìß Email Campaign Composer</h2>
        <span class="close" onclick="closeEmailComposer()">&times;</span>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <!-- Email Form -->
          <div>
            <form id="emailComposerForm">
              <div class="form-group">
                <label for="emailSubject">Subject *</label>
                <input type="text" id="emailSubject" name="subject" required placeholder="Enter email subject">
              </div>
              
              <div class="form-group">
                <label for="emailRecipients">Recipients</label>
                <select id="emailRecipients" name="recipients" onchange="updateRecipientCount()">
                  <option value="all">All Customers & Affiliates</option>
                  <option value="customers">Customers Only</option>
                  <option value="affiliates">Affiliates Only</option>
                  <option value="brevo_customer">Brevo Customer List</option>
                  <option value="brevo_affiliate">Brevo Affiliate List</option>
                  <option value="custom">Custom Recipients</option>
                </select>
              </div>
              
              <div class="form-group" id="customRecipientsGroup" style="display: none;">
                <label for="customRecipients">Custom Recipients (comma-separated emails)</label>
                <textarea id="customRecipients" name="customRecipients" rows="3" placeholder="email1@example.com, email2@example.com"></textarea>
              </div>
              
              <div class="form-group">
                <label for="emailContent">Email Content *</label>
                <textarea id="emailContent" name="content" rows="8" required placeholder="Enter your email content here..."></textarea>
              </div>
              
              <div class="form-group">
                <label for="emailFromName">From Name</label>
                <input type="text" id="emailFromName" name="fromName" value="ATTRAL Electronics">
              </div>
              
              <div class="form-group">
                <label for="emailFromEmail">From Email</label>
                <input type="email" id="emailFromEmail" name="fromEmail" value="info@attral.in">
              </div>
              
              <div class="form-group">
                <label for="emailAttachments">Attachments</label>
                <input type="file" id="emailAttachments" name="attachments" multiple accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif">
                <small style="color: #6c757d; font-size: 0.8rem;">Select multiple files (PDF, DOC, images, etc.)</small>
                <div id="attachmentList" style="margin-top: 10px;"></div>
              </div>
              
              <div class="form-actions">
                <button type="button" onclick="closeEmailComposer()" class="btn-secondary">Cancel</button>
                <button type="button" onclick="previewEmail()" class="btn-secondary">Preview</button>
                <button type="submit" class="btn-primary">Send Email</button>
              </div>
            </form>
          </div>
          
          <!-- Recipients Preview -->
          <div>
            <div class="form-group">
              <label>Recipients Preview</label>
              <div id="recipientsPreview" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                <p style="color: #6c757d; margin: 0;">Select recipients to see preview...</p>
              </div>
            </div>
            
            <div class="form-group">
              <label>Email Preview</label>
              <div id="emailPreview" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                <p style="color: #6c757d; margin: 0;">Enter content to see preview...</p>
              </div>
            </div>
            
            <div class="form-group">
              <label>Campaign Stats</label>
              <div id="campaignStats" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
                  <div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #007bff;" id="recipientCount">0</div>
                    <div style="font-size: 0.8rem; color: #6c757d;">Recipients</div>
                  </div>
                  <div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;" id="estimatedDelivery">0</div>
                    <div style="font-size: 0.8rem; color: #6c757d;">Est. Delivery</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Management Modal -->
  <div id="productModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üõçÔ∏è Add New Product</h2>
        <span class="close" onclick="closeProductManager()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="productForm">
          <div class="form-group">
            <label for="productTitle">Product Title *</label>
            <input type="text" id="productTitle" name="title" required>
          </div>
          <div class="form-group">
            <label for="productPrice">Price (‚Çπ) *</label>
            <input type="number" id="productPrice" name="price" required>
          </div>
          <div class="form-group">
            <label for="productDescription">Description *</label>
            <textarea id="productDescription" name="description" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label for="productCategory">Category</label>
            <select id="productCategory" name="category">
              <option value="Electronics">Electronics</option>
              <option value="Accessories">Accessories</option>
              <option value="Chargers">Chargers</option>
            </select>
          </div>
          <div class="form-group">
            <label for="productImage">Image URL</label>
            <input type="url" id="productImage" name="image" placeholder="https://example.com/image.jpg">
          </div>
          <div class="form-actions">
            <button type="button" onclick="closeProductManager()" class="btn-secondary">Cancel</button>
            <button type="submit" class="btn-primary">Add Product</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Tracking ID Modal -->
  <div id="trackingModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üì¶ Add Tracking ID</h2>
        <span class="close" onclick="closeTrackingModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="trackingForm">
          <div class="form-group">
            <label for="orderId">Order ID</label>
            <input type="text" id="orderId" name="orderId" readonly>
          </div>
          <div class="form-group">
            <label for="customerName">Customer Name</label>
            <input type="text" id="customerName" name="customerName" readonly>
          </div>
          <div class="form-group">
            <label for="trackingId">Tracking ID *</label>
            <input type="text" id="trackingId" name="trackingId" required placeholder="e.g., TRK123456789">
          </div>
          <div class="form-group">
            <label for="courierName">Courier Service</label>
            <select id="courierName" name="courierName">
              <option value="Blue Dart">Blue Dart</option>
              <option value="DTDC">DTDC</option>
              <option value="Delhivery">Delhivery</option>
              <option value="India Post">India Post</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="shippingNotes">Shipping Notes</label>
            <textarea id="shippingNotes" name="shippingNotes" rows="3" placeholder="Additional notes about the shipment..."></textarea>
          </div>
          <div class="form-actions">
            <button type="button" onclick="closeTrackingModal()" class="btn-secondary">Cancel</button>
            <button type="submit" class="btn-primary">Mark as Shipped</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Order Cancellation Modal -->
  <div id="cancelOrderModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
      <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border-radius: 16px 16px 0 0; padding: 24px; border-bottom: none;">
        <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 12px;">
          <span style="font-size: 1.8rem;">‚ùå</span>
          Cancel Order
        </h2>
        <span class="close" onclick="closeCancelOrderModal()" style="color: white; font-size: 2rem; font-weight: 300; opacity: 0.8; transition: opacity 0.2s;">&times;</span>
      </div>
      <div class="modal-body" style="padding: 32px;">
        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: 1.2rem;">‚ö†Ô∏è</span>
            <strong style="color: #991b1b;">Warning</strong>
          </div>
          <p style="margin: 0; color: #7f1d1d; font-size: 0.9rem;">This action will cancel the order and initiate a refund process. This action cannot be undone.</p>
        </div>
        
        <form id="cancelOrderForm">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
            <div class="form-group">
              <label for="cancelOrderId" style="font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">Order ID</label>
              <input type="text" id="cancelOrderId" name="orderId" readonly style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 12px; font-family: monospace; font-weight: 600; color: #6b7280;">
            </div>
            <div class="form-group">
              <label for="cancelCustomerName" style="font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">Customer Name</label>
              <input type="text" id="cancelCustomerName" name="customerName" readonly style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 12px; font-weight: 600; color: #6b7280;">
            </div>
          </div>
          
          <div class="form-group" style="margin-bottom: 24px;">
            <label for="cancellationReason" style="font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">Cancellation Reason *</label>
            <select id="cancellationReason" name="reason" required style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; background: white; font-size: 1rem; transition: border-color 0.2s;">
              <option value="">Select a reason</option>
              <option value="customer-request">üë§ Customer Request</option>
              <option value="out-of-stock">üì¶ Out of Stock</option>
              <option value="payment-issue">üí≥ Payment Issue</option>
              <option value="shipping-address-invalid">üìç Invalid Shipping Address</option>
              <option value="fraud-detected">üö® Fraud Detected</option>
              <option value="other">‚ùì Other</option>
            </select>
          </div>
          
          <div class="form-group" style="margin-bottom: 24px;">
            <label for="cancellationNotes" style="font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">Additional Notes</label>
            <textarea id="cancellationNotes" name="notes" rows="3" placeholder="Additional details about the cancellation..." style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; background: white; font-size: 1rem; resize: vertical; min-height: 80px; transition: border-color 0.2s;"></textarea>
          </div>
          
          <div class="form-group" style="margin-bottom: 24px;">
            <label for="refundAmount" style="font-weight: 600; color: #374151; margin-bottom: 8px; display: block;">Refund Amount (‚Çπ)</label>
            <div style="position: relative;">
              <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280; font-weight: 600;">‚Çπ</span>
              <input type="number" id="refundAmount" name="refundAmount" step="0.01" placeholder="Enter refund amount" style="width: 100%; padding: 12px 12px 12px 32px; border: 2px solid #d1d5db; border-radius: 8px; background: white; font-size: 1rem; font-weight: 600; transition: border-color 0.2s;">
            </div>
          </div>
          
          <div class="form-group" style="margin-bottom: 32px;">
            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 16px; background: #f0f9ff; border: 2px solid #bae6fd; border-radius: 8px; transition: all 0.2s;">
              <input type="checkbox" id="notifyCustomer" name="notifyCustomer" checked style="width: 18px; height: 18px; accent-color: #3b82f6;">
              <div>
                <div style="font-weight: 600; color: #1e40af; margin-bottom: 4px;">üìß Notify Customer</div>
                <div style="font-size: 0.9rem; color: #1e3a8a;">Send email notification about the cancellation and refund</div>
              </div>
            </label>
          </div>
          
          <div class="form-actions" style="display: flex; gap: 16px; justify-content: flex-end;">
            <button type="button" onclick="closeCancelOrderModal()" class="btn-secondary" style="padding: 12px 24px; border-radius: 8px; font-weight: 600; transition: all 0.2s;">Cancel</button>
            <button type="submit" class="btn-danger" style="padding: 12px 24px; border-radius: 8px; font-weight: 600; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; color: white; transition: all 0.2s; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);">
              ‚ùå Cancel Order
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Order Details Modal -->
  <div id="orderDetailsModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2>üìã Order Details</h2>
        <span class="close" onclick="closeOrderDetailsModal()">&times;</span>
      </div>
      <div class="modal-body" id="order-details-modal-body">
        <div class="loading">
          <div class="loading-spinner"></div>
          <span>Loading order details...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Affiliate Detail Modal -->
  <div id="affiliateModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üë§ Affiliate Details</h2>
        <span class="close" onclick="closeAffiliateModal()">&times;</span>
      </div>
      <div class="modal-body" id="affiliate-modal-body">
        <div class="loading">
          <div class="loading-spinner"></div>
          <span>Loading affiliate details...</span>
        </div>
      </div>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script src="js/firebase.js"></script>
  <script>
    // Helper functions for order status
    function hasRazorpayPayment(order) {
      try {
        return !!(
          order.razorpayPaymentId ||
          order.paymentId ||
          order.razorpay_payment_id ||
          order.payment_id ||
          (order.payment && (order.payment.transaction_id || order.payment.paymentId))
        );
      } catch (_) {
        return false;
      }
    }

    function getActualOrderStatus(order) {
      const baseStatus = order.status || 'pending';
      const hasPayment = hasRazorpayPayment(order);
      
      // If no payment acknowledgment, status is incomplete regardless of order status
      if (!hasPayment) {
        return 'incomplete';
      }
      
      // If payment exists, use the order status
      return baseStatus;
    }

    // Dashboard Data Management with Firestore Integration
    class DashboardManager {
      constructor() {
        this.data = {
          orders: [],
          messages: [],
          products: [],
          affiliates: [],
          fulfillmentOrders: []
        };
        this.isInitialized = false;
        this.retryCount = 0;
        this.maxRetries = 3;
        this.init();
      }

      async init() {
        console.log('üöÄ Initializing Dashboard with Firestore...');
        try {
          await this.waitForFirebase();
          await this.loadAllData();
          this.startAutoRefresh();
          this.setupRealtimeListeners();
          this.isInitialized = true;
          console.log('‚úÖ Dashboard initialized successfully');
        } catch (error) {
          console.error('‚ùå Dashboard initialization failed:', error);
          await this.handleInitializationError(error);
        }
      }

      async handleInitializationError(error) {
        this.retryCount++;
        console.log(`üîÑ Retry attempt ${this.retryCount}/${this.maxRetries}`);
        
        if (this.retryCount < this.maxRetries) {
          // Wait 2 seconds before retry
          await new Promise(resolve => setTimeout(resolve, 2000));
          await this.init();
        } else {
          console.error('‚ùå Max retries reached. Loading demo data...');
          this.loadDemoData();
          this.showErrorNotification('Failed to connect to Firebase. Showing demo data.');
        }
      }

      loadDemoData() {
        console.log('üìä Loading demo data...');
        this.data.orders = [
          {
            id: 'demo-1',
            orderId: 'ORD-2024-001',
            customerName: 'John Doe',
            customerEmail: 'john@example.com',
            totalAmount: 2999,
            status: 'completed',
            paymentStatus: 'paid',
            fulfillmentStatus: 'delivered',
            createdAt: new Date(),
            items: [{ name: 'Demo Product', quantity: 1, price: 2999 }]
          }
        ];
        this.data.messages = [
          {
            id: 'msg-1',
            name: 'Jane Smith',
            email: 'jane@example.com',
            message: 'Demo message',
            status: 'new',
            timestamp: new Date()
          }
        ];
        this.data.products = [
          {
            id: 'prod-1',
            name: 'Demo Product',
            price: 2999,
            status: 'active',
            createdAt: new Date()
          }
        ];
        this.data.affiliates = [];
        this.updateUI();
      }

      showErrorNotification(message) {
        // Create error notification
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #ef4444;
          color: white;
          padding: 1rem 1.5rem;
          border-radius: 0.5rem;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 10000;
          max-width: 400px;
        `;
        notification.innerHTML = `
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span>‚ö†Ô∏è</span>
            <span>${message}</span>
          </div>
        `;
        document.body.appendChild(notification);
        
        // Remove after 5 seconds
        setTimeout(() => {
          notification.remove();
        }, 5000);
      }

      async waitForFirebase() {
        let attempts = 0;
        const maxAttempts = 100; // Increased attempts
        
        while (attempts < maxAttempts) {
          if (window.AttralFirebase && window.AttralFirebase.db && window.AttralFirebase.auth) {
            console.log('‚úÖ Firebase is ready');
            
            // Test Firestore connection
            try {
              await window.AttralFirebase.db.collection('orders').limit(1).get();
              console.log('‚úÖ Firestore connection test successful');
              return;
            } catch (error) {
              console.warn('‚ö†Ô∏è Firestore connection test failed:', error.message);
              if (attempts > 50) { // After 50 attempts, still try to proceed
                console.log('üîÑ Proceeding despite connection test failure...');
                return;
              }
            }
          }
          attempts++;
          console.log(`‚è≥ Waiting for Firebase... attempt ${attempts}/${maxAttempts}`);
          await new Promise(resolve => setTimeout(resolve, 200)); // Increased delay
        }
        
        throw new Error('Firebase failed to load after maximum attempts');
      }

      async loadAllData() {
        try {
          console.log('üìä Loading all dashboard data...');
          
          // Load data with individual error handling
          const loadPromises = [
            this.loadOrders().catch(err => {
              console.error('‚ùå Failed to load orders:', err);
              this.data.orders = [];
            }),
            this.loadMessages().catch(err => {
              console.error('‚ùå Failed to load messages:', err);
              this.data.messages = [];
            }),
            this.loadProducts().catch(err => {
              console.error('‚ùå Failed to load products:', err);
              this.data.products = [];
            }),
            this.loadFulfillment().catch(err => {
              console.error('‚ùå Failed to load fulfillment:', err);
              this.data.fulfillmentOrders = [];
            }),
            this.loadAffiliates().catch(err => {
              console.error('‚ùå Failed to load affiliates:', err);
              this.data.affiliates = [];
            })
          ];

          await Promise.allSettled(loadPromises);
          
          // Check if we have any data loaded
          const hasData = this.data.orders.length > 0 || 
                         this.data.messages.length > 0 || 
                         this.data.products.length > 0 ||
                         this.data.affiliates.length > 0;
          
          if (hasData) {
            console.log('‚úÖ Dashboard data loaded successfully');
            this.updateUI();
          } else {
            console.warn('‚ö†Ô∏è No data loaded, showing empty state');
            this.updateUI();
          }
          
        } catch (error) {
          console.error('‚ùå Critical error loading dashboard data:', error);
          this.showErrorNotification('Failed to load dashboard data. Please refresh the page.');
        }
      }

      async loadOrders() {
        try {
          console.log('üì¶ Loading orders from Firestore...');
          
          if (!window.AttralFirebase || !window.AttralFirebase.db) {
            throw new Error('Firebase not initialized');
          }

          // Fetch all orders with better error handling
          const ordersSnapshot = await window.AttralFirebase.db
            .collection('orders')
            .orderBy('createdAt', 'desc')
            .limit(500)
            .get();

          const allOrders = [];
          ordersSnapshot.forEach(doc => {
            const orderData = doc.data();
            allOrders.push({
              id: doc.id,
              ...orderData,
              createdAt: orderData.createdAt ? orderData.createdAt.toDate() : new Date()
            });
          });

          this.data.orders = allOrders;
          
          // Helper to get total amount from varying schemas
          const getOrderTotal = (order) => {
            if (typeof order.totalAmount === 'number') return order.totalAmount;
            if (typeof order.amount === 'number') return order.amount;
            if (order.pricing && typeof order.pricing.total === 'number') return order.pricing.total;
            return 0;
          };
          
          // Calculate stats
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          
          const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
          const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 1);
          
          const todayOrders = allOrders.filter(order => 
            order.createdAt >= today && order.createdAt < tomorrow
          );
          
          const monthOrders = allOrders.filter(order => 
            order.createdAt >= monthStart && order.createdAt < monthEnd
          );
          
          const pendingToday = todayOrders.filter(order => {
            const actualStatus = getActualOrderStatus(order);
            return (actualStatus === 'pending' || actualStatus === 'processing');
          }).length;
          
          const shippedThisMonth = monthOrders.filter(order => {
            const actualStatus = getActualOrderStatus(order);
            return (actualStatus === 'shipped' || actualStatus === 'delivered');
          }).length;
          
          const revenueToday = todayOrders.reduce((sum, order) => {
            const actualStatus = getActualOrderStatus(order);
            // Only count revenue for orders with payment acknowledgment
            return sum + (actualStatus !== 'incomplete' ? (parseFloat(getOrderTotal(order)) || 0) : 0);
          }, 0);
          
          const revenueThisMonth = monthOrders.reduce((sum, order) => {
            const actualStatus = getActualOrderStatus(order);
            // Only count revenue for orders with payment acknowledgment
            return sum + (actualStatus !== 'incomplete' ? (parseFloat(getOrderTotal(order)) || 0) : 0);
          }, 0);

          // Update stats
          document.getElementById('pending-orders-today').textContent = pendingToday;
          document.getElementById('shipped-orders-month').textContent = shippedThisMonth;
          document.getElementById('revenue-today').textContent = `‚Çπ${revenueToday.toLocaleString()}`;
          document.getElementById('revenue-month').textContent = `‚Çπ${revenueThisMonth.toLocaleString()}`;

          console.log('‚úÖ Orders loaded:', allOrders.length);
          console.log('üìä Stats - Pending today:', pendingToday, 'Shipped this month:', shippedThisMonth);
          console.log('üí∞ Revenue - Today:', revenueToday, 'This month:', revenueThisMonth);

        } catch (error) {
          console.error('‚ùå Error loading orders:', error);
          // Set default values
          document.getElementById('pending-orders-today').textContent = '0';
          document.getElementById('shipped-orders-month').textContent = '0';
          document.getElementById('revenue-today').textContent = '‚Çπ0';
          document.getElementById('revenue-month').textContent = '‚Çπ0';
        }
      }

      async loadMessages() {
        try {
          console.log('üí¨ Loading messages from Firestore...');
          
          // Use contact_messages which our server writes for admin access
          const messagesSnapshot = await window.AttralFirebase.db
            .collection('contact_messages')
            .orderBy('createdAt', 'desc')
            .limit(5)
            .get();

          this.data.messages = [];
          messagesSnapshot.forEach(doc => {
            const messageData = doc.data();
            this.data.messages.push({
              id: doc.id,
              ...messageData,
              createdAt: messageData.createdAt?.toDate ? messageData.createdAt.toDate() : new Date()
            });
          });

          console.log('‚úÖ Messages loaded:', this.data.messages.length);
        } catch (error) {
          console.error('‚ùå Error loading messages:', error);
          this.data.messages = [];
        }
      }

      async loadProducts() {
        try {
          console.log('üõçÔ∏è Loading products from Firestore...');
          
          const productsSnapshot = await window.AttralFirebase.db
            .collection('products')
            .orderBy('createdAt', 'desc')
            .limit(5)
            .get();

          this.data.products = [];
          productsSnapshot.forEach(doc => {
            const productData = doc.data();
            this.data.products.push({
              id: doc.id,
              title: productData.title || productData.name || 'Unnamed Product',
              price: productData.price || 0,
              image: productData.image || '../assets/product_images/default.jpg',
              category: productData.category || 'Electronics',
              description: productData.description || '',
              featured: productData.featured || false,
              createdAt: productData.createdAt ? productData.createdAt.toDate() : new Date()
            });
          });

          console.log('‚úÖ Products loaded from Firestore:', this.data.products.length);
          console.log('üìä Product data:', this.data.products);
          
          // If no products from Firestore, try JSON fallback
          if (this.data.products.length === 0) {
            console.log('üìÑ No products in Firestore, trying JSON fallback...');
            await this.loadProductsFromJSON();
          }
        } catch (error) {
          console.error('‚ùå Error loading products from Firestore:', error);
          console.log('üìÑ Falling back to JSON...');
          await this.loadProductsFromJSON();
        }
      }

      async loadProductsFromJSON() {
        try {
          console.log('üìÑ Loading products from JSON fallback...');
          const response = await fetch('data/products.json');
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          const products = await response.json();
          
          this.data.products = products.map(p => ({
            id: p.id,
            title: p.title,
            price: p.price,
            image: p.image,
            category: p.category,
            description: p.description,
            featured: p.featured,
            createdAt: new Date()
          }));
          
          console.log('‚úÖ Products loaded from JSON:', this.data.products.length);
          console.log('üìä JSON Product data:', this.data.products);
        } catch (error) {
          console.error('‚ùå Error loading products from JSON:', error);
          this.data.products = [];
        }
      }

      async loadFulfillment() {
        try {
          console.log('üì¶ Loading fulfillment orders from Firestore...');
          
          // Fetch recent orders and filter client-side for those needing fulfillment
          const ordersSnapshot = await window.AttralFirebase.db
            .collection('orders')
            .orderBy('createdAt', 'desc')
            .limit(200)
            .get();

          const all = [];
          ordersSnapshot.forEach(doc => {
            const d = doc.data();
            all.push({
              id: doc.id,
              ...d,
              createdAt: d.createdAt ? d.createdAt.toDate() : new Date()
            });
          });

          const isPaid = (o) => hasRazorpayPayment(o);
          const needsFulfillment = (o) => {
            const actualStatus = getActualOrderStatus(o);
            const fulfillmentStatus = o.fulfillmentStatus || 'yet-to-dispatch';
            
            // Only include paid orders (exclude incomplete/unpaid orders)
            if (!isPaid(o)) {
              return false;
            }
            
            // Include orders that are paid and have valid fulfillment status
            return ['yet-to-dispatch', 'ready-to-dispatch', 'shipped', 'delivered', 'cancelled'].includes(fulfillmentStatus);
          };

          this.data.fulfillmentOrders = all.filter(o => needsFulfillment(o));

          // Debug information
          console.log('üìä Fulfillment Debug Info:');
          console.log('- Total orders fetched:', all.length);
          console.log('- Paid orders:', all.filter(o => isPaid(o)).length);
          console.log('- Orders with fulfillment status:', all.filter(o => o.fulfillmentStatus).length);
          console.log('- Fulfillment orders after filtering:', this.data.fulfillmentOrders.length);
          
          // Log details of each order for debugging
          all.forEach(order => {
            const paid = isPaid(order);
            const fulfillmentStatus = order.fulfillmentStatus || 'yet-to-dispatch';
            const actualStatus = getActualOrderStatus(order);
            console.log(`Order ${order.id}: paid=${paid}, fulfillmentStatus=${fulfillmentStatus}, actualStatus=${actualStatus}`);
          });

          console.log('‚úÖ Fulfillment orders loaded:', this.data.fulfillmentOrders.length);
        } catch (error) {
          console.error('‚ùå Error loading fulfillment orders:', error);
          this.data.fulfillmentOrders = [];
        }
      }

      async loadAffiliates() {
        try {
          console.log('ü§ù Loading affiliates from Firestore...');
          const db = window.AttralFirebase.db;
          // Load up to 200 recent affiliates
          const snap = await db.collection('affiliates')
            .orderBy('createdAt', 'desc')
            .limit(200)
            .get();

          const affiliates = [];
          snap.forEach(doc => {
            const data = doc.data();
            affiliates.push({
              id: doc.id,
              uid: data.uid || doc.id,
              name: data.displayName || data.name || data.email || 'Unknown',
              email: data.email || null,
              code: data.code || null,
              link: data.affiliateLink || null,
              status: data.status || 'active',
              totalEarnings: Number(data.totalEarnings || 0),
              totalReferrals: Number(data.totalReferrals || 0),
              createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : null
            });
          });

          this.data.affiliates = affiliates;
          document.getElementById('total-affiliates').textContent = affiliates.length.toString();
          console.log('‚úÖ Affiliates loaded:', affiliates.length);

          // Inline quick control: reset cycle usage for an affiliate code
          try {
            const existing = document.getElementById('affiliates-content');
            if (existing) {
              const uniqueCodes = [...new Set(affiliates.map(a=>a.code).filter(Boolean))];
              const controls = document.createElement('div');
              controls.style.margin = '12px 0';
              controls.innerHTML = `
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                  <strong>Cycle Usage Controls:</strong>
                  <select id="reset-cycle-code" style="padding:6px 10px; border:1px solid var(--border); border-radius:8px;">
                    ${uniqueCodes.map(c=>`<option value="${c}">${c}</option>`).join('')}
                  </select>
                  <button id="reset-cycle-btn" class="card-action">Reset Cycle</button>
                </div>`;
              // Insert at top
              const parent = existing.parentElement;
              if (parent) parent.insertBefore(controls, existing);
              const btn = document.getElementById('reset-cycle-btn');
              if (btn) btn.onclick = async () => {
                const code = (document.getElementById('reset-cycle-code')||{}).value;
                if (!code) return;
                if (!confirm(`Reset cycle usage for ${code}?`)) return;
                try {
                  const db = window.AttralFirebase && window.AttralFirebase.db;
                  if (!db) throw new Error('Firebase not available');
                  const snap = await db.collection('coupons').where('code','==', code).limit(1).get();
                  if (!snap.empty) {
                    await snap.docs[0].ref.set({ payoutUsage: 0, updatedAt: (window.firebase && window.firebase.firestore ? window.firebase.firestore.FieldValue.serverTimestamp() : new Date()) }, { merge: true });
                    alert('Cycle usage reset');
                  } else {
                    alert('Coupon not found');
                  }
                } catch (e) {
                  alert('Failed to reset: ' + (e.message||'Unknown error'));
                }
              };
            }
          } catch(_) {}
        } catch (error) {
          console.error('‚ùå Error loading affiliates:', error);
          this.data.affiliates = [];
          document.getElementById('total-affiliates').textContent = '0';
        }
      }

      updateUI() {
        this.updateOrders();
        this.updateProducts();
        this.updateMessages();
        this.updateFulfillment();
        this.updateAffiliates();
      }

      updateOrders() {
        // Recent Orders section has been removed - no longer needed
        console.log('üì¶ Orders updated (Recent Orders section removed)');
      }

      updateProducts() {
        // Top Products section has been removed - no longer needed
        console.log('üõçÔ∏è Products updated (Top Products section removed)');
      }

      updateMessages() {
        const messages = this.data.messages.slice(0, 5);
        const container = document.getElementById('recent-messages');
        
        if (messages.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><p>No messages found</p></div>';
          return;
        }

        const list = `
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            ${messages.map(message => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--light); border-radius: 8px; border-left: 4px solid ${message.status === 'new' ? 'var(--primary)' : 'var(--success)'};">
                <div>
                  <div style="font-weight: 600; color: var(--dark);">${message.name || 'Unknown'}</div>
                  <div style="font-size: 0.875rem; color: #6b7280;">${message.subject || message.message?.substring(0, 50) + '...' || 'No subject'}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 0.75rem; color: #6b7280;">${message.createdAt.toLocaleDateString()}</div>
                  <div style="font-size: 0.75rem; color: ${message.status === 'new' ? 'var(--primary)' : 'var(--success)'}; font-weight: 600;">
                    ${message.status === 'new' ? 'NEW' : 'READ'}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        
        container.innerHTML = list;
      }

      updateFulfillment() {
        const orders = this.data.fulfillmentOrders || [];
        const container = document.getElementById('fulfillment-content');
        
        if (orders.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 16px; border: 2px dashed #cbd5e1;">
              <div style="font-size: 4rem; margin-bottom: 24px; opacity: 0.6;">üì¶</div>
              <h3 style="color: #475569; font-size: 1.5rem; font-weight: 600; margin-bottom: 12px;">No Orders Pending Fulfillment</h3>
              <p style="color: #64748b; font-size: 1rem; margin-bottom: 24px; max-width: 400px; margin-left: auto; margin-right: auto; line-height: 1.6;">
                All orders are either completed or there are no orders requiring fulfillment at this time.
              </p>
              <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <div style="background: white; padding: 12px 20px; border-radius: 8px; border: 1px solid #e2e8f0; color: #475569; font-size: 0.9rem; font-weight: 500;">
                  üìä Check your orders dashboard
                </div>
                <div style="background: white; padding: 12px 20px; border-radius: 8px; border: 1px solid #e2e8f0; color: #475569; font-size: 0.9rem; font-weight: 500;">
                  üîÑ Refresh to see updates
                </div>
              </div>
            </div>
          `;
          return;
        }

        const table = `
          <div class="fulfillment-wrap">
            <table class="table fulfillment-table">
              <thead>
                <tr>
                  <th style="padding: 16px 12px; text-align: left;">Order ID</th>
                  <th style="padding: 16px 12px; text-align: left;">Customer</th>
                  <th style="padding: 16px 12px; text-align: left;">Amount</th>
                  <th style="padding: 16px 12px; text-align: left;">Payment</th>
                  <th style="padding: 16px 12px; text-align: left;">Fulfillment Status</th>
                  <th style="padding: 16px 12px; text-align: left;">Address</th>
                  <th style="padding: 16px 12px; text-align: left;">Date</th>
                  <th style="padding: 16px 12px; text-align: center;">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${orders.map(order => {
                  const actualStatus = getActualOrderStatus(order);
                  const isPaid = hasRazorpayPayment(order);
                  const fulfillmentStatus = order.fulfillmentStatus || 'yet-to-dispatch';
                  
                  // Get fulfillment status display
                  const getFulfillmentStatusDisplay = (status) => {
                    switch(status) {
                      case 'yet-to-dispatch': return { text: 'Yet to Dispatch', class: 'status-pending', icon: '‚è≥' };
                      case 'ready-to-dispatch': return { text: 'Ready to Dispatch', class: 'status-processing', icon: 'üì¶' };
                      case 'shipped': return { text: 'Shipped', class: 'status-processing', icon: 'üöö' };
                      case 'delivered': return { text: 'Delivered', class: 'status-completed', icon: '‚úÖ' };
                      case 'cancelled': return { text: 'Cancelled', class: 'status-cancelled', icon: '‚ùå' };
                      default: return { text: 'Yet to Dispatch', class: 'status-pending', icon: '‚è≥' };
                    }
                  };
                  
                  const fulfillment = getFulfillmentStatusDisplay(fulfillmentStatus);
                  
                  // Get customer name with better extraction logic
                  const getCustomerName = (order) => {
                    return order.customerName || 
                           order.customer?.firstName || 
                           order.customer?.name ||
                           order.customer_name ||
                           order.billingAddress?.name ||
                           order.shippingAddress?.name ||
                           'N/A';
                  };
                  
                  const customerName = getCustomerName(order);
                  
                  // Get action button based on status
                  const getActionButton = (status, orderId, customerName) => {
                    const buttonStyle = `
                      padding: 8px 16px; 
                      border-radius: 8px; 
                      font-size: 0.8rem; 
                      font-weight: 600; 
                      border: none; 
                      cursor: pointer; 
                      transition: all 0.2s ease; 
                      display: inline-flex; 
                      align-items: center; 
                      gap: 6px;
                      text-decoration: none;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    `;
                    
                    const warningButton = `background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; ${buttonStyle}`;
                    const primaryButton = `background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; ${buttonStyle}`;
                    const secondaryButton = `background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; ${buttonStyle}`;
                    const dangerButton = `background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; ${buttonStyle}`;
                    const successButton = `background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; ${buttonStyle}`;
                    
                    switch(status) {
                      case 'yet-to-dispatch':
                        return `<div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                                  <button style="${warningButton}" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(245, 158, 11, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'" onclick="updateFulfillmentStatus('${orderId}', 'ready-to-dispatch')">
                                    üì¶ Mark Ready to Dispatch
                      </button>
                                  <button style="${dangerButton}" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(239, 68, 68, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'" onclick="openCancelOrderModal('${orderId}', '${customerName}')">
                                    ‚ùå Cancel Order
                                  </button>
                                </div>`;
                      case 'ready-to-dispatch':
                        return `<div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                                  <button style="${primaryButton}" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(59, 130, 246, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'" onclick="openTrackingModal('${orderId}', '${customerName}')">
                                    üöö Ship Order
                                  </button>
                                  <button style="${dangerButton}" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(239, 68, 68, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'" onclick="openCancelOrderModal('${orderId}', '${customerName}')">
                                    ‚ùå Cancel Order
                                  </button>
                                </div>`;
                      case 'shipped':
                        return `<div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                                  <button style="${successButton}" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(16, 185, 129, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'" onclick="updateFulfillmentStatus('${orderId}', 'delivered')">
                                    ‚úÖ Mark Delivered
                                  </button>
                                  <button style="${secondaryButton}" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(107, 114, 128, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'" onclick="viewTrackingDetails('${orderId}')">
                                    üìã View Tracking
                                  </button>
                                  <button style="${dangerButton}" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(239, 68, 68, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'" onclick="openCancelOrderModal('${orderId}', '${customerName}')">
                                    ‚ùå Cancel Order
                                  </button>
                                </div>`;
                      case 'delivered':
                        return `<div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                                  <button style="${secondaryButton}" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(107, 114, 128, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'" onclick="viewTrackingDetails('${orderId}')">
                                    üìã View Tracking
                                  </button>
                                  <button style="${primaryButton}" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(59, 130, 246, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'" onclick="viewDeliveryDetails('${orderId}')">
                                    üìã View Delivery Details
                                  </button>
                                </div>`;
                      case 'cancelled':
                        return `<div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                                  <button style="${secondaryButton}" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(107, 114, 128, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'" onclick="viewCancellationDetails('${orderId}')">
                                    üìã View Cancellation
                                  </button>
                                  <button style="${successButton}" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(16, 185, 129, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'" onclick="processRefund('${orderId}')">
                                    üí∞ Process Refund
                                  </button>
                                </div>`;
                      default:
                        return `<div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                                  <button style="${warningButton}" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(245, 158, 11, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'" onclick="updateFulfillmentStatus('${orderId}', 'ready-to-dispatch')">
                                    üì¶ Mark Ready to Dispatch
                                  </button>
                                  <button style="${dangerButton}" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(239, 68, 68, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'" onclick="openCancelOrderModal('${orderId}', '${customerName}')">
                                    ‚ùå Cancel Order
                                  </button>
                                </div>`;
                    }
                  };
                  
        // Get address display
        const getAddressDisplay = (order) => {
          const shippingAddress = order.shippingAddress || order.address || order.shipping || {};
          const addressParts = [];
          
          if (shippingAddress.street || shippingAddress.addressLine1) {
            addressParts.push(shippingAddress.street || shippingAddress.addressLine1);
          }
          if (shippingAddress.city) {
            addressParts.push(shippingAddress.city);
          }
          if (shippingAddress.state) {
            addressParts.push(shippingAddress.state);
          }
          if (shippingAddress.pincode || shippingAddress.zipCode) {
            addressParts.push(shippingAddress.pincode || shippingAddress.zipCode);
          }
          
          // Get detailed address from notes section
          const notes = order.notes || {};
          const notesAddress = notes.address || '';
          const notesCity = notes.city || '';
          const notesState = notes.state || '';
          const notesPincode = notes.pincode || '';
          const notesCountry = notes.country || '';
          
          // Build detailed address from notes
          const notesAddressParts = [];
          if (notesAddress) notesAddressParts.push(notesAddress);
          if (notesCity) notesAddressParts.push(notesCity);
          if (notesState) notesAddressParts.push(notesState);
          if (notesPincode) notesAddressParts.push(notesPincode);
          if (notesCountry) notesAddressParts.push(notesCountry);
          
          const detailedAddress = notesAddressParts.length > 0 ? notesAddressParts.join(', ') : null;
          const fullAddress = detailedAddress || (addressParts.length > 0 ? addressParts.join(', ') : null);
          
          if (!fullAddress) {
            return { text: 'No Address', class: 'status-incomplete', icon: 'üìç' };
          }
          
          // Truncate for display but keep full address for tooltip
          const displayAddress = fullAddress.length > 30 ? fullAddress.substring(0, 30) + '...' : fullAddress;
          
          return { 
            text: displayAddress, 
            class: 'status-completed', 
            icon: 'üìç',
            fullAddress: fullAddress
          };
        };
                  
                  const addressDisplay = getAddressDisplay(order);
                  
                  return `
                  <tr>
                    <td style="padding: 16px 12px; font-family: monospace; font-weight: 600; color: #1f2937; background: #f9fafb;">
                      <strong>${order.orderCode || order.orderId || order.id || 'N/A'}</strong>
                    </td>
                    <td style="padding: 16px 12px; font-weight: 500; color: #374151;">
                      ${customerName}
                    </td>
                    <td class="amount-cell" style="padding: 16px 12px;">
                      ‚Çπ${(parseFloat((typeof order.amount === 'number' ? order.amount : (order.pricing?.total || 0))) || 0).toLocaleString()}
                    </td>
                    <td style="padding: 16px 12px; text-align: center;">
                      <span class="status-badge status-${isPaid ? 'completed' : 'incomplete'} paid-badge">
                        ${isPaid ? '‚úÖ PAID' : '‚ùå UNPAID'}
                      </span>
                    </td>
                    <td style="padding: 16px 12px; text-align: center;">
                      <span class="status-badge ${fulfillment.class} fulfillment-chip">
                        ${fulfillment.icon} ${fulfillment.text}
                      </span>
                    </td>
                    <td style="padding: 16px 12px; text-align: left;">
                      <span class="status-badge ${addressDisplay.class} fulfillment-chip" onclick="showOrderDetailsPopup('${order.id}')" title="Click to view detailed customer information" style="cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                        ${addressDisplay.icon} ${addressDisplay.text}
                      </span>
                    </td>
                    <td style="padding: 16px 12px; color: #6b7280; font-size: 0.9rem;">
                      ${order.createdAt.toLocaleDateString()}
                    </td>
                    <td style="padding: 16px 12px; text-align: center;">
                      ${getActionButton(fulfillmentStatus, order.id, customerName)}
                    </td>
                  </tr>
                `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        container.innerHTML = table;
      }

      updateAffiliates() {
        const container = document.getElementById('affiliates-content');
        const affiliates = this.data.affiliates || [];

        if (!container) return;
        if (affiliates.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ü§ù</div><p>No affiliates found</p></div>';
          return;
        }

        const table = `
          <div style="overflow-x:auto;">
            <table class="table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Code</th>
                  <th>Status</th>
                  <th>Joined</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${affiliates.map(a => `
                  <tr>
                    <td>${a.name}</td>
                    <td>${a.code || '‚Äî'}</td>
                    <td><span class="status-badge ${a.status === 'active' ? 'status-completed' : 'status-incomplete'}">${(a.status||'active').toUpperCase()}</span></td>
                    <td>${a.createdAt ? a.createdAt.toLocaleDateString() : '‚Äî'}</td>
                    <td>
                      <button class="card-action" onclick="openAffiliateModal('${a.id}')">View</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;

        container.innerHTML = table;
      }

      startAutoRefresh() {
        // Refresh data every 30 seconds
        setInterval(() => {
          if (this.isInitialized) {
            console.log('üîÑ Auto-refreshing dashboard data...');
            this.loadAllData();
          }
        }, 30000);
      }

      setupRealtimeListeners() {
        try {
          if (!window.AttralFirebase || !window.AttralFirebase.db) {
            console.warn('‚ö†Ô∏è Firebase not available for real-time listeners');
            return;
          }

          console.log('üîÑ Setting up real-time listeners...');

          // Listen for new orders
          window.AttralFirebase.db.collection('orders')
            .orderBy('createdAt', 'desc')
            .limit(10)
            .onSnapshot((snapshot) => {
              console.log('üì¶ Real-time update: orders changed');
              this.loadOrders().then(() => this.updateUI());
            }, (error) => {
              console.error('‚ùå Orders listener error:', error);
            });

          // Listen for new messages
          window.AttralFirebase.db.collection('contact_messages')
            .orderBy('createdAt', 'desc')
            .limit(5)
            .onSnapshot((snapshot) => {
              console.log('üí¨ Real-time update: messages changed');
              this.loadMessages().then(() => this.updateUI());
            }, (error) => {
              console.error('‚ùå Messages listener error:', error);
            });

          // Listen for new affiliates
          window.AttralFirebase.db.collection('affiliates')
            .orderBy('createdAt', 'desc')
            .limit(10)
            .onSnapshot((snapshot) => {
              console.log('ü§ù Real-time update: affiliates changed');
              this.loadAffiliates().then(() => this.updateUI());
            }, (error) => {
              console.error('‚ùå Affiliates listener error:', error);
            });

          console.log('‚úÖ Real-time listeners set up successfully');
        } catch (error) {
          console.error('‚ùå Failed to set up real-time listeners:', error);
        }
      }

      showError(message) {
        console.error('‚ùå Dashboard Error:', message);
      }
    }

    // Product Management Functions
    function openProductManager() {
      document.getElementById('productModal').style.display = 'flex';
    }

    function closeProductManager() {
      document.getElementById('productModal').style.display = 'none';
      document.getElementById('productForm').reset();
    }

    // Handle product form submission
    document.getElementById('productForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const productData = {
        title: formData.get('title'),
        price: parseFloat(formData.get('price')),
        description: formData.get('description'),
        category: formData.get('category'),
        image: formData.get('image') || '../assets/product_images/default.jpg',
        featured: false,
        createdAt: new Date()
      };

      try {
        console.log('üíæ Saving product to Firestore...');
        
        // Save to Firestore
        await window.AttralFirebase.db.collection('products').add(productData);
        
        // Also save to products.json for backward compatibility
        const response = await fetch('/api/save_product.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(productData)
        });

        if (response.ok) {
          alert('‚úÖ Product added successfully!');
          closeProductManager();
          
          // Refresh products list
          if (window.dashboardManager) {
            await window.dashboardManager.loadProducts();
            window.dashboardManager.updateProducts();
          }
        } else {
          throw new Error('Failed to save product');
        }
        
      } catch (error) {
        console.error('‚ùå Error saving product:', error);
        alert('‚ùå Error saving product. Please try again.');
      }
    });

    // Global functions for button clicks
    function refreshDashboard() {
      console.log('üîÑ Manual refresh triggered');
      if (window.dashboardManager) {
        window.dashboardManager.loadAllData();
      }
    }

    function refreshOrders() {
      console.log('üîÑ Refreshing orders... (Recent Orders section removed)');
      if (window.dashboardManager) {
        window.dashboardManager.loadOrders();
      }
    }

    function refreshProducts() {
      console.log('üîÑ Refreshing products... (Top Products section removed)');
      if (window.dashboardManager) {
        window.dashboardManager.loadProducts();
      }
    }

    function refreshMessages() {
      console.log('üîÑ Refreshing messages...');
      if (window.dashboardManager) {
        window.dashboardManager.loadMessages().then(() => {
          window.dashboardManager.updateMessages();
        });
      }
    }

    function refreshFulfillment() {
      console.log('üîÑ Refreshing fulfillment...');
      if (window.dashboardManager) {
        window.dashboardManager.loadFulfillment().then(() => {
          window.dashboardManager.updateFulfillment();
        });
      }
    }

    function refreshAffiliates() {
      console.log('üîÑ Refreshing affiliates...');
      if (window.dashboardManager) {
        window.dashboardManager.loadAffiliates().then(() => {
          window.dashboardManager.updateAffiliates();
        });
      }
    }

    function refreshChart() {
      console.log('üîÑ Refreshing chart...');
      // Chart refresh logic would go here
    }

    // Tracking Modal Functions
    function openTrackingModal(orderId, customerName) {
      document.getElementById('orderId').value = orderId;
      document.getElementById('customerName').value = customerName;
      document.getElementById('trackingModal').style.display = 'flex';
    }

    function closeTrackingModal() {
      document.getElementById('trackingModal').style.display = 'none';
      document.getElementById('trackingForm').reset();
    }

      // Handle tracking form submission
    document.getElementById('trackingForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const trackingData = {
        orderId: formData.get('orderId'),
        trackingId: formData.get('trackingId'),
        courierName: formData.get('courierName'),
        shippingNotes: formData.get('shippingNotes'),
        shippedAt: new Date(),
        status: 'shipped'
      };

      try {
        console.log('üì¶ Updating order with tracking info...');
        
        // Get current order data first
        const orderDoc = await window.AttralFirebase.db.collection('orders').doc(trackingData.orderId).get();
        if (!orderDoc.exists) {
          throw new Error('Order not found');
        }
        const orderData = orderDoc.data();
        
        // Update order in Firestore with fulfillment status
        await window.AttralFirebase.db.collection('orders').doc(trackingData.orderId).update({
          status: 'shipped',
          fulfillmentStatus: 'shipped',
          shipping: {
            tracking: {
              id: trackingData.trackingId,
              courierName: trackingData.courierName,
              shippedAt: trackingData.shippedAt,
              notes: trackingData.shippingNotes || null
            },
            // Preserve existing address fields if any; this shallow set may overwrite.
          },
          // Keep existing top-level fields for backward compatibility
          trackingId: trackingData.trackingId,
          courierName: trackingData.courierName,
          shippingNotes: trackingData.shippingNotes,
          shippedAt: trackingData.shippedAt,
          updatedAt: new Date()
        });

        // Send shipping notification email to customer
        await sendShippingEmailNotification(orderData, trackingData);

        alert('‚úÖ Order marked as shipped with tracking ID: ' + trackingData.trackingId + ' & customer notified');
        closeTrackingModal();
        
        // Refresh fulfillment list
        if (window.dashboardManager) {
          await window.dashboardManager.loadFulfillment();
          window.dashboardManager.updateFulfillment();
        }
        
      } catch (error) {
        console.error('‚ùå Error updating order:', error);
        alert('‚ùå Error updating order. Please try again.');
      }
    });

    // Update fulfillment status function
    async function updateFulfillmentStatus(orderId, newStatus) {
      try {
        console.log('üì¶ Updating fulfillment status:', orderId, 'to', newStatus);
        
        // Get current order data first
        const orderDoc = await window.AttralFirebase.db.collection('orders').doc(orderId).get();
        if (!orderDoc.exists) {
          throw new Error('Order not found');
        }
        
        const orderData = orderDoc.data();
        
        // Update order in Firestore
        const updateData = {
          fulfillmentStatus: newStatus,
          updatedAt: new Date()
        };
        
        // If marking as delivered, also set the deliveredAt timestamp
        if (newStatus === 'delivered') {
          updateData.deliveredAt = new Date();
        }
        
        await window.AttralFirebase.db.collection('orders').doc(orderId).update(updateData);

        // Send email notification to customer
        await sendFulfillmentEmailNotification(orderData, newStatus);

        // Show success message based on status
        let message = '';
        switch(newStatus) {
          case 'ready-to-dispatch':
            message = '‚úÖ Order marked as Ready to Dispatch & customer notified';
            break;
          case 'shipped':
            message = '‚úÖ Order marked as Shipped & customer notified';
            break;
          case 'delivered':
            message = '‚úÖ Order marked as Delivered & customer notified';
            break;
          default:
            message = '‚úÖ Fulfillment status updated & customer notified';
        }
        
        alert(message);
        
        // Refresh fulfillment list
        if (window.dashboardManager) {
          await window.dashboardManager.loadFulfillment();
          window.dashboardManager.updateFulfillment();
        }
        
      } catch (error) {
        console.error('‚ùå Error updating fulfillment status:', error);
        alert('‚ùå Error updating fulfillment status. Please try again.');
      }
    }

    // View tracking details function
    async function viewTrackingDetails(orderId) {
      try {
        console.log('üìã Viewing tracking details for order:', orderId);
        
        // Get order details from Firestore
        const orderDoc = await window.AttralFirebase.db.collection('orders').doc(orderId).get();
        
        if (!orderDoc.exists) {
          alert('‚ùå Order not found');
          return;
        }
        
        const orderData = orderDoc.data();
        
        // Create tracking details modal content
        const trackingDetails = `
          <div style="padding: 20px;">
            <h3 style="margin-bottom: 20px; color: var(--dark);">üìã Tracking Details</h3>
            
            <div style="display: grid; gap: 15px;">
              <div style="background: var(--light); padding: 15px; border-radius: 8px;">
                <strong>Order ID:</strong> ${orderId}
              </div>
              
              <div style="background: var(--light); padding: 15px; border-radius: 8px;">
                <strong>Tracking ID:</strong> ${orderData.trackingId || 'Not provided'}
              </div>
              
              <div style="background: var(--light); padding: 15px; border-radius: 8px;">
                <strong>Courier Service:</strong> ${orderData.courierName || 'Not specified'}
              </div>
              
              <div style="background: var(--light); padding: 15px; border-radius: 8px;">
                <strong>Shipped Date:</strong> ${orderData.shippedAt ? new Date(orderData.shippedAt.toDate ? orderData.shippedAt.toDate() : orderData.shippedAt).toLocaleString() : 'Not available'}
              </div>
              
              ${orderData.shippingNotes ? `
                <div style="background: var(--light); padding: 15px; border-radius: 8px;">
                  <strong>Shipping Notes:</strong><br>
                  ${orderData.shippingNotes}
                </div>
              ` : ''}
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
              <button class="btn-secondary" onclick="closeTrackingDetailsModal()">Close</button>
            </div>
          </div>
        `;
        
        // Show tracking details in a modal
        showTrackingDetailsModal(trackingDetails);
        
      } catch (error) {
        console.error('‚ùå Error fetching tracking details:', error);
        alert('‚ùå Error fetching tracking details. Please try again.');
      }
    }

    // Show tracking details modal
    function showTrackingDetailsModal(content) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
            <h2>üìã Tracking Details</h2>
            <span class="close" onclick="closeTrackingDetailsModal()">&times;</span>
          </div>
          <div class="modal-body">
            ${content}
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close modal when clicking outside
      modal.onclick = function(event) {
        if (event.target === modal) {
          closeTrackingDetailsModal();
        }
      };
    }

    // Close tracking details modal
    function closeTrackingDetailsModal() {
      const modal = document.querySelector('.modal');
      if (modal) {
        document.body.removeChild(modal);
      }
    }

    // Order Cancellation Functions
    async function openCancelOrderModal(orderId, customerName) {
      document.getElementById('cancelOrderId').value = orderId;
      
      // Try to get the actual customer name from Firestore if not provided
      let actualCustomerName = customerName;
      if (!customerName || customerName === 'N/A') {
        try {
          const orderDoc = await window.AttralFirebase.db.collection('orders').doc(orderId).get();
          if (orderDoc.exists) {
            const orderData = orderDoc.data();
            actualCustomerName = orderData.customerName || 
                                orderData.customer?.firstName || 
                                orderData.customer?.name ||
                                orderData.customer_name ||
                                orderData.billingAddress?.name ||
                                orderData.shippingAddress?.name ||
                                'Customer Name Not Available';
          }
        } catch (error) {
          console.error('Error fetching customer name:', error);
          actualCustomerName = 'Customer Name Not Available';
        }
      }
      
      document.getElementById('cancelCustomerName').value = actualCustomerName;
      document.getElementById('cancelOrderModal').style.display = 'flex';
    }

    function closeCancelOrderModal() {
      document.getElementById('cancelOrderModal').style.display = 'none';
      document.getElementById('cancelOrderForm').reset();
    }

    // Handle order cancellation form submission
    document.getElementById('cancelOrderForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const cancellationData = {
        orderId: formData.get('orderId'),
        reason: formData.get('reason'),
        notes: formData.get('notes'),
        refundAmount: parseFloat(formData.get('refundAmount')) || 0,
        notifyCustomer: formData.get('notifyCustomer') === 'on',
        cancelledAt: new Date(),
        cancelledBy: 'admin' // You can get this from auth context
      };

      try {
        console.log('‚ùå Cancelling order:', cancellationData.orderId);
        
        // Get current order data to calculate refund amount if not specified
        const orderDoc = await window.AttralFirebase.db.collection('orders').doc(cancellationData.orderId).get();
        const orderData = orderDoc.data();
        
        if (!orderData) {
          throw new Error('Order not found');
        }

        // Calculate refund amount if not specified
        if (!cancellationData.refundAmount) {
          cancellationData.refundAmount = orderData.amount || orderData.pricing?.total || 0;
        }

        // Update order in Firestore with cancellation details
        await window.AttralFirebase.db.collection('orders').doc(cancellationData.orderId).update({
          status: 'cancelled',
          fulfillmentStatus: 'cancelled',
          cancellationReason: cancellationData.reason,
          cancellationNotes: cancellationData.notes,
          refundAmount: cancellationData.refundAmount,
          refundStatus: 'pending',
          cancelledAt: cancellationData.cancelledAt,
          cancelledBy: cancellationData.cancelledBy,
          notifyCustomer: cancellationData.notifyCustomer,
          updatedAt: new Date()
        });

        alert(`‚úÖ Order ${cancellationData.orderId} has been cancelled successfully.\nRefund Amount: ‚Çπ${cancellationData.refundAmount.toLocaleString()}`);
        closeCancelOrderModal();
        
        // Refresh fulfillment list
        if (window.dashboardManager) {
          await window.dashboardManager.loadFulfillment();
          window.dashboardManager.updateFulfillment();
        }
        
      } catch (error) {
        console.error('‚ùå Error cancelling order:', error);
        alert('‚ùå Error cancelling order: ' + error.message);
      }
    });

    // Process refund function
    async function processRefund(orderId) {
      try {
        const confirmed = confirm(`Are you sure you want to process the refund for order ${orderId}?`);
        if (!confirmed) return;

        console.log('üí∞ Processing refund for order:', orderId);
        
        // Get order data
        const orderDoc = await window.AttralFirebase.db.collection('orders').doc(orderId).get();
        const orderData = orderDoc.data();
        
        if (!orderData) {
          throw new Error('Order not found');
        }

        // Update refund status
        await window.AttralFirebase.db.collection('orders').doc(orderId).update({
          refundStatus: 'processed',
          refundProcessedAt: new Date(),
          refundProcessedBy: 'admin',
          updatedAt: new Date()
        });

        alert(`‚úÖ Refund processed successfully for order ${orderId}.\nAmount: ‚Çπ${(orderData.refundAmount || orderData.amount || 0).toLocaleString()}`);
        
        // Refresh fulfillment list
        if (window.dashboardManager) {
          await window.dashboardManager.loadFulfillment();
          window.dashboardManager.updateFulfillment();
        }
        
      } catch (error) {
        console.error('‚ùå Error processing refund:', error);
        alert('‚ùå Error processing refund: ' + error.message);
      }
    }

    // View cancellation details function
    async function viewCancellationDetails(orderId) {
      try {
        console.log('üìã Viewing cancellation details for order:', orderId);
        
        // Get order details from Firestore
        const orderDoc = await window.AttralFirebase.db.collection('orders').doc(orderId).get();
        
        if (!orderDoc.exists) {
          alert('‚ùå Order not found');
          return;
        }
        
        const orderData = orderDoc.data();
        
        // Create cancellation details modal content
        const cancellationDetails = `
          <div style="padding: 32px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);">
            <div style="text-align: center; margin-bottom: 32px;">
              <div style="font-size: 3rem; margin-bottom: 16px;">üìã</div>
              <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem; font-weight: 700;">Cancellation Details</h3>
              <p style="margin: 8px 0 0 0; color: #6b7280; font-size: 0.9rem;">Complete information about this order cancellation</p>
            </div>
            
            <div style="display: grid; gap: 20px;">
              <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #6b7280;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <span style="font-size: 1.2rem;">üÜî</span>
                  <strong style="color: #374151; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Order ID</strong>
                </div>
                <div style="font-family: monospace; font-weight: 600; color: #1f2937; font-size: 1.1rem;">${orderId}</div>
              </div>
              
              <div style="background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #ef4444;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <span style="font-size: 1.2rem;">‚ùå</span>
                  <strong style="color: #991b1b; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Cancellation Reason</strong>
                </div>
                <div style="font-weight: 600; color: #7f1d1d; font-size: 1rem;">${orderData.cancellationReason || 'Not specified'}</div>
              </div>
              
              <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #0ea5e9;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <span style="font-size: 1.2rem;">üìÖ</span>
                  <strong style="color: #0c4a6e; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Cancelled Date</strong>
                </div>
                <div style="font-weight: 600; color: #0c4a6e; font-size: 1rem;">${orderData.cancelledAt ? new Date(orderData.cancelledAt.toDate ? orderData.cancelledAt.toDate() : orderData.cancelledAt).toLocaleString() : 'Not available'}</div>
              </div>
              
              <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #22c55e;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <span style="font-size: 1.2rem;">üí∞</span>
                  <strong style="color: #166534; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Refund Amount</strong>
                </div>
                <div style="font-weight: 700; color: #166534; font-size: 1.2rem;">‚Çπ${(orderData.refundAmount || orderData.amount || 0).toLocaleString()}</div>
              </div>
              
              <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #f59e0b;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <span style="font-size: 1.2rem;">‚è≥</span>
                  <strong style="color: #92400e; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Refund Status</strong>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span class="status-badge ${orderData.refundStatus === 'processed' ? 'status-completed' : 'status-pending'}" style="font-size: 0.8rem; padding: 6px 12px;">
                    ${(orderData.refundStatus || 'pending').toUpperCase()}
                  </span>
                </div>
              </div>
              
              ${orderData.cancellationNotes ? `
                <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #6b7280;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <span style="font-size: 1.2rem;">üìù</span>
                    <strong style="color: #374151; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Cancellation Notes</strong>
                  </div>
                  <div style="color: #1f2937; font-size: 1rem; line-height: 1.5; background: white; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db;">${orderData.cancellationNotes}</div>
                </div>
              ` : ''}
              
              ${orderData.refundProcessedAt ? `
                <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #10b981;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <span style="font-size: 1.2rem;">‚úÖ</span>
                    <strong style="color: #065f46; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Refund Processed Date</strong>
                  </div>
                  <div style="font-weight: 600; color: #065f46; font-size: 1rem;">${new Date(orderData.refundProcessedAt.toDate ? orderData.refundProcessedAt.toDate() : orderData.refundProcessedAt).toLocaleString()}</div>
                </div>
              ` : ''}
            </div>
            
            <div style="margin-top: 32px; text-align: center;">
              <button onclick="closeCancellationDetailsModal()" style="padding: 12px 32px; border-radius: 8px; font-weight: 600; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); border: none; color: white; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(107, 114, 128, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(107, 114, 128, 0.3)'">
                Close Details
              </button>
            </div>
          </div>
        `;
        
        // Show cancellation details in a modal
        showCancellationDetailsModal(cancellationDetails);
        
      } catch (error) {
        console.error('‚ùå Error fetching cancellation details:', error);
        alert('‚ùå Error fetching cancellation details. Please try again.');
      }
    }

    // Show cancellation details modal
    function showCancellationDetailsModal(content) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); overflow: hidden;">
          <div class="modal-header" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; padding: 24px; border-bottom: none;">
            <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 1.8rem;">üìã</span>
              Cancellation Details
            </h2>
            <span class="close" onclick="closeCancellationDetailsModal()" style="color: white; font-size: 2rem; font-weight: 300; opacity: 0.8; transition: opacity 0.2s;">&times;</span>
          </div>
          <div class="modal-body" style="padding: 0; max-height: 80vh; overflow-y: auto;">
            ${content}
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close modal when clicking outside
      modal.onclick = function(event) {
        if (event.target === modal) {
          closeCancellationDetailsModal();
        }
      };
    }

    // Close cancellation details modal
    function closeCancellationDetailsModal() {
      const modal = document.querySelector('.modal');
      if (modal) {
        document.body.removeChild(modal);
      }
    }

    // View delivery details function
    async function viewDeliveryDetails(orderId) {
      try {
        console.log('üìã Viewing delivery details for order:', orderId);
        
        // Get order details from Firestore
        const orderDoc = await window.AttralFirebase.db.collection('orders').doc(orderId).get();
        
        if (!orderDoc.exists) {
          alert('‚ùå Order not found');
          return;
        }
        
        const orderData = orderDoc.data();
        
        // Create delivery details modal content
        const deliveryDetails = `
          <div style="padding: 32px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);">
            <div style="text-align: center; margin-bottom: 32px;">
              <div style="font-size: 3rem; margin-bottom: 16px;">‚úÖ</div>
              <h3 style="margin: 0; color: #1f2937; font-size: 1.5rem; font-weight: 700;">Delivery Details</h3>
              <p style="margin: 8px 0 0 0; color: #6b7280; font-size: 0.9rem;">Complete delivery information for this order</p>
            </div>
            
            <div style="display: grid; gap: 20px;">
              <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #6b7280;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <span style="font-size: 1.2rem;">üÜî</span>
                  <strong style="color: #374151; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Order ID</strong>
                </div>
                <div style="font-family: monospace; font-weight: 600; color: #1f2937; font-size: 1.1rem;">${orderId}</div>
              </div>
              
              <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #10b981;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <span style="font-size: 1.2rem;">‚úÖ</span>
                  <strong style="color: #065f46; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Delivery Status</strong>
                </div>
                <div style="font-weight: 700; color: #065f46; font-size: 1.2rem;">DELIVERED</div>
              </div>
              
              <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #0ea5e9;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <span style="font-size: 1.2rem;">üìÖ</span>
                  <strong style="color: #0c4a6e; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Delivered Date</strong>
                </div>
                <div style="font-weight: 600; color: #0c4a6e; font-size: 1rem;">${orderData.deliveredAt ? new Date(orderData.deliveredAt.toDate ? orderData.deliveredAt.toDate() : orderData.deliveredAt).toLocaleString() : 'Not available'}</div>
              </div>
              
              <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #6b7280;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <span style="font-size: 1.2rem;">üì¶</span>
                  <strong style="color: #374151; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Tracking ID</strong>
                </div>
                <div style="font-family: monospace; font-weight: 600; color: #1f2937; font-size: 1rem;">${orderData.trackingId || 'Not provided'}</div>
              </div>
              
              <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #6b7280;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <span style="font-size: 1.2rem;">üöö</span>
                  <strong style="color: #374151; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Courier Service</strong>
                </div>
                <div style="font-weight: 600; color: #1f2937; font-size: 1rem;">${orderData.courierName || 'Not specified'}</div>
              </div>
              
              <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #6b7280;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <span style="font-size: 1.2rem;">üìç</span>
                  <strong style="color: #374151; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Delivery Address</strong>
                </div>
                <div style="color: #1f2937; font-size: 1rem; line-height: 1.5; background: white; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db;">
                  ${orderData.shippingAddress ? 
                    `${orderData.shippingAddress.name || ''}<br>
                     ${orderData.shippingAddress.line1 || ''}<br>
                     ${orderData.shippingAddress.line2 || ''}<br>
                     ${orderData.shippingAddress.city || ''}, ${orderData.shippingAddress.state || ''}<br>
                     ${orderData.shippingAddress.postalCode || ''}<br>
                     ${orderData.shippingAddress.country || ''}` : 
                    'Address not available'
                  }
                </div>
              </div>
              
              ${orderData.deliveryNotes ? `
                <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #6b7280;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <span style="font-size: 1.2rem;">üìù</span>
                    <strong style="color: #374151; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Delivery Notes</strong>
                  </div>
                  <div style="color: #1f2937; font-size: 1rem; line-height: 1.5; background: white; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db;">${orderData.deliveryNotes}</div>
                </div>
              ` : ''}
              
              ${orderData.shippingNotes ? `
                <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #6b7280;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <span style="font-size: 1.2rem;">üìù</span>
                    <strong style="color: #374151; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">Shipping Notes</strong>
                  </div>
                  <div style="color: #1f2937; font-size: 1rem; line-height: 1.5; background: white; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db;">${orderData.shippingNotes}</div>
                </div>
              ` : ''}
            </div>
            
            <div style="margin-top: 32px; text-align: center;">
              <button onclick="closeDeliveryDetailsModal()" style="padding: 12px 32px; border-radius: 8px; font-weight: 600; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); border: none; color: white; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(107, 114, 128, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(107, 114, 128, 0.3)'">
                Close Details
              </button>
            </div>
          </div>
        `;
        
        // Show delivery details in a modal
        showDeliveryDetailsModal(deliveryDetails);
        
      } catch (error) {
        console.error('‚ùå Error fetching delivery details:', error);
        alert('‚ùå Error fetching delivery details. Please try again.');
      }
    }

    // Show delivery details modal
    function showDeliveryDetailsModal(content) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); overflow: hidden;">
          <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 24px; border-bottom: none;">
            <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 1.8rem;">‚úÖ</span>
              Delivery Details
            </h2>
            <span class="close" onclick="closeDeliveryDetailsModal()" style="color: white; font-size: 2rem; font-weight: 300; opacity: 0.8; transition: opacity 0.2s;">&times;</span>
          </div>
          <div class="modal-body" style="padding: 0; max-height: 80vh; overflow-y: auto;">
            ${content}
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close modal when clicking outside
      modal.onclick = function(event) {
        if (event.target === modal) {
          closeDeliveryDetailsModal();
        }
      };
    }

    // Close delivery details modal
    function closeDeliveryDetailsModal() {
      const modal = document.querySelector('.modal');
      if (modal) {
        document.body.removeChild(modal);
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const productModal = document.getElementById('productModal');
      const trackingModal = document.getElementById('trackingModal');
      const cancelOrderModal = document.getElementById('cancelOrderModal');
      const affiliateModal = document.getElementById('affiliateModal');
      const orderDetailsModal = document.getElementById('orderDetailsModal');
      
      if (event.target === productModal) {
        closeProductManager();
      }
      if (event.target === trackingModal) {
        closeTrackingModal();
      }
      if (event.target === cancelOrderModal) {
        closeCancelOrderModal();
      }
      if (event.target === affiliateModal) {
        closeAffiliateModal();
      }
      if (event.target === orderDetailsModal) {
        closeOrderDetailsModal();
      }
    }

    // Initialize dashboard when page loads
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Starting Dashboard with Firestore...');
      window.dashboardManager = new DashboardManager();
      
      // Add global debug function
      window.debugDashboard = () => {
        console.log('üîç Dashboard Debug Info:');
        console.log('Firebase:', window.AttralFirebase);
        console.log('Dashboard Manager:', window.dashboardManager);
        console.log('Dashboard Data:', window.dashboardManager?.data);
        console.log('Is Initialized:', window.dashboardManager?.isInitialized);
        
        // Test Firestore connection
        if (window.AttralFirebase?.db) {
          window.AttralFirebase.db.collection('orders').limit(1).get()
            .then(snapshot => {
              console.log('‚úÖ Firestore test successful:', snapshot.size, 'documents');
            })
            .catch(error => {
              console.error('‚ùå Firestore test failed:', error);
            });
        } else {
          console.error('‚ùå Firebase not available');
        }
      };
      
      // Add manual refresh function
      window.refreshDashboard = () => {
        if (window.dashboardManager) {
          console.log('üîÑ Manual dashboard refresh...');
          window.dashboardManager.loadAllData();
        }
      };
      
      // Add immediate data loading function to fix stats
      window.loadDashboardStats = async () => {
        console.log('üìä Loading dashboard stats immediately...');
        try {
          if (window.dashboardManager && window.dashboardManager.isInitialized) {
            await window.dashboardManager.loadOrders();
            console.log('‚úÖ Stats updated successfully');
          } else {
            console.log('‚ö†Ô∏è Dashboard not initialized yet, trying to load orders directly...');
            // Try to load orders directly if dashboard manager isn't ready
            if (window.AttralFirebase && window.AttralFirebase.db) {
              await loadOrdersDirect();
            }
          }
        } catch (error) {
          console.error('‚ùå Error loading dashboard stats:', error);
          // Load demo data as fallback
          loadDemoStats();
        }
      };
      
      // Direct order loading function
      window.loadOrdersDirect = async () => {
        try {
          console.log('üì¶ Loading orders directly...');
          const ordersSnapshot = await window.AttralFirebase.db
            .collection('orders')
            .orderBy('createdAt', 'desc')
            .limit(500)
            .get();

          const allOrders = [];
          ordersSnapshot.forEach(doc => {
            const orderData = doc.data();
            allOrders.push({
              id: doc.id,
              ...orderData,
              createdAt: orderData.createdAt ? orderData.createdAt.toDate() : new Date()
            });
          });

          // Calculate stats
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          
          const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
          const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 1);

          const getActualOrderStatus = (order) => {
            if (order.fulfillmentStatus) return order.fulfillmentStatus;
            if (order.status) return order.status;
            return 'pending';
          };

          const getOrderTotal = (order) => {
            if (typeof order.totalAmount === 'number') return order.totalAmount;
            if (typeof order.amount === 'number') return order.amount;
            if (order.pricing && typeof order.pricing.total === 'number') return order.pricing.total;
            return 0;
          };

          const todayOrders = allOrders.filter(order => 
            order.createdAt >= today && order.createdAt < tomorrow
          );
          
          const monthOrders = allOrders.filter(order => 
            order.createdAt >= monthStart && order.createdAt < monthEnd
          );
          
          const pendingToday = todayOrders.filter(order => {
            const actualStatus = getActualOrderStatus(order);
            return (actualStatus === 'pending' || actualStatus === 'processing');
          }).length;
          
          const shippedThisMonth = monthOrders.filter(order => {
            const actualStatus = getActualOrderStatus(order);
            return (actualStatus === 'shipped' || actualStatus === 'delivered');
          }).length;
          
          const revenueToday = todayOrders.reduce((sum, order) => {
            const actualStatus = getActualOrderStatus(order);
            return sum + (actualStatus !== 'incomplete' ? (parseFloat(getOrderTotal(order)) || 0) : 0);
          }, 0);
          
          const revenueThisMonth = monthOrders.reduce((sum, order) => {
            const actualStatus = getActualOrderStatus(order);
            return sum + (actualStatus !== 'incomplete' ? (parseFloat(getOrderTotal(order)) || 0) : 0);
          }, 0);

          // Update stats
          document.getElementById('pending-orders-today').textContent = pendingToday;
          document.getElementById('shipped-orders-month').textContent = shippedThisMonth;
          document.getElementById('revenue-today').textContent = `‚Çπ${revenueToday.toLocaleString()}`;
          document.getElementById('revenue-month').textContent = `‚Çπ${revenueThisMonth.toLocaleString()}`;
          
          // Update status indicator
          const statusElement = document.getElementById('statsStatus');
          if (statusElement) {
            statusElement.textContent = 'Updated';
            statusElement.style.color = '#10b981';
            setTimeout(() => {
              statusElement.textContent = 'Live';
              statusElement.style.color = '#10b981';
            }, 2000);
          }

          console.log('‚úÖ Direct order loading successful');
          console.log('üìä Stats - Pending today:', pendingToday, 'Shipped this month:', shippedThisMonth);
          console.log('üí∞ Revenue - Today:', revenueToday, 'This month:', revenueThisMonth);

        } catch (error) {
          console.error('‚ùå Error in direct order loading:', error);
          loadDemoStats();
        }
      };
      
      // Demo stats fallback
      window.loadDemoStats = () => {
        console.log('üìä Loading demo stats as fallback...');
        document.getElementById('pending-orders-today').textContent = '5';
        document.getElementById('shipped-orders-month').textContent = '23';
        document.getElementById('revenue-today').textContent = '‚Çπ12,450';
        document.getElementById('revenue-month').textContent = '‚Çπ1,25,800';
        document.getElementById('total-affiliates').textContent = '4';
        
        // Update status indicator
        const statusElement = document.getElementById('statsStatus');
        if (statusElement) {
          statusElement.textContent = 'Demo Data';
          statusElement.style.color = '#f59e0b';
        }
      };
      
      // Try to load stats immediately after a short delay
      setTimeout(() => {
        window.loadDashboardStats();
      }, 2000);
      
      console.log('üí° Debug functions available: debugDashboard(), refreshDashboard(), loadDashboardStats()');
    });

    // Order details modal logic
    async function showOrderDetailsPopup(orderId) {
      const modal = document.getElementById('orderDetailsModal');
      const body = document.getElementById('order-details-modal-body');
      modal.style.display = 'flex';
      body.innerHTML = '<div class="loading"><div class="loading-spinner"></div><span>Loading order details...</span></div>';

      try {
        // Get order details from Firestore
        const orderDoc = await window.AttralFirebase.db.collection('orders').doc(orderId).get();
        
        if (!orderDoc.exists) {
          throw new Error('Order not found');
        }
        
        const orderData = orderDoc.data();
        const shippingAddress = orderData.shippingAddress || orderData.address || orderData.shipping || {};
        const customer = orderData.customer || {};
        
        // Format address
        const addressParts = [];
        if (shippingAddress.street || shippingAddress.addressLine1) {
          addressParts.push(shippingAddress.street || shippingAddress.addressLine1);
        }
        if (shippingAddress.city) {
          addressParts.push(shippingAddress.city);
        }
        if (shippingAddress.state) {
          addressParts.push(shippingAddress.state);
        }
        if (shippingAddress.pincode || shippingAddress.zipCode) {
          addressParts.push(shippingAddress.pincode || shippingAddress.zipCode);
        }
        const fullAddress = addressParts.length > 0 ? addressParts.join(', ') : 'No address available';
        
        // Get detailed address from notes section
        const notes = orderData.notes || {};
        const notesAddress = notes.address || '';
        const notesCity = notes.city || '';
        const notesState = notes.state || '';
        const notesPincode = notes.pincode || '';
        const notesCountry = notes.country || '';
        
        // Build detailed address from notes
        const notesAddressParts = [];
        if (notesAddress) notesAddressParts.push(notesAddress);
        if (notesCity) notesAddressParts.push(notesCity);
        if (notesState) notesAddressParts.push(notesState);
        if (notesPincode) notesAddressParts.push(notesPincode);
        if (notesCountry) notesAddressParts.push(notesCountry);
        
        const detailedAddress = notesAddressParts.length > 0 ? notesAddressParts.join(', ') : fullAddress;
        
        // Format customer details (prioritize notes section)
        const customerName = notes.firstName ? 
          `${notes.firstName} ${notes.lastName || ''}`.trim() : 
          (customer.name || customer.firstName || orderData.customerName || 'Unknown');
        const customerEmail = notes.email || customer.email || orderData.customerEmail || 'No email';
        const customerPhone = notes.phone || customer.phone || customer.mobile || orderData.customerPhone || 'No phone';
        
        // Format dates
        const orderDate = orderData.createdAt ? orderData.createdAt.toDate().toLocaleDateString('en-IN') : 'Unknown';
        const orderTime = orderData.createdAt ? orderData.createdAt.toDate().toLocaleTimeString('en-IN') : 'Unknown';
        
        // Format amount
        const orderAmount = orderData.totalAmount || orderData.amount || orderData.pricing?.total || 0;
        
        // Display order details
        body.innerHTML = `
          <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 24px; border-radius: 16px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <span style="font-size: 1.5rem;">üìã</span>
              <h3 style="margin: 0; color: #1f2937; font-size: 1.3rem;">Order Information</h3>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">Order ID</div>
                <div style="font-family: monospace; font-weight: 700; color: #1f2937;">${orderData.orderCode || orderId}</div>
              </div>
              <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid #10b981;">
                <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">Order Amount</div>
                <div style="font-weight: 700; color: #059669; font-size: 1.2rem;">‚Çπ${orderAmount.toLocaleString()}</div>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">Order Date</div>
                <div style="color: #1f2937;">${orderDate}</div>
              </div>
              <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">Order Time</div>
                <div style="color: #1f2937;">${orderTime}</div>
              </div>
            </div>
          </div>
          
          <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 24px; border-radius: 16px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <span style="font-size: 1.5rem;">üë§</span>
              <h3 style="margin: 0; color: #92400e; font-size: 1.3rem;">Customer Information</h3>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">Customer Name</div>
                <div style="color: #1f2937; font-weight: 500;">${customerName}</div>
              </div>
              <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">Email Address</div>
                <div style="color: #1f2937; font-weight: 500; word-break: break-all;">${customerEmail}</div>
              </div>
            </div>
            
            <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid #10b981; margin-top: 16px;">
              <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">Contact Number</div>
              <div style="color: #1f2937; font-weight: 500;">${customerPhone}</div>
            </div>
          </div>
          
          <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 24px; border-radius: 16px;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <span style="font-size: 1.5rem;">üìç</span>
              <h3 style="margin: 0; color: #1e40af; font-size: 1.3rem;">Shipping Address</h3>
            </div>
            
            <div style="background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6;">
              <div style="color: #1f2937; line-height: 1.6; font-size: 1rem;">${detailedAddress}</div>
            </div>
          </div>
        `;
        
      } catch (error) {
        console.error('Error loading order details:', error);
        body.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #dc2626;">
            <div style="font-size: 2rem; margin-bottom: 16px;">‚ùå</div>
            <h3 style="margin: 0 0 8px 0; color: #dc2626;">Error Loading Order Details</h3>
            <p style="margin: 0; color: #6b7280;">${error.message}</p>
          </div>
        `;
      }
    }
    
    function closeOrderDetailsModal() {
      document.getElementById('orderDetailsModal').style.display = 'none';
    }

    // Affiliate detail modal logic
    async function openAffiliateModal(affiliateId) {
      const modal = document.getElementById('affiliateModal');
      const body = document.getElementById('affiliate-modal-body');
      modal.style.display = 'flex';
      body.innerHTML = '<div class="loading"><div class="loading-spinner"></div><span>Loading affiliate details...</span></div>';

      try {
        const dm = window.dashboardManager;
        const affiliate = (dm?.data?.affiliates || []).find(a => a.id === affiliateId);
        if (!affiliate) throw new Error('Affiliate not found');

        // Compute orders count via two queries (supports both schemas: affiliate.code and ref)
        const db = window.AttralFirebase.db;
        let totalOrders = 0;
        let totalAmount = 0;

        const [byEmbedSnap, byFlatSnap, affiliateDoc] = await Promise.all([
          affiliate.code ? db.collection('orders').where('affiliate.code', '==', affiliate.code).get() : Promise.resolve({ empty: true, forEach: () => {} }),
          affiliate.code ? db.collection('orders').where('ref', '==', affiliate.code).get() : Promise.resolve({ empty: true, forEach: () => {} }),
          db.collection('affiliates').doc(affiliateId).get()
        ]);

        const accumulate = (snap) => {
          if (!snap || snap.empty) return;
          snap.forEach(doc => {
            const o = doc.data();
            const amount = typeof o.amount === 'number' ? o.amount : (o.pricing?.total || 0);
            totalOrders += 1;
            totalAmount += Number(amount || 0);
          });
        };
        accumulate(byEmbedSnap);
        accumulate(byFlatSnap);

        // Get payment details from affiliate document
        const affiliateData = affiliateDoc.exists ? affiliateDoc.data() : {};
        const paymentDetails = affiliateData.paymentDetails || {};
        const payoutSettings = {
          payoutThreshold: affiliateData.payoutThreshold || 1000,
          payoutFrequency: affiliateData.payoutFrequency || 'monthly',
          currency: affiliateData.currency || 'INR',
          commissionRate: affiliateData.commissionRate || 0.1
        };

        const html = `
          <div style="display:flex; flex-direction:column; gap:16px;">
            <div>
              <div style="font-weight:800; font-size:1.1rem; color: var(--dark);">${affiliate.name}</div>
              <div style="color:#6b7280; font-size:0.9rem;">${affiliate.email || ''}</div>
            </div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px;">
              <div style="background:var(--light); padding:12px; border-radius:8px; border:1px solid var(--border);">
                <div style="font-size:12px; color:#6b7280; text-transform:uppercase; font-weight:600;">Affiliate Code</div>
                <div style="font-weight:700;">${affiliate.code || '‚Äî'}</div>
              </div>
              <div style="background:var(--light); padding:12px; border-radius:8px; border:1px solid var(--border);">
                <div style="font-size:12px; color:#6b7280; text-transform:uppercase; font-weight:600;">Orders from Link</div>
                <div style="font-weight:800; color: var(--primary);">${totalOrders}</div>
              </div>
              <div style="background:var(--light); padding:12px; border-radius:8px; border:1px solid var(--border);">
                <div style="font-size:12px; color:#6b7280; text-transform:uppercase; font-weight:600;">Total Order Value</div>
                <div style="font-weight:800; color: var(--primary);">‚Çπ${totalAmount.toLocaleString()}</div>
              </div>
            </div>
            <div>
              <div style="font-size:12px; color:#6b7280; text-transform:uppercase; font-weight:600; margin-bottom:6px;">Affiliate Link</div>
              <div style="display:flex; gap:8px; align-items:center;">
                <input type="text" value="${affiliate.link || ''}" readonly style="flex:1; padding:8px; border:2px solid var(--border); border-radius:8px;" />
                <button class="btn-primary" onclick="navigator.clipboard.writeText('${(affiliate.link||'').replace(/'/g, "\\'")}')">Copy</button>
              </div>
            </div>
            
            <!-- Payment Details Section -->
            <div style="border-top: 2px solid var(--border); padding-top: 16px;">
              <div style="font-size:14px; font-weight:700; color: var(--dark); margin-bottom:12px; display:flex; align-items:center; gap:8px;">
                üí≥ Payment Details
                ${paymentDetails.bankAccountName ? '<span style="background: var(--success); color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600;">CONFIGURED</span>' : '<span style="background: var(--warning); color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600;">NOT SET</span>'}
              </div>
              
              ${paymentDetails.bankAccountName ? `
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:12px;">
                  <div style="background:var(--light); padding:12px; border-radius:8px; border:1px solid var(--border);">
                    <div style="font-size:11px; color:#6b7280; text-transform:uppercase; font-weight:600; margin-bottom:4px;">Bank Account</div>
                    <div style="font-weight:600; color: var(--dark);">${paymentDetails.bankAccountName || '‚Äî'}</div>
                    <div style="font-size:12px; color:#6b7280; margin-top:2px;">${paymentDetails.bankAccountNumber || '‚Äî'}</div>
                  </div>
                  <div style="background:var(--light); padding:12px; border-radius:8px; border:1px solid var(--border);">
                    <div style="font-size:11px; color:#6b7280; text-transform:uppercase; font-weight:600; margin-bottom:4px;">IFSC Code</div>
                    <div style="font-weight:600; color: var(--dark); font-family: monospace;">${paymentDetails.ifsc || '‚Äî'}</div>
                  </div>
                  <div style="background:var(--light); padding:12px; border-radius:8px; border:1px solid var(--border);">
                    <div style="font-size:11px; color:#6b7280; text-transform:uppercase; font-weight:600; margin-bottom:4px;">UPI ID</div>
                    <div style="font-weight:600; color: var(--dark);">${paymentDetails.upiId || '‚Äî'}</div>
                    <div style="font-size:12px; color:#6b7280; margin-top:2px;">${paymentDetails.upiMobile || '‚Äî'}</div>
                  </div>
                </div>
                <div style="margin-top:8px; font-size:11px; color:#6b7280;">
                  Last updated: ${paymentDetails.updatedAt ? new Date(paymentDetails.updatedAt.toDate ? paymentDetails.updatedAt.toDate() : paymentDetails.updatedAt).toLocaleDateString() : 'Unknown'}
                </div>
              ` : `
                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; text-align: center;">
                  <div style="color: #92400e; font-weight: 600; margin-bottom: 4px;">‚ö†Ô∏è Payment Details Not Configured</div>
                  <div style="color: #92400e; font-size: 12px;">This affiliate hasn't set up their payment details yet.</div>
                </div>
              `}
            </div>
            
            <!-- Payout Settings Section -->
            <div style="border-top: 2px solid var(--border); padding-top: 16px;">
              <div style="font-size:14px; font-weight:700; color: var(--dark); margin-bottom:12px; display:flex; align-items:center; gap:8px;">
                üí∞ Payout Settings
              </div>
              
              <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:12px;">
                <div style="background:var(--light); padding:12px; border-radius:8px; border:1px solid var(--border);">
                  <div style="font-size:11px; color:#6b7280; text-transform:uppercase; font-weight:600; margin-bottom:4px;">Commission Rate</div>
                  <div style="font-weight:700; color: var(--primary);">${(payoutSettings.commissionRate * 100).toFixed(1)}%</div>
                </div>
                <div style="background:var(--light); padding:12px; border-radius:8px; border:1px solid var(--border);">
                  <div style="font-size:11px; color:#6b7280; text-transform:uppercase; font-weight:600; margin-bottom:4px;">Payout Threshold</div>
                  <div style="font-weight:700; color: var(--dark);">‚Çπ${payoutSettings.payoutThreshold.toLocaleString()}</div>
                </div>
                <div style="background:var(--light); padding:12px; border-radius:8px; border:1px solid var(--border);">
                  <div style="font-size:11px; color:#6b7280; text-transform:uppercase; font-weight:600; margin-bottom:4px;">Payout Frequency</div>
                  <div style="font-weight:700; color: var(--dark); text-transform:capitalize;">${payoutSettings.payoutFrequency}</div>
                </div>
                <div style="background:var(--light); padding:12px; border-radius:8px; border:1px solid var(--border);">
                  <div style="font-size:11px; color:#6b7280; text-transform:uppercase; font-weight:600; margin-bottom:4px;">Currency</div>
                  <div style="font-weight:700; color: var(--dark);">${payoutSettings.currency}</div>
                </div>
              </div>
              
              <div style="margin-top:12px; padding:12px; background: #e0f2fe; border: 1px solid #0288d1; border-radius: 8px;">
                <div style="font-size:12px; color: #01579b; font-weight: 600; margin-bottom:4px;">üí° Commission Calculation</div>
                <div style="font-size:11px; color: #01579b;">
                  Total Order Value: ‚Çπ${totalAmount.toLocaleString()} √ó ${(payoutSettings.commissionRate * 100).toFixed(1)}% = 
                  <strong>‚Çπ${(totalAmount * payoutSettings.commissionRate).toLocaleString()} commission</strong>
                </div>
              </div>
            </div>
            
            <div style="display:flex; justify-content:flex-end; gap:8px;">
              <a class="card-action" href="affiliate-dashboard.html" target="_blank">Open Affiliate Dashboard</a>
              <button class="btn-secondary" onclick="closeAffiliateModal()">Close</button>
            </div>
          </div>
        `;

        body.innerHTML = html;
      } catch (e) {
        console.error(e);
        body.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Failed to load affiliate details</p></div>';
      }
    }

    function closeAffiliateModal() {
      document.getElementById('affiliateModal').style.display = 'none';
    }

    // Email Notification Functions
    async function sendFulfillmentEmailNotification(orderData, newStatus) {
      try {
        console.log('üìß Sending fulfillment email notification for status:', newStatus);
        
        // Get customer email
        const customerEmail = orderData.customer?.email || orderData.customer_email || orderData.email;
        if (!customerEmail) {
          console.warn('‚ö†Ô∏è No customer email found for order:', orderData.id || orderData.orderId);
          return;
        }

        // Get customer name
        const customerName = orderData.customer?.firstName || 
                           orderData.customer?.name || 
                           orderData.customer_name || 
                           orderData.customerName || 
                           'Valued Customer';

        // Prepare email data based on status
        const emailData = {
          to: customerEmail,
          subject: getFulfillmentSubject(newStatus),
          message: getFulfillmentMessage(orderData, newStatus, customerName),
          orderId: orderData.id || orderData.orderId,
          customerName: customerName,
          status: newStatus
        };

        // Send email via API
        await sendEmailNotification(emailData);
        
      } catch (error) {
        console.error('‚ùå Error sending fulfillment email:', error);
        // Don't throw error - email failure shouldn't break the fulfillment update
      }
    }

    async function sendShippingEmailNotification(orderData, trackingData) {
      try {
        console.log('üìß Sending shipping email notification');
        
        // Get customer email
        const customerEmail = orderData.customer?.email || orderData.customer_email || orderData.email;
        if (!customerEmail) {
          console.warn('‚ö†Ô∏è No customer email found for order:', orderData.id || orderData.orderId);
          return;
        }

        // Get customer name
        const customerName = orderData.customer?.firstName || 
                           orderData.customer?.name || 
                           orderData.customer_name || 
                           orderData.customerName || 
                           'Valued Customer';

        // Prepare shipping email data
        const emailData = {
          to: customerEmail,
          subject: `üöö Your Order #${trackingData.orderId} Has Been Shipped!`,
          message: getShippingMessage(orderData, trackingData, customerName),
          orderId: trackingData.orderId,
          customerName: customerName,
          trackingId: trackingData.trackingId,
          courierName: trackingData.courierName,
          status: 'shipped'
        };

        // Send email via API
        await sendEmailNotification(emailData);
        
      } catch (error) {
        console.error('‚ùå Error sending shipping email:', error);
        // Don't throw error - email failure shouldn't break the shipping update
      }
    }

    async function sendEmailNotification(emailData) {
      try {
        console.log('üìß Sending email notification:', emailData.subject);
        
        const apiBaseUrl = window.ATTRAL_PUBLIC?.API_BASE_URL || '';
        const response = await fetch(`${apiBaseUrl}/api/send_email.php`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(emailData)
        });

        if (response.ok) {
          console.log('‚úÖ Email notification sent successfully');
        } else {
          console.error('‚ùå Email API error:', response.status, response.statusText);
        }
        
      } catch (error) {
        console.error('‚ùå Error sending email notification:', error);
      }
    }

    function getFulfillmentSubject(status) {
      switch(status) {
        case 'ready-to-dispatch':
          return 'üì¶ Your Order is Ready to Dispatch!';
        case 'shipped':
          return 'üöö Your Order Has Been Shipped!';
        case 'delivered':
          return '‚úÖ Your Order Has Been Delivered!';
        default:
          return 'üì¶ Order Status Update';
      }
    }

    function getFulfillmentMessage(orderData, status, customerName) {
      const orderId = orderData.id || orderData.orderId;
      const orderAmount = orderData.amount || orderData.pricing?.total || 0;
      
      let statusMessage = '';
      let actionText = '';
      
      switch(status) {
        case 'ready-to-dispatch':
          statusMessage = 'Your order is now ready to dispatch and will be shipped soon!';
          actionText = 'We\'re preparing your package for shipment. You\'ll receive tracking information once it\'s dispatched.';
          break;
        case 'shipped':
          statusMessage = 'Great news! Your order has been shipped and is on its way to you.';
          actionText = 'Your package is now in transit. You can track your order using the tracking information provided.';
          break;
        case 'delivered':
          statusMessage = 'Your order has been successfully delivered!';
          actionText = 'Thank you for choosing ATTRAL. We hope you enjoy your purchase. If you have any questions, please don\'t hesitate to contact us.';
          break;
        default:
          statusMessage = 'Your order status has been updated.';
          actionText = 'Thank you for your patience. We\'ll keep you updated on any further changes.';
      }

      return `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center;">
            <h1 style="margin: 0; font-size: 24px; font-weight: 700;">ATTRAL Store</h1>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">Smart Power. Smarter Living.</p>
          </div>
          
          <div style="padding: 30px;">
            <h2 style="color: #333; margin: 0 0 20px 0; font-size: 20px;">Hello ${customerName}!</h2>
            
            <p style="color: #555; line-height: 1.6; margin: 0 0 20px 0;">${statusMessage}</p>
            
            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin: 20px 0;">
              <h3 style="color: #333; margin: 0 0 15px 0; font-size: 16px;">Order Details</h3>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="color: #666;">Order ID:</span>
                <span style="font-weight: 600; color: #333;">#${orderId}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="color: #666;">Order Amount:</span>
                <span style="font-weight: 600; color: #333;">‚Çπ${orderAmount.toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #666;">Status:</span>
                <span style="font-weight: 600; color: #28a745; text-transform: capitalize;">${status.replace('-', ' ')}</span>
              </div>
            </div>
            
            <p style="color: #555; line-height: 1.6; margin: 20px 0;">${actionText}</p>
            
            <div style="background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 8px; padding: 20px; margin: 20px 0;">
              <p style="margin: 0; color: #1976d2;">
                <strong>Need Help?</strong><br>
                If you have any questions about your order, please contact our support team at <a href="mailto:info@attral.in" style="color: #1976d2;">info@attral.in</a> or call us at <a href="tel:+918903479870" style="color: #1976d2;">+91 8903479870</a>.
              </p>
            </div>
          </div>
          
          <div style="background: #f8f9fa; padding: 20px; text-align: center; border-top: 1px solid #e9ecef;">
            <p style="margin: 0; color: #666; font-size: 14px;">
              ¬© ${new Date().getFullYear()} ATTRAL. All rights reserved.<br>
              <a href="https://attral.in" style="color: #667eea;">Visit our website</a> | 
              <a href="mailto:info@attral.in" style="color: #667eea;">Contact Support</a>
            </p>
          </div>
        </div>
      `;
    }

    function getShippingMessage(orderData, trackingData, customerName) {
      const orderId = trackingData.orderId;
      const orderAmount = orderData.amount || orderData.pricing?.total || 0;
      
      return `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center;">
            <h1 style="margin: 0; font-size: 24px; font-weight: 700;">ATTRAL Store</h1>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">Smart Power. Smarter Living.</p>
          </div>
          
          <div style="padding: 30px;">
            <h2 style="color: #333; margin: 0 0 20px 0; font-size: 20px;">Hello ${customerName}!</h2>
            
            <p style="color: #555; line-height: 1.6; margin: 0 0 20px 0;">Great news! Your order has been shipped and is on its way to you. You can now track your package using the details below.</p>
            
            <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin: 20px 0;">
              <h3 style="color: #333; margin: 0 0 15px 0; font-size: 16px;">Order & Shipping Details</h3>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="color: #666;">Order ID:</span>
                <span style="font-weight: 600; color: #333;">#${orderId}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="color: #666;">Order Amount:</span>
                <span style="font-weight: 600; color: #333;">‚Çπ${orderAmount.toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="color: #666;">Tracking ID:</span>
                <span style="font-weight: 600; color: #333; font-family: monospace;">${trackingData.trackingId}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="color: #666;">Courier Service:</span>
                <span style="font-weight: 600; color: #333;">${trackingData.courierName}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #666;">Shipped Date:</span>
                <span style="font-weight: 600; color: #333;">${trackingData.shippedAt.toLocaleDateString()}</span>
              </div>
            </div>
            
            <div style="background: #e8f5e8; border: 1px solid #c8e6c9; border-radius: 8px; padding: 20px; margin: 20px 0;">
              <h3 style="color: #2e7d32; margin: 0 0 15px 0; font-size: 16px;">üöö Track Your Package</h3>
              <p style="color: #2e7d32; margin: 0 0 15px 0; line-height: 1.6;">
                You can track your package using the tracking ID above on the ${trackingData.courierName} website or by contacting their customer service.
              </p>
              <p style="color: #2e7d32; margin: 0; font-size: 14px;">
                <strong>Expected Delivery:</strong> 2-5 business days (depending on location)
              </p>
            </div>
            
            ${trackingData.shippingNotes ? `
              <div style="background: #fff3e0; border: 1px solid #ffcc02; border-radius: 8px; padding: 20px; margin: 20px 0;">
                <h3 style="color: #f57c00; margin: 0 0 15px 0; font-size: 16px;">üìù Shipping Notes</h3>
                <p style="color: #f57c00; margin: 0; line-height: 1.6;">${trackingData.shippingNotes}</p>
              </div>
            ` : ''}
            
            <div style="background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 8px; padding: 20px; margin: 20px 0;">
              <p style="margin: 0; color: #1976d2;">
                <strong>Need Help?</strong><br>
                If you have any questions about your shipment, please contact our support team at <a href="mailto:info@attral.in" style="color: #1976d2;">info@attral.in</a> or call us at <a href="tel:+918903479870" style="color: #1976d2;">+91 8903479870</a>.
              </p>
            </div>
          </div>
          
          <div style="background: #f8f9fa; padding: 20px; text-align: center; border-top: 1px solid #e9ecef;">
            <p style="margin: 0; color: #666; font-size: 14px;">
              ¬© ${new Date().getFullYear()} ATTRAL. All rights reserved.<br>
              <a href="https://attral.in" style="color: #667eea;">Visit our website</a> | 
              <a href="mailto:info@attral.in" style="color: #667eea;">Contact Support</a>
            </p>
          </div>
        </div>
      `;
    }
  </script>

  <!-- Enhanced Footer Section -->
  <footer class="enhanced-footer">
    <!-- Decorative Background Elements -->
    <div class="footer-bg-elements">
      <div class="footer-wave-1"></div>
      <div class="footer-wave-2"></div>
      <div class="footer-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
      </div>
    </div>
    
    <div class="container footer-inner">
      <!-- Newsletter Section -->
      <div class="footer-newsletter">
        <div class="newsletter-content">
          <div class="newsletter-text">
            <h3>üöÄ Stay Updated with ATTRAL</h3>
            <p>Get the latest updates on new products, exclusive offers, and tech innovations delivered to your inbox.</p>
          </div>
          <div class="newsletter-form">
            <div class="input-group">
              <input type="email" placeholder="Enter your email address" class="newsletter-input">
              <button class="newsletter-btn">
                <span>Subscribe</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22,2 15,22 11,13 2,9"></polygon>
                </svg>
              </button>
            </div>
            <p class="newsletter-disclaimer">We respect your privacy. Unsubscribe anytime.</p>
          </div>
        </div>
      </div>

      <!-- Main Footer Content -->
      <div class="footer-content">
        <!-- Company Info Section -->
        <div class="footer-section company-info">
          <div class="footer-logo">
            <div class="logo-icon">‚ö°</div>
            <h4>ATTRAL</h4>
          </div>
          <p class="company-description">Smart Power. Smarter Living. We provide next-generation consumer electronics to power your lifestyle with cutting-edge GaN technology.</p>
          
          <!-- Enhanced Social Links -->
          <div class="social-links-enhanced">
            <a href="https://facebook.com/attral" target="_blank" rel="noopener" class="social-link facebook" title="Follow us on Facebook">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
              <span>Facebook</span>
            </a>
            <a href="https://instagram.com/attral" target="_blank" rel="noopener" class="social-link instagram" title="Follow us on Instagram">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12.017 0C5.396 0 .029 5.367.029 11.987c0 6.62 5.367 11.987 11.988 11.987s11.987-5.367 11.987-11.987C24.014 5.367 18.637.001 12.017.001zM8.449 16.988c-1.297 0-2.448-.49-3.323-1.297C4.198 14.895 3.708 13.744 3.708 12.447s.49-2.448 1.297-3.323c.875-.807 2.026-1.297 3.323-1.297s2.448.49 3.323 1.297c.807.875 1.297 2.026 1.297 3.323s-.49 2.448-1.297 3.323c-.875.807-2.026 1.297-3.323 1.297zm7.83-9.281H7.83c-.49 0-.89.4-.89.89v7.83c0 .49.4.89.89.89h8.449c.49 0 .89-.4.89-.89v-7.83c0-.49-.4-.89-.89-.89z"/>
              </svg>
              <span>Instagram</span>
            </a>
            <a href="https://twitter.com/attral" target="_blank" rel="noopener" class="social-link twitter" title="Follow us on Twitter">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
              </svg>
              <span>Twitter</span>
            </a>
            <a href="https://linkedin.com/company/attral" target="_blank" rel="noopener" class="social-link linkedin" title="Connect on LinkedIn">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
              </svg>
              <span>LinkedIn</span>
            </a>
          </div>
        </div>

        <!-- Quick Links Section -->
        <div class="footer-section">
          <h4>
            <span class="section-icon">üîó</span>
            Quick Links
          </h4>
          <ul class="footer-links">
            <li><a href="index.html"><span class="link-icon">üè†</span> Home</a></li>
            <li><a href="shop.html"><span class="link-icon">üõçÔ∏è</span> Shop</a></li>
            <li><a href="about.html"><span class="link-icon">‚ÑπÔ∏è</span> About Us</a></li>
            <li><a href="contact.html"><span class="link-icon">üìû</span> Contact</a></li>
            <li><a href="blog.html" target="_blank" rel="noopener"><span class="link-icon">üìù</span> Blog</a></li>
          </ul>
        </div>

        <!-- Support Section -->
        <div class="footer-section">
          <h4>
            <span class="section-icon">üõ†Ô∏è</span>
            Support
          </h4>
          <ul class="footer-links">
            <li><a href="account.html"><span class="link-icon">üë§</span> My Account</a></li>
            <li><a href="cart.html"><span class="link-icon">üõí</span> Shopping Cart</a></li>
            <li><a href="affiliates.html"><span class="link-icon">ü§ù</span> Affiliate Program</a></li>
            <li><a href="my-orders.html"><span class="link-icon">üì¶</span> Order Tracking</a></li>
            <li><a href="dashboard-original.html"><span class="link-icon">üìä</span> Dashboard</a></li>
          </ul>
        </div>

        <!-- Contact Info Section -->
        <div class="footer-section contact-info">
          <h4>
            <span class="section-icon">üìç</span>
            Contact Info
          </h4>
          <div class="contact-details">
            <div class="contact-item">
              <div class="contact-icon">üìß</div>
              <div class="contact-text">
                <span class="contact-label">Email</span>
                <a href="mailto:info@attral.in">info@attral.in</a>
              </div>
            </div>
            <div class="contact-item">
              <div class="contact-icon">üì±</div>
              <div class="contact-text">
                <span class="contact-label">Phone</span>
                <a href="tel:+918903479870">+91 8903479870</a>
              </div>
            </div>
            <div class="contact-item">
              <div class="contact-icon">üìç</div>
              <div class="contact-text">
                <span class="contact-label">Address</span>
                <span>Phase 2 Sathuvachari<br>Vellore - 632009<br>Tamil Nadu, India</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer Bottom -->
      <div class="footer-bottom">
        <div class="footer-bottom-content">
          <div class="copyright">
            <p>¬© <span id="year"></span> <strong>ATTRAL</strong>. All rights reserved.</p>
            <p class="tagline">Powering the Future, One Device at a Time</p>
          </div>
          <nav class="footer-nav">
            <a href="privacy.html" class="nav-link">Privacy Policy</a>
            <a href="terms.html" class="nav-link">Terms of Service</a>
            <a href="sitemap.xml" class="nav-link">Sitemap</a>
            <a href="contact.html" class="nav-link">Support</a>
          </nav>
        </div>
        <div class="footer-badges">
          <div class="badge">üîí SSL Secured</div>
          <div class="badge">üöÄ Fast Shipping</div>
          <div class="badge">üíØ Quality Guaranteed</div>
        </div>
      </div>
    </div>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    
    // Email Composer Functions
    let emailComposerData = {
      recipients: [],
      brevoLists: [],
      currentRecipients: [],
      attachments: []
    };
    
    function openEmailComposer() {
      document.getElementById('emailComposerModal').style.display = 'block';
      loadBrevoContactLists();
      loadFirestoreUsers();
    }
    
    function closeEmailComposer() {
      document.getElementById('emailComposerModal').style.display = 'none';
      document.getElementById('emailComposerForm').reset();
      document.getElementById('recipientsPreview').innerHTML = '<p style="color: #6c757d; margin: 0;">Select recipients to see preview...</p>';
      document.getElementById('emailPreview').innerHTML = '<p style="color: #6c757d; margin: 0;">Enter content to see preview...</p>';
      document.getElementById('recipientCount').textContent = '0';
      document.getElementById('estimatedDelivery').textContent = '0';
      document.getElementById('attachmentList').innerHTML = '';
      emailComposerData.attachments = [];
      emailComposerData.currentRecipients = [];
    }
    
    
    function updateRecipientCount() {
      const recipientType = document.getElementById('emailRecipients').value;
      const customGroup = document.getElementById('customRecipientsGroup');
      
      if (recipientType === 'custom') {
        customGroup.style.display = 'block';
      } else {
        customGroup.style.display = 'none';
      }
      
      loadRecipientsPreview(recipientType);
    }
    
    async function loadBrevoContactLists() {
      try {
        const response = await fetch('api/admin-email-system.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'get_brevo_lists'
          })
        });
        
        const result = await response.json();
        if (result.success) {
          emailComposerData.brevoLists = result.lists || [];
          console.log('‚úÖ Brevo lists loaded:', emailComposerData.brevoLists);
        }
      } catch (error) {
        console.error('‚ùå Error loading Brevo lists:', error);
      }
    }
    
    async function loadFirestoreUsers() {
      try {
        const response = await fetch('api/admin-email-system.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'get_firestore_users',
            type: 'all',
            limit: 500
          })
        });
        
        const result = await response.json();
        if (result.success) {
          emailComposerData.recipients = result.users || [];
          console.log('‚úÖ Firestore users loaded:', emailComposerData.recipients.length);
          // Auto-update recipient preview if "all" is selected
          const recipientType = document.getElementById('emailRecipients').value;
          if (recipientType === 'all' || recipientType === 'customers' || recipientType === 'affiliates') {
            loadRecipientsPreview(recipientType);
          }
        }
      } catch (error) {
        console.error('‚ùå Error loading Firestore users:', error);
      }
    }
    
    async function loadRecipientsPreview(recipientType) {
      const previewDiv = document.getElementById('recipientsPreview');
      let recipients = [];
      
      switch (recipientType) {
        case 'all':
          recipients = emailComposerData.recipients;
          break;
        case 'customers':
          recipients = emailComposerData.recipients.filter(r => r.type === 'customer');
          break;
        case 'affiliates':
          recipients = emailComposerData.recipients.filter(r => r.type === 'affiliate');
          break;
        case 'brevo_customer':
          await loadBrevoContacts(3); // Customer list ID
          recipients = emailComposerData.currentRecipients;
          break;
        case 'brevo_affiliate':
          await loadBrevoContacts(10); // Affiliate list ID
          recipients = emailComposerData.currentRecipients;
          break;
        case 'custom':
          const customText = document.getElementById('customRecipients').value;
          if (customText) {
            recipients = customText.split(',').map(email => ({
              email: email.trim(),
              name: email.trim(),
              type: 'custom'
            })).filter(r => r.email);
          }
          break;
      }
      
      emailComposerData.currentRecipients = recipients;
      
      if (recipients.length === 0) {
        previewDiv.innerHTML = '<p style="color: #dc2626; margin: 0; font-weight: 500;">‚ö†Ô∏è No recipients found...</p><p style="color: #6c757d; margin: 5px 0 0 0; font-size: 0.8rem;">Please check your Firestore database or select a different recipient type.</p>';
      } else {
        const previewHtml = recipients.slice(0, 10).map(r => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
            <div>
              <div style="font-weight: 500; color: #1f2937;">${r.name || 'Unknown'}</div>
              <div style="font-size: 0.8rem; color: #6c757d;">${r.email}</div>
              ${r.code ? `<div style="font-size: 0.7rem; color: #8b5cf6;">Code: ${r.code}</div>` : ''}
            </div>
            <span style="background: #e9ecef; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; color: #495057;">
              ${r.type || 'user'}
            </span>
          </div>
        `).join('');
        
        const moreCount = recipients.length > 10 ? recipients.length - 10 : 0;
        previewDiv.innerHTML = previewHtml + (moreCount > 0 ? `<div style="text-align: center; padding: 8px; color: #6c757d; font-size: 0.8rem; background: #f8f9fa; border-radius: 4px; margin-top: 5px;">... and ${moreCount} more recipients</div>` : '');
      }
      
      document.getElementById('recipientCount').textContent = recipients.length;
      document.getElementById('estimatedDelivery').textContent = Math.ceil(recipients.length / 10) + ' min';
    }
    
    async function loadBrevoContacts(listId) {
      try {
        const response = await fetch('api/admin-email-system.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'get_brevo_contacts',
            listId: listId,
            limit: 100
          })
        });
        
        const result = await response.json();
        if (result.success) {
          emailComposerData.currentRecipients = result.contacts.map(c => ({
            email: c.email,
            name: c.attributes.FIRSTNAME || c.email,
            type: 'brevo'
          }));
        }
      } catch (error) {
        console.error('‚ùå Error loading Brevo contacts:', error);
      }
    }
    
    function previewEmail() {
      const content = document.getElementById('emailContent').value;
      const subject = document.getElementById('emailSubject').value;
      
      if (!content || !subject) {
        alert('Please enter both subject and content to preview');
        return;
      }
      
      const previewDiv = document.getElementById('emailPreview');
      const htmlContent = generateEmailHTML(subject, content);
      previewDiv.innerHTML = htmlContent;
    }
    
    function generateEmailHTML(subject, content) {
      return `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: white; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
          <div style="background: linear-gradient(135deg, #6366f1, #8b5cf6); padding: 20px; text-align: center; color: white;">
            <h1 style="margin: 0; font-size: 24px;">‚ö° ATTRAL Electronics</h1>
          </div>
          <div style="padding: 30px;">
            <h2 style="color: #333; margin-bottom: 20px;">${subject}</h2>
            <div style="color: #555; line-height: 1.6; white-space: pre-wrap;">${content}</div>
          </div>
          <div style="background: #1f2937; color: #9ca3af; padding: 20px; text-align: center; font-size: 12px;">
            <p><strong>ATTRAL Electronics</strong></p>
            <p>Premium GaN Chargers for Modern Life</p>
            <p>
              <a href="https://attral.in" style="color: #60a5fa;">Visit Website</a> | 
              <a href="https://attral.in/shop.html" style="color: #60a5fa;">Shop Now</a>
            </p>
          </div>
        </div>
      `;
    }
    
    // Email form submission
    document.getElementById('emailComposerForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const subject = formData.get('subject');
      const content = formData.get('content');
      const recipients = emailComposerData.currentRecipients;
      
      if (recipients.length === 0) {
        alert('No recipients selected. Please select recipients first.');
        return;
      }
      
      if (!subject || !content) {
        alert('Please fill in all required fields.');
        return;
      }
      
      const confirmed = confirm(`Are you sure you want to send this email to ${recipients.length} recipients?`);
      if (!confirmed) return;
      
      try {
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Sending...';
        submitBtn.disabled = true;
        
        const response = await fetch('api/admin-email-system.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'send_bulk_emails',
            recipients: recipients,
            subject: subject,
            content: content,
            params: {
              fromName: formData.get('fromName'),
              fromEmail: formData.get('fromEmail'),
              attachments: emailComposerData.attachments
            }
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`‚úÖ Email sent successfully!\n\nTotal: ${result.totalSent}\nSuccessful: ${result.successCount}\nFailed: ${result.failureCount}`);
          closeEmailComposer();
        } else {
          alert(`‚ùå Failed to send email: ${result.error}`);
        }
        
      } catch (error) {
        console.error('Email sending error:', error);
        alert('‚ùå Error sending email. Please try again.');
      } finally {
        // Reset button state
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });
    
    // Auto-update email preview when content changes
    document.getElementById('emailContent').addEventListener('input', function() {
      const content = this.value;
      const subject = document.getElementById('emailSubject').value;
      
      if (content && subject) {
        const previewDiv = document.getElementById('emailPreview');
        const htmlContent = generateEmailHTML(subject, content);
        previewDiv.innerHTML = htmlContent;
      }
    });
    
    // Auto-update email preview when subject changes
    document.getElementById('emailSubject').addEventListener('input', function() {
      const subject = this.value;
      const content = document.getElementById('emailContent').value;
      
      if (content && subject) {
        const previewDiv = document.getElementById('emailPreview');
        const htmlContent = generateEmailHTML(subject, content);
        previewDiv.innerHTML = htmlContent;
      }
    });
    
    // Auto-update custom recipients preview
    document.getElementById('customRecipients').addEventListener('input', function() {
      if (document.getElementById('emailRecipients').value === 'custom') {
        loadRecipientsPreview('custom');
      }
    });
    
    // Handle file attachments
    document.getElementById('emailAttachments').addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      const attachmentList = document.getElementById('attachmentList');
      
      emailComposerData.attachments = [];
      attachmentList.innerHTML = '';
      
      if (files.length === 0) return;
      
      files.forEach((file, index) => {
        // Check file size (limit to 10MB per file)
        if (file.size > 10 * 1024 * 1024) {
          alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
          return;
        }
        
        // Store file data
        const reader = new FileReader();
        reader.onload = function(e) {
          emailComposerData.attachments.push({
            name: file.name,
            type: file.type,
            size: file.size,
            content: e.target.result.split(',')[1] // Remove data:type;base64, prefix
          });
        };
        reader.readAsDataURL(file);
        
        // Display attachment in UI
        const attachmentDiv = document.createElement('div');
        attachmentDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; margin-bottom: 5px;';
        attachmentDiv.innerHTML = `
          <div style="flex: 1;">
            <div style="font-weight: 500; font-size: 0.9rem;">${file.name}</div>
            <div style="font-size: 0.8rem; color: #6c757d;">${(file.size / 1024).toFixed(1)} KB</div>
          </div>
          <button type="button" onclick="removeAttachment(${index})" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem;">Remove</button>
        `;
        attachmentList.appendChild(attachmentDiv);
      });
    });
    
    function removeAttachment(index) {
      emailComposerData.attachments.splice(index, 1);
      // Refresh the file input and attachment list
      document.getElementById('emailAttachments').value = '';
      document.getElementById('attachmentList').innerHTML = '';
      
      // Re-add remaining attachments
      emailComposerData.attachments.forEach((attachment, i) => {
        const attachmentDiv = document.createElement('div');
        attachmentDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; margin-bottom: 5px;';
        attachmentDiv.innerHTML = `
          <div style="flex: 1;">
            <div style="font-weight: 500; font-size: 0.9rem;">${attachment.name}</div>
            <div style="font-size: 0.8rem; color: #6c757d;">${(attachment.size / 1024).toFixed(1)} KB</div>
          </div>
          <button type="button" onclick="removeAttachment(${i})" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem;">Remove</button>
        `;
        document.getElementById('attachmentList').appendChild(attachmentDiv);
      });
    }
  </script>
</body>
</html>
