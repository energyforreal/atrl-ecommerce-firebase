<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Affiliate Email Testing Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .test-section {
            background: #f8fafc;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }

        .test-section h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .result.success {
            background: #d1fae5;
            border: 2px solid #10b981;
            color: #065f46;
        }

        .result.error {
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #991b1b;
        }

        .result.info {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            color: #1e40af;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .affiliate-info {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .affiliate-info h3 {
            color: #0c4a6e;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #e0f2fe;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #0c4a6e;
        }

        .info-value {
            color: #0369a1;
            font-family: 'Courier New', monospace;
        }

        .quick-test {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .quick-test-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .quick-test-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
        .status-warning { background: #f59e0b; }
        .status-info { background: #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Affiliate Email Testing Dashboard</h1>
            <p>Test all affiliate email functionalities with real Firestore data</p>
        </div>

        <div class="content">
            <!-- Affiliate Lookup Section -->
            <div class="test-section">
                <h2>üîç <span class="status-indicator status-info"></span>Affiliate Lookup</h2>
                <p>Look up affiliate information from Firestore using their affiliate code.</p>
                
                <div class="form-group">
                    <label for="affiliateCode">Affiliate Code:</label>
                    <input type="text" id="affiliateCode" placeholder="e.g., lokesh-9en4b82ktp" value="lokesh-9en4b82ktp">
                </div>
                
                <button class="btn" onclick="lookupAffiliate()">üîç Lookup Affiliate</button>
                <button class="btn btn-secondary" onclick="clearResults('lookupResult')">Clear</button>
                
                <div id="lookupResult" class="result" style="display: none;"></div>
                <div id="affiliateInfo" class="affiliate-info" style="display: none;"></div>
            </div>

            <!-- Quick Email Tests -->
            <div class="test-section">
                <h2>üìß <span class="status-indicator status-success"></span>Quick Email Tests</h2>
                <p>Send different types of affiliate emails using the affiliate data above.</p>
                
                <div class="quick-test">
                    <button class="quick-test-btn" onclick="sendWelcomeEmail()">
                        üéâ Welcome Email
                    </button>
                    <button class="quick-test-btn" onclick="sendCommissionEmail()">
                        üí∞ Commission Email
                    </button>
                    <button class="quick-test-btn" onclick="sendPayoutEmail()">
                        üí≥ Payout Email
                    </button>
                    <button class="quick-test-btn" onclick="sendMilestoneEmail()">
                        üèÜ Milestone Email
                    </button>
                </div>
                
                <div id="emailResult" class="result" style="display: none;"></div>
            </div>

            <!-- Custom Email Test -->
            <div class="test-section">
                <h2>‚öôÔ∏è <span class="status-indicator status-warning"></span>Custom Email Test</h2>
                <p>Send a custom email with your own data.</p>
                
                <div class="grid">
                    <div class="form-group">
                        <label for="customEmail">Email Address:</label>
                        <input type="email" id="customEmail" placeholder="affiliate@example.com">
                    </div>
                    <div class="form-group">
                        <label for="customName">Display Name:</label>
                        <input type="text" id="customName" placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label for="customCode">Affiliate Code:</label>
                        <input type="text" id="customCode" placeholder="john-doe-abc123">
                    </div>
                    <div class="form-group">
                        <label for="customCommission">Commission Amount:</label>
                        <input type="number" id="customCommission" placeholder="150.00" step="0.01">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="emailType">Email Type:</label>
                    <select id="emailType">
                        <option value="welcome">Welcome Email</option>
                        <option value="commission">Commission Email</option>
                        <option value="payout">Payout Email</option>
                        <option value="milestone">Milestone Email</option>
                    </select>
                </div>
                
                <button class="btn" onclick="sendCustomEmail()">üì§ Send Custom Email</button>
                <button class="btn btn-secondary" onclick="clearResults('customResult')">Clear</button>
                
                <div id="customResult" class="result" style="display: none;"></div>
            </div>

            <!-- Order Simulation -->
            <div class="test-section">
                <h2>üõí <span class="status-indicator status-danger"></span>Order Simulation</h2>
                <p>Simulate a complete order with affiliate code to test the full flow.</p>
                
                <div class="grid">
                    <div class="form-group">
                        <label for="orderAffiliateCode">Affiliate Code:</label>
                        <input type="text" id="orderAffiliateCode" placeholder="lokesh-9en4b82ktp" value="lokesh-9en4b82ktp">
                    </div>
                    <div class="form-group">
                        <label for="orderTotal">Order Total (‚Çπ):</label>
                        <input type="number" id="orderTotal" placeholder="1500.00" step="0.01" value="1500.00">
                    </div>
                    <div class="form-group">
                        <label for="orderId">Order ID:</label>
                        <input type="text" id="orderId" placeholder="ATRL-0001" value="ATRL-TEST-001">
                    </div>
                    <div class="form-group">
                        <label for="customerEmail">Customer Email:</label>
                        <input type="email" id="customerEmail" placeholder="customer@example.com" value="testcustomer@example.com">
                    </div>
                </div>
                
                <button class="btn" onclick="simulateOrder()">üöÄ Simulate Complete Order</button>
                <button class="btn btn-secondary" onclick="clearResults('orderResult')">Clear</button>
                
                <div id="orderResult" class="result" style="display: none;"></div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Processing request...</p>
            </div>
        </div>
    </div>

    <script>
        let currentAffiliateData = null;

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showResult(elementId, message, type = 'info') {
            const resultDiv = document.getElementById(elementId);
            resultDiv.textContent = message;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
        }

        function clearResults(elementId) {
            const resultDiv = document.getElementById(elementId);
            resultDiv.style.display = 'none';
            resultDiv.textContent = '';
        }

        async function lookupAffiliate() {
            const affiliateCode = document.getElementById('affiliateCode').value.trim();
            
            if (!affiliateCode) {
                showResult('lookupResult', 'Please enter an affiliate code', 'error');
                return;
            }

            showLoading();

            try {
                // Use the direct affiliate lookup function
                const response = await fetch('/api/affiliate_email.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'lookup_affiliate',
                        affiliateCode: affiliateCode
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentAffiliateData = result.affiliateInfo;
                    
                    // Show affiliate info
                    const affiliateInfoDiv = document.getElementById('affiliateInfo');
                    affiliateInfoDiv.innerHTML = `
                        <h3>üìã Affiliate Information</h3>
                        <div class="info-item">
                            <span class="info-label">ID:</span>
                            <span class="info-value">${result.affiliateInfo.id}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email:</span>
                            <span class="info-value">${result.affiliateInfo.email}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Name:</span>
                            <span class="info-value">${result.affiliateInfo.name}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Code:</span>
                            <span class="info-value">${result.affiliateInfo.code}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Status:</span>
                            <span class="info-value">${result.affiliateInfo.status}</span>
                        </div>
                    `;
                    affiliateInfoDiv.style.display = 'block';
                    
                    showResult('lookupResult', `‚úÖ Affiliate found successfully!\n\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showResult('lookupResult', `‚ùå Affiliate lookup failed:\n\n${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showResult('lookupResult', `‚ùå Error: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function sendWelcomeEmail() {
            if (!currentAffiliateData) {
                showResult('emailResult', '‚ùå Please lookup an affiliate first', 'error');
                return;
            }

            await sendEmail('welcome', currentAffiliateData);
        }

        async function sendCommissionEmail() {
            if (!currentAffiliateData) {
                showResult('emailResult', '‚ùå Please lookup an affiliate first', 'error');
                return;
            }

            const commissionAmount = 150.00; // Default test amount
            const testData = {
                ...currentAffiliateData,
                commission: commissionAmount,
                orderId: 'ATRL-TEST-001'
            };

            await sendEmail('commission', testData);
        }

        async function sendPayoutEmail() {
            if (!currentAffiliateData) {
                showResult('emailResult', '‚ùå Please lookup an affiliate first', 'error');
                return;
            }

            const payoutData = {
                ...currentAffiliateData,
                payoutAmount: 500.00,
                payoutPeriod: 'January 2024'
            };

            await sendEmail('payout', payoutData);
        }

        async function sendMilestoneEmail() {
            if (!currentAffiliateData) {
                showResult('emailResult', '‚ùå Please lookup an affiliate first', 'error');
                return;
            }

            const milestoneData = {
                ...currentAffiliateData,
                milestone: 'First 10 Sales',
                achievement: 'You\'ve reached your first 10 successful referrals!'
            };

            await sendEmail('milestone', milestoneData);
        }

        async function sendCustomEmail() {
            const email = document.getElementById('customEmail').value.trim();
            const name = document.getElementById('customName').value.trim();
            const code = document.getElementById('customCode').value.trim();
            const commission = document.getElementById('customCommission').value;
            const emailType = document.getElementById('emailType').value;

            if (!email || !name || !code) {
                showResult('customResult', '‚ùå Please fill in email, name, and code fields', 'error');
                return;
            }

            const customData = {
                email: email,
                name: name,
                affiliateCode: code,
                commission: parseFloat(commission) || 0,
                orderId: 'ATRL-CUSTOM-001'
            };

            await sendEmail(emailType, customData, 'customResult');
        }

        async function sendEmail(emailType, data, resultElementId = 'emailResult') {
            showLoading();

            try {
                const response = await fetch('/api/affiliate_email.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: emailType,
                        ...data
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showResult(resultElementId, `‚úÖ ${emailType.charAt(0).toUpperCase() + emailType.slice(1)} email sent successfully!\n\nRecipient: ${data.email}\nName: ${data.name}\n\nResponse: ${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showResult(resultElementId, `‚ùå Failed to send ${emailType} email:\n\n${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showResult(resultElementId, `‚ùå Error sending ${emailType} email: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function simulateOrder() {
            const affiliateCode = document.getElementById('orderAffiliateCode').value.trim();
            const orderTotal = document.getElementById('orderTotal').value;
            const orderId = document.getElementById('orderId').value.trim();
            const customerEmail = document.getElementById('customerEmail').value.trim();

            if (!affiliateCode || !orderTotal || !orderId || !customerEmail) {
                showResult('orderResult', '‚ùå Please fill in all order fields', 'error');
                return;
            }

            showLoading();

            try {
                const orderData = {
                    orderId: orderId,
                    affiliateCode: affiliateCode,
                    orderTotal: parseFloat(orderTotal),
                    customerEmail: customerEmail,
                    commission: parseFloat(orderTotal) * 0.10 // 10% commission
                };

                const response = await fetch('/api/affiliate_email.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'simulate_order',
                        orderData: orderData
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showResult('orderResult', `‚úÖ Order simulation completed successfully!\n\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showResult('orderResult', `‚ùå Order simulation failed:\n\n${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showResult('orderResult', `‚ùå Error simulating order: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // Initialize with default affiliate code
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ Affiliate Email Testing Dashboard loaded');
        });
    </script>
</body>
</html>
