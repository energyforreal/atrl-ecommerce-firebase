# ATTRAL Testing Environment Protection
# This file restricts access to the site during testing

# Enable rewrite engine
RewriteEngine On

# Block all access except from whitelisted IPs
# Replace YOUR_IP_ADDRESS with your actual IP address
# You can add multiple IPs by duplicating the RewriteCond line

# Get visitor's real IP (for proxies/CDNs)
RewriteCond %{HTTP:CF-Connecting-IP} !^$
RewriteRule .* - [E=REMOTE_ADDR:%{HTTP:CF-Connecting-IP}]

# Allow your IP address (replace with your actual IP)
RewriteCond %{REMOTE_ADDR} !^27.4.248.160
RewriteCond %{REMOTE_ADDR} !^127\.0\.0\.1$
RewriteCond %{REMOTE_ADDR} !^::1$

# Allow admin login and access control pages
RewriteCond %{REQUEST_URI} !^/admin-login\.html$
RewriteCond %{REQUEST_URI} !^/admin-access\.html$
RewriteCond %{REQUEST_URI} !^/site-access-control\.php$
RewriteCond %{REQUEST_URI} !^/local-admin-bypass\.php$
RewriteCond %{REQUEST_URI} !^/maintenance\.html$
# Allow API directory
RewriteCond %{REQUEST_URI} !^/api/

# Redirect unauthorized visitors to maintenance page
RewriteRule ^(.*)$ /maintenance.html [R=302,L]

# Security headers
<IfModule mod_headers.c>
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# Block common attack patterns
RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} proc/self/environ [OR]
RewriteCond %{QUERY_STRING} mosConfig_[a-zA-Z_]{1,21}(=|\%3D) [OR]
RewriteCond %{QUERY_STRING} base64_(en|de)code[^(]*\([^)]*\) [OR]
RewriteCond %{QUERY_STRING} (<|%3C)([^s]*s)+cript.*(>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (\<|%3C).*iframe.*(\>|%3E) [NC]
RewriteRule .* - [F]

# Prevent access to sensitive files
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Block access to config files
<Files "config.php">
    Order Allow,Deny
    Deny from all
</Files>

# Cache control for testing
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/html "access plus 0 seconds"
    ExpiresByType text/css "access plus 1 hour"
    ExpiresByType application/javascript "access plus 1 hour"
    ExpiresByType image/png "access plus 1 hour"
    ExpiresByType image/jpg "access plus 1 hour"
    ExpiresByType image/jpeg "access plus 1 hour"
</IfModule>
