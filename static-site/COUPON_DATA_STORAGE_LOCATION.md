# 📍 Coupon Data Storage - Exact Firestore Location

## 🎯 Firestore Collection & Document Structure

### **Collection:** `orders`

### **Document ID:** Auto-generated by Firestore (e.g., `2CW3BovpeTqdWXQexJ4m`)

### **Field Where Coupons Are Stored:** `coupons` (array)

---

## 📊 Exact Firestore Path

```
Firestore Database
  └── orders (collection)
       └── {auto-generated-document-id} (document)
            ├── orderId: "ATT-20251007-001"
            ├── razorpayOrderId: "order_xyz123"
            ├── razorpayPaymentId: "pay_abc456"
            ├── status: "confirmed"
            ├── amount: 1299
            ├── currency: "INR"
            ├── customer: {...}
            ├── product: {...}
            ├── pricing: {...}
            ├── shipping: {...}
            ├── payment: {...}
            ├── coupons: [          ← ✅ COUPONS SAVED HERE
            │    {
            │      "code": "WELCOME10",
            │      "name": "Welcome Discount",
            │      "type": "percentage",
            │      "value": 10,
            │      "isAffiliateCoupon": false,
            │      "affiliateCode": null
            │    },
            │    {
            │      "code": "FREESHIP",
            │      "name": "Free Shipping",
            │      "type": "shipping",
            │      "value": 0,
            │      "isAffiliateCoupon": false,
            │      "affiliateCode": null
            │    }
            │  ]
            ├── createdAt: Timestamp
            ├── updatedAt: Timestamp
            ├── couponUsageProcessed: true        ← Added by Cloud Function
            ├── couponUsageProcessedAt: Timestamp ← Added by Cloud Function
            └── couponUsageResults: [...]         ← Added by Cloud Function
```

---

## 🔍 How Coupons Get Written to This Location

### **Step 1: Order Creation (order.html)**

**File:** `static-site/order.html`
**Function:** `handlePaymentSuccess()` → `postOrderWithRetry()`
**API Endpoint:** `/api/firestore_order_manager.php/create`
**Lines:** 2342-2360

```javascript
postOrderWithRetry({
  order_id: order.id,
  payment_id: response.razorpay_payment_id,
  customer: orderData.customer,
  product: orderData.product,
  pricing: orderData.pricing,
  shipping: orderData.shipping,
  coupons: Array.isArray(orderData.coupons) ? orderData.coupons.slice(0, 5) : [],
  // ↑ Coupons sent to API
  payment: {
    method: 'razorpay',
    transaction_id: response.razorpay_payment_id,
    signature: response.razorpay_signature
  }
})
```

### **Step 2: API Processes and Writes to Firestore**

**File:** `static-site/api/firestore_order_manager.php`
**Lines:** 173-200

```php
// Create order document in Firestore
$orderData = [
    'orderId' => $orderNumber,
    'razorpayOrderId' => $input['order_id'],
    'razorpayPaymentId' => $input['payment_id'],
    'status' => 'confirmed',
    'amount' => $resolvedAmount,
    'currency' => $input['pricing']['currency'] ?? 'INR',
    'customer' => $input['customer'],
    'product' => $input['product'],
    'pricing' => $input['pricing'],
    'shipping' => $input['shipping'],
    'payment' => $input['payment'],
    'coupons' => isset($input['coupons']) && is_array($input['coupons']) 
                 ? $input['coupons'] 
                 : [],  // ← ✅ Coupons field created here
    'createdAt' => new \Google\Cloud\Core\Timestamp(new DateTime()),
    'updatedAt' => new \Google\Cloud\Core\Timestamp(new DateTime())
];

// Save to Firestore orders collection
$docRef = $this->firestore->collection('orders')->add($orderData);
//                                        ↑ Collection name
$orderId = $docRef->id();
```

### **Step 3: Success Page Upsert (Optional Enhancement)**

**File:** `static-site/order-success.html`
**Function:** `upsertOrderCoupons()`
**Lines:** 741-757

```javascript
async function upsertOrderCoupons(orderNumber, coupons, order){
  const payload = {
    orderId: orderNumber,
    status: 'confirmed',
    coupons: coupons,  // ← Updates/ensures coupons are present
    amount_rupees_exact: totalRupees,
    amount_paise_exact: Math.round(totalRupees * 100)
  };
  
  await fetch(`${apiBaseUrl}/api/firestore_order_manager.php/update`, {
    method: 'POST',
    body: JSON.stringify(payload)
  });
}
```

---

## 🔥 Cloud Function Reads Coupons From This Location

**File:** `static-site/functions/coupon-usage-tracker.js`
**Function:** `onOrderCreated`

```javascript
exports.onOrderCreated = functions
  .firestore
  .document('orders/{orderId}')  // ← Watches orders collection
  .onCreate(async (snapshot, context) => {
    const orderData = snapshot.data();  // ← Reads entire order document
    
    // Extract coupons array from order document
    const coupons = extractCouponsFromOrder(orderData);
    //                                       ↑ Gets orderData.coupons array
    
    // Increment usage for each coupon
    for (const coupon of coupons) {
      await incrementCouponUsage(coupon.code);
    }
  });
```

---

## 📸 What You'll See in Firebase Console

### Navigation Path:
```
Firebase Console
  → Firestore Database
    → orders (collection)
      → Click any order document
        → Scroll to "coupons" field
```

### Example Document View:

```
Document ID: 2CW3BovpeTqdWXQexJ4m

Fields:
┌─────────────────────────┬────────────────────────┬──────────┐
│ Field                   │ Type                   │ Value    │
├─────────────────────────┼────────────────────────┼──────────┤
│ orderId                 │ string                 │ ATT-...  │
│ razorpayOrderId         │ string                 │ order_...│
│ razorpayPaymentId       │ string                 │ pay_...  │
│ status                  │ string                 │ confirmed│
│ amount                  │ number                 │ 1299     │
│ customer                │ map                    │ {...}    │
│ product                 │ map                    │ {...}    │
│ pricing                 │ map                    │ {...}    │
│ shipping                │ map                    │ {...}    │
│ coupons                 │ array                  │ [2 items]│ ← HERE
│   └─ 0                  │ map                    │          │
│       ├─ code           │ string                 │ WELCOME10│
│       ├─ name           │ string                 │ Welcome..│
│       ├─ type           │ string                 │ percentage│
│       ├─ value          │ number                 │ 10       │
│       ├─ isAffiliateCoupon│ boolean              │ false    │
│       └─ affiliateCode  │ null                   │          │
│   └─ 1                  │ map                    │          │
│       ├─ code           │ string                 │ FREESHIP │
│       ├─ name           │ string                 │ Free...  │
│       ├─ type           │ string                 │ shipping │
│       └─ value          │ number                 │ 0        │
│ createdAt               │ timestamp              │ Oct 7... │
│ updatedAt               │ timestamp              │ Oct 7... │
│ couponUsageProcessed    │ boolean                │ true     │
│ couponUsageProcessedAt  │ timestamp              │ Oct 7... │
│ couponUsageResults      │ array                  │ [2 items]│
└─────────────────────────┴────────────────────────┴──────────┘
```

---

## 🔍 How to Verify Coupons Are Saved

### Method 1: Firebase Console (Visual)

1. Open Firebase Console: https://console.firebase.google.com
2. Select your project: "ATTRAL E-Commerce Store"
3. Click "Firestore Database" in left menu
4. Click "orders" collection
5. Click any order document
6. Look for the "coupons" field (should be an array)
7. Expand the array to see coupon objects

### Method 2: Query in Firebase Console

Click "Run a query" and use:

```
Collection: orders
Where: coupons array-contains {code: "WELCOME10"}
```

This will show all orders that used the WELCOME10 coupon.

### Method 3: Check Logs

After deploying the Cloud Function:

```bash
firebase functions:log --only onOrderCreated
```

Look for logs like:
```
📦 New order created: {orderId}
🎫 Processing 2 coupon(s) for order {orderId}: WELCOME10, FREESHIP
✅ Incremented usage for coupon WELCOME10: 42 → 43
✅ Incremented usage for coupon FREESHIP: 15 → 16
```

---

## 🎯 Summary

**Firestore Path:** `orders/{documentId}/coupons`

**Written By:** 
1. ✅ `/api/firestore_order_manager.php` (during order creation)
2. ✅ `/api/firestore_order_manager.php/update` (during success page upsert)

**Read By:**
1. ✅ Cloud Function `onOrderCreated` (to increment usage)
2. ✅ Your admin dashboard (to view order details)
3. ✅ Analytics queries (to track coupon performance)

**Data Structure:**
```json
{
  "coupons": [
    {
      "code": "WELCOME10",
      "name": "Welcome Discount", 
      "type": "percentage",
      "value": 10,
      "isAffiliateCoupon": false,
      "affiliateCode": null
    }
  ]
}
```

This is the **exact location** where all your coupon data is persisted in Firestore! 🎉

