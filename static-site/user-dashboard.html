<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Dashboard | ATTRAL Store</title>
  <meta name="description" content="Manage your ATTRAL account and view your orders." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    /* Full-Screen Layout Reset */
    html, body {
      margin: 0 !important;
      padding: 0 !important;
      width: 100% !important;
      overflow-x: hidden;
    }
    
    /* Dashboard Page Specific Overrides */
    body.dashboard-page {
      width: 100vw !important;
      max-width: none !important;
    }
    
    .dashboard-page .container {
      max-width: none !important;
      width: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
    }
    
    /* Fix header container padding for logo positioning */
    .dashboard-page .site-header .container {
      padding: 0 20px !important;
      max-width: 1200px !important;
      margin: 0 auto !important;
    }
    
    @media (min-width: 768px) {
      .dashboard-page .site-header .container {
        padding: 0 40px !important;
      }
    }
    
    @media (min-width: 1024px) {
      .dashboard-page .site-header .container {
        padding: 0 60px !important;
      }
    }
    
    /* Fix footer container padding for consistent spacing */
    .dashboard-page .site-footer .container {
      padding: 0 20px !important;
      max-width: 1200px !important;
      margin: 0 auto !important;
    }
    
    @media (min-width: 768px) {
      .dashboard-page .site-footer .container {
        padding: 0 40px !important;
      }
    }
    
    @media (min-width: 1024px) {
      .dashboard-page .site-footer .container {
        padding: 0 60px !important;
      }
    }
    
    .dashboard-container {
      max-width: none !important;
      margin: 0 !important;
      padding: 0 !important;
      background: transparent;
      border: none;
      border-radius: 0;
      box-shadow: none;
      backdrop-filter: none;
      animation: none;
      width: 100vw !important;
      min-height: 100vh;
      position: relative;
      left: 50% !important;
      transform: translateX(-50%) !important;
    }
    
    .dashboard-main {
      padding: 0 !important;
      background: linear-gradient(145deg, #f8fafc, #ffffff);
      position: relative;
      min-height: 100vh;
      width: 100vw !important;
      overflow-x: hidden;
      margin: 0 !important;
      max-width: none !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
    }
    
    /* Dashboard Header */
    .dashboard-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      border-radius: 0;
      padding: 60px 5vw;
      margin: 0;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 40px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(102, 126, 234, 0.2);
      width: 100vw !important;
      min-height: 40vh;
      margin-left: calc(-50vw + 50%) !important;
      margin-right: calc(-50vw + 50%) !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
    }
    
    @media (min-width: 1024px) {
      .dashboard-header {
        padding: 80px 8vw;
        min-height: 50vh;
      }
    }
    
    @media (min-width: 1600px) {
      .dashboard-header {
        padding: 100px 10vw;
        min-height: 60vh;
      }
    }
    
    .dashboard-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
      animation: dashboardGlow 15s ease-in-out infinite;
    }
    
    @keyframes dashboardGlow {
      0%, 100% { transform: rotate(0deg) scale(1); opacity: 0.3; }
      50% { transform: rotate(180deg) scale(1.1); opacity: 0.1; }
    }
    
    .welcome-section {
      display: flex;
      align-items: center;
      gap: 60px;
      position: relative;
      z-index: 2;
      flex: 1;
      max-width: 800px;
    }
    
    .user-avatar-large {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      backdrop-filter: blur(10px);
      border: 3px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      aspect-ratio: 1 / 1;
      flex-shrink: 0;
      object-fit: cover;
    }
    
    .user-avatar-large:hover {
      transform: scale(1.1) rotate(5deg);
      background: rgba(255, 255, 255, 0.3);
    }
    
    .user-avatar-large img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    
    /* Ensure perfect circle for any content */
    .user-avatar-large * {
      border-radius: 50%;
      object-fit: cover;
    }
    
    .welcome-text h2 {
      margin: 0 0 16px;
      font-size: 32px;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      line-height: 1.3;
    }
    
    .welcome-text p {
      margin: 0 0 16px;
      font-size: 18px;
      opacity: 0.9;
      line-height: 1.4;
      font-weight: 500;
    }
    
    .member-badge {
      background: rgba(255, 255, 255, 0.2);
      padding: 12px 20px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .quick-actions {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      position: relative;
      z-index: 2;
      align-items: center;
      justify-content: flex-end;
      flex: 0 0 auto;
    }
    
    .quick-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 18px 28px;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      backdrop-filter: blur(10px);
      font-size: 16px;
    }
    
    .quick-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    
    .quick-btn.danger {
      background: rgba(239, 68, 68, 0.8);
      border-color: rgba(239, 68, 68, 0.9);
    }
    
    .quick-btn.danger:hover {
      background: rgba(239, 68, 68, 1);
    }
    
    /* Dashboard Content Wrapper */
    .dashboard-content-wrapper {
      max-width: 95vw;
      margin: 0 auto;
      padding: 0 40px;
      width: 100%;
      position: relative;
      z-index: 1;
    }
    
    @media (min-width: 1024px) {
      .dashboard-content-wrapper {
        max-width: 90vw;
        padding: 0 60px;
      }
    }
    
    @media (min-width: 1600px) {
      .dashboard-content-wrapper {
        max-width: 85vw;
        padding: 0 80px;
      }
    }
    
    /* Dashboard Stats */
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 32px;
      margin-bottom: 50px;
    }
    
    @media (min-width: 1024px) {
      .dashboard-stats {
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 40px;
        margin-bottom: 60px;
      }
    }
    
    @media (min-width: 1400px) {
      .dashboard-stats {
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 48px;
        margin-bottom: 80px;
      }
    }
    
    .stat-card {
      background: white;
      border-radius: 20px;
      padding: 36px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 24px;
      transition: all 0.3s ease;
      border: 1px solid rgba(102, 126, 234, 0.1);
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
    }
    
    .stat-icon {
      font-size: 40px;
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 16px;
      color: white;
    }
    
    .stat-content {
      flex: 1;
    }
    
    .stat-number {
      font-size: 32px;
      font-weight: 800;
      color: #1f2937;
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }
    
    .stat-number.loaded {
      animation: statCountUp 0.8s ease-out;
    }
    
    @keyframes statCountUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .stat-label {
      font-size: 16px;
      color: #6b7280;
      font-weight: 500;
    }
    
    /* Dashboard Tabs */
    .dashboard-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 40px;
      background: white;
      padding: 12px;
      border-radius: 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
      width: 100%;
    }
    
    .tab-btn {
      background: transparent;
      border: none;
      padding: 16px 28px;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      color: #6b7280;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 16px;
    }
    
    .tab-btn:hover {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
    }
    
    .tab-btn.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    /* Tab Content */
    .tab-content {
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .tab-panel {
      display: none;
      padding: 50px;
    }
    
    .tab-panel.active {
      display: block;
    }
    
    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 32px;
      width: 100%;
    }
    
    @media (min-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 40px;
      }
    }
    
    @media (min-width: 1400px) {
      .dashboard-grid {
        grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
        gap: 48px;
      }
    }
    
    .dashboard-card {
      background: #f8fafc;
      border-radius: 16px;
      padding: 36px;
      border: 1px solid #e5e7eb;
    }
    
    .dashboard-card h3 {
      margin: 0 0 28px;
      color: #1f2937;
      font-size: 24px;
      font-weight: 700;
    }
    
    /* Empty States */
    .empty-state {
      text-align: center;
      padding: 60px 40px;
      color: #6b7280;
    }
    
    .empty-icon {
      font-size: 64px;
      margin-bottom: 24px;
      opacity: 0.5;
    }
    
    .empty-state p {
      margin: 0 0 28px;
      font-size: 20px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 16px;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    
    /* Quick Actions Grid */
    .quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      width: 100%;
    }
    
    .action-btn {
      background: white;
      border: 2px solid #e5e7eb;
      padding: 24px;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    
    .action-btn:hover {
      border-color: #667eea;
      background: #f8fafc;
      transform: translateY(-2px);
    }
    
    .action-icon {
      font-size: 32px;
    }
    
    .action-text {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }
    
    /* Activity Feed */
    .activity-feed {
      max-height: 200px;
      overflow-y: auto;
    }
    
    .activity-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-icon {
      font-size: 20px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f9ff;
      border-radius: 8px;
    }
    
    .activity-content p {
      margin: 0 0 4px;
      font-size: 14px;
      color: #374151;
    }
    
    .activity-time {
      font-size: 12px;
      color: #9ca3af;
    }
    
    /* Order Cards */
    .order-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .order-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      border-color: #667eea;
    }
    
    .order-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .order-id {
      font-weight: 700;
      color: #1f2937;
      font-size: 14px;
    }
    
    .order-date {
      font-size: 12px;
      color: #6b7280;
    }
    
    .order-amount {
      font-weight: 600;
      color: #059669;
      font-size: 16px;
    }
    
    .order-status {
      font-weight: 600;
      font-size: 14px;
      padding: 6px 12px;
      border-radius: 20px;
      background: rgba(102, 126, 234, 0.1);
    }
    
    /* Loading States */
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Enhanced Hover Effects */
    .stat-card:hover .stat-icon {
      transform: scale(1.1) rotate(5deg);
    }
    
    .tab-btn:hover {
      transform: translateY(-2px);
    }
    
    .action-btn:hover .action-icon {
      transform: scale(1.2);
    }
    
    /* Focus States for Accessibility */
    .tab-btn:focus,
    .action-btn:focus,
    .quick-btn:focus {
      outline: 2px solid #667eea;
      outline-offset: 2px;
    }
    
    /* Enhanced Typography */
    .dashboard-card h3 {
      position: relative;
    }
    
    .dashboard-card h3::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      width: 30px;
      height: 3px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 2px;
    }
    
    /* Enhanced Mobile Responsive Design */
    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        text-align: center;
        padding: 40px 20px;
        margin: 0;
        gap: 30px;
        width: 100vw;
        min-height: 35vh;
      }
      
      .welcome-section {
        flex-direction: column;
        text-align: center;
        gap: 20px;
      }
      
      .user-avatar-large {
        width: 100px;
        height: 100px;
        font-size: 40px;
      }
      
      .welcome-text h2 {
        font-size: 28px;
        font-weight: 700;
      }
      
      .welcome-text p {
        font-size: 16px;
        font-weight: 500;
      }
      
      .quick-actions {
        justify-content: center;
        flex-wrap: wrap;
        gap: 16px;
      }
      
      .quick-btn {
        padding: 14px 20px;
        font-size: 14px;
      }
      
      .dashboard-content-wrapper {
        padding: 0 20px;
      }
      
      .dashboard-stats {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }
      
      .stat-card {
        padding: 24px;
      }
      
      .stat-icon {
        width: 60px;
        height: 60px;
        font-size: 30px;
      }
      
      .stat-number {
        font-size: 24px;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 24px;
      }
      
      .dashboard-card {
        padding: 24px;
      }
      
      .tab-panel {
        padding: 24px;
      }
      
      .dashboard-tabs {
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .tab-btn {
        padding: 12px 16px;
        font-size: 14px;
      }
      
      .quick-actions-grid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 16px;
      }
      
      .action-btn {
        padding: 20px;
      }
      
      .action-icon {
        font-size: 28px;
      }
      
      .order-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .order-status {
        align-self: flex-end;
      }
    }
    
    @media (max-width: 480px) {
      .dashboard-header {
        padding: 30px 16px;
        min-height: 30vh;
      }
      
      .user-avatar-large {
        width: 80px;
        height: 80px;
        font-size: 32px;
      }
      
      .welcome-text h2 {
        font-size: 24px;
        font-weight: 700;
      }
      
      .welcome-text p {
        font-size: 14px;
        font-weight: 500;
      }
      
      .dashboard-content-wrapper {
        padding: 0 16px;
      }
      
      .dashboard-stats {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .stat-card {
        padding: 20px;
      }
      
      .dashboard-card {
        padding: 20px;
      }
      
      .tab-panel {
        padding: 20px;
      }
      
      .dashboard-tabs {
        padding: 8px;
      }
      
      .tab-btn {
        padding: 10px 12px;
        font-size: 12px;
      }
      
      .quick-actions-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .action-btn {
        padding: 16px;
      }
      
      .action-icon {
        font-size: 24px;
      }
      
      .action-text {
        font-size: 12px;
      }
    }
    
    /* Address Management Styles */
    .address-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .address-form-container {
      background: #f8fafc;
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .address-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .form-group label {
      font-weight: 600;
      color: #374151;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group select {
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: white;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-group input[readonly] {
      background: #f9fafb;
      color: #6b7280;
    }
    
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #667eea;
    }
    
    .form-actions {
      display: flex;
      gap: 16px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    .btn-secondary {
      background: white;
      color: #6b7280;
      border: 2px solid #e5e7eb;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }
    
    /* Saved Addresses */
    .saved-addresses {
      margin-top: 20px;
    }
    
    .address-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .address-card:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }
    
    .address-card.default {
      border-color: #10b981;
      background: linear-gradient(135deg, #f0fdf4, #ffffff);
    }
    
    .address-card.default::before {
      content: '⭐ Default';
      position: absolute;
      top: -10px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .address-header-info {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .address-name {
      font-weight: 700;
      color: #1f2937;
      font-size: 16px;
    }
    
    .address-phone {
      color: #6b7280;
      font-size: 14px;
      margin-top: 4px;
    }
    
    .address-actions {
      display: flex;
      gap: 8px;
    }
    
    .address-action-btn {
      background: transparent;
      border: 1px solid #e5e7eb;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .address-action-btn.edit {
      color: #667eea;
      border-color: #667eea;
    }
    
    .address-action-btn.edit:hover {
      background: #667eea;
      color: white;
    }
    
    .address-action-btn.delete {
      color: #ef4444;
      border-color: #ef4444;
    }
    
    .address-action-btn.delete:hover {
      background: #ef4444;
      color: white;
    }
    
    .address-details {
      color: #6b7280;
      line-height: 1.5;
    }
    
    .address-details p {
      margin: 4px 0;
    }
    
    /* Responsive Address Form */
    @media (max-width: 768px) {
      .address-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .form-row {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      .address-header-info {
        flex-direction: column;
        gap: 12px;
      }
      
      .address-actions {
        align-self: flex-end;
      }
    }
  </style>
</head>
<body class="dashboard-page">
  <header class="site-header">
    <div class="container header-inner">
      <a class="logo" href="index.html"><img src="logo.png" alt="ATTRAL" style="height:32px; width:auto;" /></a>
      <nav class="nav">
        <a href="index.html">Home</a>
        <a href="shop.html">Shop</a>
        <a href="account.html" class="active">My Account</a>
        <a href="affiliates.html">Affiliate Central</a>
        <a href="contact.html">Contact Us</a>
        <div class="dropdown">
          <a href="#" class="dropdown-toggle" role="button" aria-haspopup="true" aria-expanded="false" aria-label="More menu">More ▾</a>
          <div class="dropdown-menu" role="menu" aria-labelledby="dropdown-toggle">
            <a href="about.html" role="menuitem">About Us</a>
            <a href="blog.html" target="_blank" rel="noopener" role="menuitem">Blog</a>
            <a href="privacy.html" role="menuitem">Privacy</a>
            <a href="terms.html" role="menuitem">Terms</a>
          </div>
        </div>
        <a href="cart.html" class="cart-link">Cart <span id="cart-count" class="badge">0</span></a>
      </nav>
    </div>
  </header>

  <!-- Main Dashboard Content -->
  <main class="dashboard-main">
    <div class="container">
      <div class="dashboard-container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
          <div class="welcome-section">
            <div class="user-avatar-large" id="user-avatar">
              👤
            </div>
            <div class="welcome-text">
              <h2>Welcome back, <span id="user-name">User</span>! 👋</h2>
              <p id="user-email">user@example.com</p>
              <div class="member-info">
                <span class="member-badge">Member since <span id="member-since">2024</span></span>
              </div>
            </div>
          </div>
          <div class="quick-actions">
            <button class="quick-btn" onclick="window.location.href='shop.html'" aria-label="Shop for products">
              <span class="btn-icon">🛍️</span>
              <span class="btn-text">Shop Now</span>
            </button>
            <button class="quick-btn" onclick="window.location.href='cart.html'" aria-label="View shopping cart">
              <span class="btn-icon">🛒</span>
              <span class="btn-text">View Cart</span>
            </button>
            <button id="signout-btn" class="quick-btn danger" aria-label="Sign out of account">
              <span class="btn-icon">🚪</span>
              <span class="btn-text">Sign Out</span>
            </button>
          </div>
        </div>

        

        <!-- Dashboard Tabs -->
        <div class="dashboard-content-wrapper">
          <div class="dashboard-tabs">
            <button class="tab-btn active" data-tab="overview">📊 Overview</button>
            <button class="tab-btn" data-tab="orders">📦 Orders</button>
            <button class="tab-btn" data-tab="addresses">📍 Addresses</button>
          </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
          <div class="dashboard-content-wrapper">
            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-panel active">
              <div class="dashboard-grid">
                <div class="dashboard-card">
                  <h3>📦 Recent Orders</h3>
                  <div id="recent-orders" class="recent-orders">
                    <div class="empty-state">
                      <div class="empty-icon">📦</div>
                      <p>No recent orders</p>
                      <button class="btn-primary" onclick="window.location.href='shop.html'">Start Shopping</button>
                    </div>
                  </div>
                </div>
                
                <div class="dashboard-card">
                  <h3>❤️ Wishlist</h3>
                  <div id="wishlist-preview" class="wishlist-preview">
                    <div class="empty-state">
                      <div class="empty-icon">❤️</div>
                      <p>No items in wishlist</p>
                      <button class="btn-primary" onclick="window.location.href='shop.html'">Browse Products</button>
                    </div>
                  </div>
                </div>
                
                <div class="dashboard-card">
                  <h3>📈 Account Activity</h3>
                  <div id="account-activity" class="activity-feed">
                    <div class="activity-item">
                      <div class="activity-icon">✅</div>
                      <div class="activity-content">
                        <p>Account created successfully</p>
                        <span class="activity-time">Just now</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="dashboard-card">
                  <h3>🎯 Quick Actions</h3>
                  <div class="quick-actions-grid">
                    <button class="action-btn" onclick="showTab('orders')">
                      <span class="action-icon">📦</span>
                      <span class="action-text">View Orders</span>
                    </button>
                    <button class="action-btn" onclick="showTab('profile')">
                      <span class="action-icon">✏️</span>
                      <span class="action-text">Edit Profile</span>
                    </button>
                    <button class="action-btn" onclick="showTab('addresses')">
                      <span class="action-icon">📍</span>
                      <span class="action-text">Manage Addresses</span>
                    </button>
                    <button class="action-btn" onclick="showTab('settings')">
                      <span class="action-icon">⚙️</span>
                      <span class="action-text">Account Settings</span>
                    </button>
                    <button class="action-btn" onclick="window.location.href='affiliate-dashboard.html'">
                      <span class="action-icon">💰</span>
                      <span class="action-text">Affiliate Dashboard</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Orders Tab -->
            <div id="orders-tab" class="tab-panel">
              <div class="dashboard-card">
                <h3>📦 Order History</h3>
                <div id="orders-list">
                  <div class="empty-state">
                    <div class="empty-icon">📦</div>
                    <p>Loading your orders...</p>
                  </div>
                </div>
              </div>
            </div>

            <div id="addresses-tab" class="tab-panel">
              <div class="dashboard-card">
                <div class="address-header">
                  <h3>📍 Address Book</h3>
                  <button id="add-address-btn" class="btn-primary">
                    <span class="btn-icon">➕</span>
                    <span class="btn-text">Add New Address</span>
                  </button>
                </div>
                
                <!-- Add Address Form -->
                <div id="address-form-container" class="address-form-container" style="display: none;">
                  <form id="address-form" class="address-form">
                    <div class="form-row">
                      <div class="form-group">
                        <label for="full-name">Full Name *</label>
                        <input type="text" id="full-name" name="fullName" required>
                      </div>
                      <div class="form-group">
                        <label for="phone">Phone Number *</label>
                        <input type="tel" id="phone" name="phone" required>
                      </div>
                    </div>
                    
                    <div class="form-group">
                      <label for="address-line1">Address Line 1 *</label>
                      <input type="text" id="address-line1" name="addressLine1" placeholder="House number, building name, street" required>
                    </div>
                    
                    <div class="form-group">
                      <label for="address-line2">Address Line 2</label>
                      <input type="text" id="address-line2" name="addressLine2" placeholder="Apartment, suite, unit, etc.">
                    </div>
                    
                    <div class="form-row">
                      <div class="form-group">
                        <label for="city">City *</label>
                        <input type="text" id="city" name="city" required>
                      </div>
                      <div class="form-group">
                        <label for="state">State *</label>
                        <select id="state" name="state" required>
                          <option value="">Select State</option>
                          <option value="Andhra Pradesh">Andhra Pradesh</option>
                          <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                          <option value="Assam">Assam</option>
                          <option value="Bihar">Bihar</option>
                          <option value="Chhattisgarh">Chhattisgarh</option>
                          <option value="Goa">Goa</option>
                          <option value="Gujarat">Gujarat</option>
                          <option value="Haryana">Haryana</option>
                          <option value="Himachal Pradesh">Himachal Pradesh</option>
                          <option value="Jharkhand">Jharkhand</option>
                          <option value="Karnataka">Karnataka</option>
                          <option value="Kerala">Kerala</option>
                          <option value="Madhya Pradesh">Madhya Pradesh</option>
                          <option value="Maharashtra">Maharashtra</option>
                          <option value="Manipur">Manipur</option>
                          <option value="Meghalaya">Meghalaya</option>
                          <option value="Mizoram">Mizoram</option>
                          <option value="Nagaland">Nagaland</option>
                          <option value="Odisha">Odisha</option>
                          <option value="Punjab">Punjab</option>
                          <option value="Rajasthan">Rajasthan</option>
                          <option value="Sikkim">Sikkim</option>
                          <option value="Tamil Nadu">Tamil Nadu</option>
                          <option value="Telangana">Telangana</option>
                          <option value="Tripura">Tripura</option>
                          <option value="Uttar Pradesh">Uttar Pradesh</option>
                          <option value="Uttarakhand">Uttarakhand</option>
                          <option value="West Bengal">West Bengal</option>
                          <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                          <option value="Chandigarh">Chandigarh</option>
                          <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
                          <option value="Delhi">Delhi</option>
                          <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                          <option value="Ladakh">Ladakh</option>
                          <option value="Lakshadweep">Lakshadweep</option>
                          <option value="Puducherry">Puducherry</option>
                        </select>
                      </div>
                    </div>
                    
                    <div class="form-row">
                      <div class="form-group">
                        <label for="pincode">Pincode *</label>
                        <input type="text" id="pincode" name="pincode" pattern="[0-9]{6}" maxlength="6" required>
                      </div>
                      <div class="form-group">
                        <label for="country">Country *</label>
                        <input type="text" id="country" name="country" value="India" readonly>
                      </div>
                    </div>
                    
                    <div class="form-group">
                      <label class="checkbox-label">
                        <input type="checkbox" id="is-default" name="isDefault">
                        <span class="checkmark"></span>
                        Set as default address
                      </label>
                    </div>
                    
                    <div class="form-actions">
                      <button type="button" id="cancel-address" class="btn-secondary">Cancel</button>
                      <button type="submit" id="save-address" class="btn-primary">
                        <span class="btn-icon">💾</span>
                        <span class="btn-text">Save Address</span>
                      </button>
                      <button type="button" id="test-firebase" class="btn-secondary" style="margin-left: 10px; font-size: 12px;">
                        Test Firebase
                      </button>
                    </div>
                  </form>
                </div>
                
                <!-- Saved Addresses List -->
                <div id="saved-addresses" class="saved-addresses">
                  <div class="empty-state">
                    <div class="empty-icon">📍</div>
                    <p>No addresses saved yet</p>
                    <button class="btn-primary" onclick="showAddressForm()">Add Your First Address</button>
                  </div>
                </div>
              </div>
            </div>

            
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <div class="footer-content">
        <div class="footer-section">
          <h4>About ATTRAL</h4>
          <p>Smart Power. Smarter Living. We provide next-gen consumer electronics to power your lifestyle with cutting-edge GaN technology.</p>
          <div class="social-links">
            <a href="https://facebook.com/attral" target="_blank" rel="noopener" title="Follow us on Facebook">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
            </a>
            <a href="https://instagram.com/attral" target="_blank" rel="noopener" title="Follow us on Instagram">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12.017 0C5.396 0 .029 5.367.029 11.987c0 6.62 5.367 11.987 11.988 11.987s11.987-5.367 11.987-11.987C24.014 5.367 18.637.001 12.017.001zM8.449 16.988c-1.297 0-2.448-.49-3.323-1.297C4.198 14.895 3.708 13.744 3.708 12.447s.49-2.448 1.297-3.323c.875-.807 2.026-1.297 3.323-1.297s2.448.49 3.323 1.297c.807.875 1.297 2.026 1.297 3.323s-.49 2.448-1.297 3.323c-.875.807-2.026 1.297-3.323 1.297zm7.83-9.281H7.83c-.49 0-.89.4-.89.89v7.83c0 .49.4.89.89.89h8.449c.49 0 .89-.4.89-.89v-7.83c0-.49-.4-.89-.89-.89z"/>
              </svg>
            </a>
            <a href="https://twitter.com/attral" target="_blank" rel="noopener" title="Follow us on Twitter">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
              </svg>
            </a>
            <a href="https://linkedin.com/company/attral" target="_blank" rel="noopener" title="Connect on LinkedIn">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
              </svg>
            </a>
          </div>
        </div>
        <div class="footer-section">
          <h4>Quick Links</h4>
          <p><a href="index.html">Home</a></p>
          <p><a href="shop.html">Shop</a></p>
          <p><a href="about.html">About Us</a></p>
          <p><a href="contact.html">Contact</a></p>
        </div>
        <div class="footer-section">
          <h4>Support</h4>
          <p><a href="account.html">My Account</a></p>
          <p><a href="cart.html">Shopping Cart</a></p>
          <p><a href="affiliates.html">Affiliate Program</a></p>
          <p><a href="blog.html" target="_blank" rel="noopener">Blog</a></p>
        </div>
        <div class="footer-section">
          <h4>Contact Info</h4>
          <p>📧 info@attral.in</p>
          <p>📱 +91 8903479870</p>
          <p>📍 Phase 2 Sathuvachari<br>Vellore - 632009<br>Tamil Nadu, India</p>
        </div>
      </div>
      <div class="footer-bottom">
        <p>© <span id="year"></span> ATTRAL. All rights reserved.</p>
        <nav>
          <a href="privacy.html">Privacy Policy</a>
          <a href="terms.html">Terms of Service</a>
          <a href="sitemap.xml">Sitemap</a>
        </nav>
      </div>
    </div>
  </footer>

  <script src="js/config.js"></script>
  <script src="js/app.js"></script>
  <script src="js/firebase.js"></script>
  <script src="js/auth-manager.js"></script>
  <script src="js/dropdown.js"></script>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    window.Attral.initHeaderCartCount();

    function qs(id){ return document.getElementById(id); }
    
    // Check authentication status on page load
    function checkAuthStatus() {
      if (!window.AuthManager) {
        console.log('AuthManager not available, redirecting to account page');
        window.location.href = 'account.html';
        return;
      }

      // Use unified auth manager
      window.AuthManager.addAuthStateListener(function(user) {
        if (user && !user.isAnonymous) {
          console.log('User authenticated in user dashboard:', user.email);
          setLoggedInUI(user);
          initializeDashboard();
        } else {
          console.log('User not authenticated, redirecting to account page');
          window.location.href = 'account.html';
        }
      });
    }
    
    function setLoggedInUI(user) {
      // Update user info
      const userName = user.displayName || user.email?.split('@')[0] || 'User';
      const userEmail = user.email || 'No email';
      const userInitial = userName.charAt(0).toUpperCase();
      
      qs('user-name').textContent = userName;
      qs('user-email').textContent = userEmail;
      
      // Handle user avatar - prioritize Google account photo
      const avatarElement = qs('user-avatar');
      if (avatarElement) {
        console.log('Setting up user avatar for:', userName);
        console.log('User object:', user);
        console.log('User photoURL:', user.photoURL);
        console.log('User provider data:', user.providerData);
        console.log('User displayName:', user.displayName);
        
        // Clear any existing content
        avatarElement.innerHTML = '';
        
        // Get photo URL - try multiple sources
        let photoURL = null;
        
        // Method 1: Check user.photoURL first (this is usually the Google photo if signed in with Google)
        if (user.photoURL && user.photoURL.trim() !== '') {
          photoURL = user.photoURL;
          console.log('Using user.photoURL:', photoURL);
        }
        
        // Method 2: Check Google provider data if user.photoURL is not available
        if (!photoURL && user.providerData && user.providerData.length > 0) {
          const googleProvider = user.providerData.find(provider => provider.providerId === 'google.com');
          if (googleProvider && googleProvider.photoURL) {
            photoURL = googleProvider.photoURL;
            console.log('Using Google provider photo URL:', photoURL);
          }
        }
        
        // Method 3: For Google accounts, construct photo URL if needed
        if (!photoURL && user.email && user.email.includes('@gmail.com')) {
          // This is a fallback for Google accounts without photo URL
          console.log('Detected Gmail account but no photo URL found');
        }
        
        // If we have a photo URL, try to load it
        if (photoURL && photoURL.trim() !== '') {
          console.log('Loading user photo from:', photoURL);
          
          // Create img element
          const img = document.createElement('img');
          img.src = photoURL;
          img.alt = userName;
          img.style.cssText = 'width: 100%; height: 100%; object-fit: cover; border-radius: 50%; display: block;';
          
          // Set a timeout to handle slow loading
          const loadTimeout = setTimeout(() => {
            console.log('Photo loading timeout, using fallback');
            avatarElement.innerHTML = '';
            avatarElement.textContent = userInitial;
            avatarElement.style.background = 'rgba(255, 255, 255, 0.2)';
            avatarElement.style.display = 'flex';
            avatarElement.style.alignItems = 'center';
            avatarElement.style.justifyContent = 'center';
            avatarElement.style.fontSize = '48px';
            avatarElement.style.fontWeight = '700';
            avatarElement.style.color = 'white';
          }, 5000);
          
          img.onload = function() {
            clearTimeout(loadTimeout);
            console.log('User photo loaded successfully');
            avatarElement.style.background = 'transparent';
            avatarElement.style.display = 'flex';
            avatarElement.style.alignItems = 'center';
            avatarElement.style.justifyContent = 'center';
          };
          
          img.onerror = function() {
            clearTimeout(loadTimeout);
            console.log('User photo failed to load from:', photoURL, 'using initial fallback');
            avatarElement.innerHTML = '';
            avatarElement.textContent = userInitial;
            avatarElement.style.background = 'rgba(255, 255, 255, 0.2)';
            avatarElement.style.display = 'flex';
            avatarElement.style.alignItems = 'center';
            avatarElement.style.justifyContent = 'center';
            avatarElement.style.fontSize = '48px';
            avatarElement.style.fontWeight = '700';
            avatarElement.style.color = 'white';
          };
          
          avatarElement.appendChild(img);
          avatarElement.style.background = 'transparent';
          avatarElement.style.display = 'flex';
          avatarElement.style.alignItems = 'center';
          avatarElement.style.justifyContent = 'center';
        } else {
          console.log('No photo URL available, using initial fallback');
          // Use initial as fallback
          avatarElement.textContent = userInitial;
          avatarElement.style.background = 'rgba(255, 255, 255, 0.2)';
          avatarElement.style.display = 'flex';
          avatarElement.style.alignItems = 'center';
          avatarElement.style.justifyContent = 'center';
          avatarElement.style.fontSize = '48px';
          avatarElement.style.fontWeight = '700';
          avatarElement.style.color = 'white';
        }
      }
      
      // Update member since date
      const memberSince = user.metadata?.creationTime ? 
        new Date(user.metadata.creationTime).getFullYear() : 
        new Date().getFullYear();
      qs('member-since').textContent = memberSince;
      
      // Load user stats
      loadUserStats(user.uid);
    }
    
    function loadUserStats(uid) {
      if (window.AttralFirebase && window.AttralFirebase.db) {
        // Loading states are already shown via HTML spinners
        
        // Load order count
        window.AttralFirebase.db.collection('orders')
          .where('uid', '==', uid)
          .get()
          .then(snapshot => {
            qs('order-count').textContent = snapshot.size;
            qs('order-count').classList.add('loaded');
            
            // Calculate total spent
            let totalSpent = 0;
            snapshot.forEach(doc => {
              const order = doc.data();
              totalSpent += order.amount || 0;
            });
            qs('total-spent').textContent = `₹${totalSpent.toLocaleString()}`;
            qs('total-spent').classList.add('loaded');
            
            // Calculate loyalty points (1 point per ₹100 spent)
            const points = Math.floor(totalSpent / 100);
            qs('loyalty-points').textContent = points;
            qs('loyalty-points').classList.add('loaded');
          })
          .catch(error => {
            console.error('Error loading user stats:', error);
            qs('order-count').textContent = '0';
            qs('total-spent').textContent = '₹0';
            qs('loyalty-points').textContent = '0';
          });
          
        // Load wishlist count
        window.AttralFirebase.db.collection('wishlist')
          .where('uid', '==', uid)
          .get()
          .then(snapshot => {
            qs('wishlist-count').textContent = snapshot.size;
            qs('wishlist-count').classList.add('loaded');
          })
          .catch(error => {
            console.error('Error loading wishlist count:', error);
            qs('wishlist-count').textContent = '0';
          });
      } else {
        // Set default values if Firebase not available
        qs('order-count').textContent = '0';
        qs('total-spent').textContent = '₹0';
        qs('loyalty-points').textContent = '0';
        qs('wishlist-count').textContent = '0';
      }
    }
    
    // Sign out handler
    qs('signout-btn').addEventListener('click', function(){ 
      if (window.AuthManager) {
        window.AuthManager.signOut()
          .then(function() {
            console.log('Sign out successful');
            window.location.href = 'account.html';
          })
          .catch(function(error) {
            console.error('Sign out error:', error);
          });
      } else {
        console.error('AuthManager not available for sign out');
      }
    });
    
    // Dashboard functionality
    function initializeDashboard() {
      setupTabNavigation();
      loadUserDashboardData();
    }
    
    function setupTabNavigation() {
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabPanels = document.querySelectorAll('.tab-panel');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          const targetTab = this.getAttribute('data-tab');
          
          // Remove active class from all buttons and panels
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabPanels.forEach(panel => panel.classList.remove('active'));
          
          // Add active class to clicked button and corresponding panel
          this.classList.add('active');
          document.getElementById(targetTab + '-tab').classList.add('active');
        });
      });
    }
    
    function showTab(tabName) {
      const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
      if (tabButton) {
        tabButton.click();
      }
    }
    
    function loadUserDashboardData() {
      const user = window.AttralFirebase?.auth?.currentUser;
      if (!user) return;
      
      // Load user stats
      loadUserStats(user.uid);
      
      // Load recent orders
      loadRecentOrders(user.uid);
      // Start live listener for Orders tab
      startOrdersLiveListener(user.uid);
      
      // Load wishlist
      loadWishlist(user.uid);
      
      // Load account activity
      loadAccountActivity(user.uid);
    }
    
    function loadRecentOrders(uid) {
      if (!window.AttralFirebase?.db) return;
      
      window.AttralFirebase.db.collection('orders')
        .where('uid', '==', uid)
        .orderBy('createdAt', 'desc')
        .limit(3)
        .get()
        .then(snapshot => {
          const ordersContainer = qs('recent-orders');
          
          if (snapshot.empty) {
            ordersContainer.innerHTML = `
              <div class="empty-state">
                <div class="empty-icon">📦</div>
                <p>No recent orders</p>
                <button class="btn-primary" onclick="window.location.href='shop.html'">Start Shopping</button>
              </div>
            `;
            return;
          }
          
          let ordersHTML = '';
          snapshot.forEach(doc => {
            const order = doc.data();
            ordersHTML += createOrderCard(order);
          });
          
          ordersContainer.innerHTML = ordersHTML;
        })
        .catch(error => {
          console.error('Error loading recent orders:', error);
        });
    }

    // Live listener for Orders tab
    let ordersUnsubscribe = null;
    function startOrdersLiveListener(uid) {
      if (!window.AttralFirebase?.db) return;
      if (ordersUnsubscribe) { try { ordersUnsubscribe(); } catch(_) {} }

      const q = window.AttralFirebase.db
        .collection('orders')
        .where('uid', '==', uid)
        .orderBy('createdAt', 'desc')
        .limit(50);

      ordersUnsubscribe = q.onSnapshot((snapshot) => {
        const container = document.getElementById('orders-list');
        if (!container) return;

        if (snapshot.empty) {
          container.innerHTML = `
            <div class=\"empty-state\">
              <div class=\"empty-icon\">📦</div>
              <p>No orders found</p>
              <button class=\"btn-primary\" onclick=\"window.location.href='products.html'\">Start Shopping</button>
            </div>
          `;
          return;
        }

        let html = '';
        snapshot.forEach(doc => {
          const order = doc.data();
          html += createOrderCard(order);
        });
        container.innerHTML = html;
      }, (err) => {
        console.error('Orders listener error:', err);
      });
    }
    
    function createOrderCard(order) {
      const created = order.createdAt && order.createdAt.toDate ? order.createdAt.toDate() : (order.createdAt instanceof Date ? order.createdAt : new Date());
      const orderDate = new Date(created).toLocaleDateString();
      const status = (order.fulfillmentStatus || order.status || 'yet-to-dispatch');
      const statusLabelMap = {
        'yet-to-dispatch': 'Yet to Dispatch',
        'ready-to-dispatch': 'Ready for Dispatch',
        'shipped': 'Shipped',
        'delivered': 'Delivered',
        'cancelled': 'Cancelled',
        'pending': 'Pending'
      };
      const statusColorMap = {
        'yet-to-dispatch': '#f59e0b',
        'ready-to-dispatch': '#8b5cf6',
        'shipped': '#3b82f6',
        'delivered': '#10b981',
        'cancelled': '#ef4444',
        'pending': '#6b7280'
      };
      const statusColor = statusColorMap[status] || '#6b7280';
      const statusLabel = statusLabelMap[status] || (status.charAt(0).toUpperCase() + status.slice(1));

      // Resolve shipping address and phone from various schemas
      const shipping = order.shipping || {};
      const shippingAddressParts = [
        shipping.address,
        [shipping.city, shipping.state].filter(Boolean).join(', '),
        shipping.pincode,
        shipping.country
      ].filter(Boolean);
      const shippingAddress = shippingAddressParts.join(' • ');
      const phone = (order.customer && order.customer.phone) || (order.notes && order.notes.phone) || order.phone || '';

      // Tracking (prefer nested shipping.tracking.id)
      const tracking = (shipping.tracking || {});
      const trackingId = tracking.id || order.trackingId || null;
      const courierName = tracking.courierName || order.courierName || null;

      const amount = (parseFloat((typeof order.amount === 'number' ? order.amount : (order.pricing?.total || 0))) || 0);

      return `
        <div class="order-card">
          <div class="order-info">
            <div class="order-id">Order #${order.orderCode || order.orderId || 'N/A'}</div>
            <div class="order-date">${orderDate}</div>
            <div class="order-amount">₹${amount.toLocaleString()}</div>
            ${shippingAddress ? `<div style="font-size:12px; color:#6b7280; margin-top:4px;">📍 ${shippingAddress}</div>` : ''}
            ${phone ? `<div style="font-size:12px; color:#6b7280;">📞 ${phone}</div>` : ''}
            <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
              <span class="order-status" style="color:${statusColor}; background: rgba(102,126,234,0.08);">${statusLabel}</span>
              ${trackingId ? `<span class="order-status" style="color:#2563eb; background: rgba(37,99,235,0.08);">🚚 ${courierName ? courierName + ' • ' : ''}Tracking: ${trackingId}</span>` : ''}
            </div>
          </div>
        </div>
      `;
    }
    
    function loadWishlist(uid) {
      // For now, show empty state
      const wishlistContainer = qs('wishlist-preview');
      wishlistContainer.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">❤️</div>
          <p>No items in wishlist</p>
          <button class="btn-primary" onclick="window.location.href='products.html'">Browse Products</button>
        </div>
      `;
    }
    
    function loadAccountActivity(uid) {
      const activityContainer = qs('account-activity');
      const activities = [
        { icon: '✅', text: 'Account created successfully', time: 'Just now' },
        { icon: '🔐', text: 'Password updated', time: '2 hours ago' },
        { icon: '📧', text: 'Email verified', time: '1 day ago' }
      ];
      
      let activityHTML = '';
      activities.forEach(activity => {
        activityHTML += `
          <div class="activity-item">
            <div class="activity-icon">${activity.icon}</div>
            <div class="activity-content">
              <p>${activity.text}</p>
              <span class="activity-time">${activity.time}</span>
            </div>
          </div>
        `;
      });
      
      activityContainer.innerHTML = activityHTML;
    }
    
    // Wait for Firebase to load and check auth status
    let attempts = 0;
    const maxAttempts = 50; // 5 seconds max wait
    
    function checkFirebase() {
      attempts++;
      const fb = window.AttralFirebase;
      
      if (fb && fb.auth) {
        console.log('Firebase initialized successfully');
        checkAuthStatus();
      } else if (attempts < maxAttempts) {
        console.log(`Waiting for Firebase... attempt ${attempts}/${maxAttempts}`);
        setTimeout(checkFirebase, 100);
      } else {
        console.error('Firebase failed to load after maximum attempts');
        window.location.href = 'account.html';
      }
    }
    
    // Start checking for Firebase
    checkFirebase();
    
    // Address Management Functions
    let editingAddressId = null;
    
    function showAddressForm() {
      const formContainer = qs('address-form-container');
      formContainer.style.display = 'block';
      formContainer.scrollIntoView({ behavior: 'smooth' });
      
      // Clear form if not editing
      if (!editingAddressId) {
        qs('address-form').reset();
      }
    }
    
    function hideAddressForm() {
      const formContainer = qs('address-form-container');
      formContainer.style.display = 'none';
      editingAddressId = null;
      qs('address-form').reset();
    }
    
    function loadSavedAddresses(uid) {
      if (!window.AttralFirebase?.db) {
        console.log('Firebase not available for loading addresses');
        return;
      }
      
      window.AttralFirebase.db.collection('addresses')
        .where('uid', '==', uid)
        .orderBy('isDefault', 'desc')
        .orderBy('createdAt', 'desc')
        .get()
        .then(snapshot => {
          const addressesContainer = qs('saved-addresses');
          
          if (snapshot.empty) {
            addressesContainer.innerHTML = `
              <div class="empty-state">
                <div class="empty-icon">📍</div>
                <p>No addresses saved yet</p>
                <button class="btn-primary" onclick="showAddressForm()">Add Your First Address</button>
              </div>
            `;
            return;
          }
          
          let addressesHTML = '';
          snapshot.forEach(doc => {
            const address = doc.data();
            addressesHTML += createAddressCard(doc.id, address);
          });
          
          addressesContainer.innerHTML = addressesHTML;
        })
        .catch(error => {
          console.error('Error loading addresses:', error);
          qs('saved-addresses').innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">⚠️</div>
              <p>Error loading addresses</p>
              <button class="btn-primary" onclick="loadSavedAddresses('${uid}')">Retry</button>
            </div>
          `;
        });
    }
    
    function createAddressCard(addressId, address) {
      const isDefault = address.isDefault ? 'default' : '';
      const defaultBadge = address.isDefault ? '<span class="default-badge">⭐ Default</span>' : '';
      
      return `
        <div class="address-card ${isDefault}" data-address-id="${addressId}">
          ${defaultBadge}
          <div class="address-header-info">
            <div>
              <div class="address-name">${address.fullName}</div>
              <div class="address-phone">📞 ${address.phone}</div>
            </div>
            <div class="address-actions">
              <button class="address-action-btn edit" onclick="editAddress('${addressId}')">✏️ Edit</button>
              <button class="address-action-btn delete" onclick="deleteAddress('${addressId}')">🗑️ Delete</button>
            </div>
          </div>
          <div class="address-details">
            <p>${address.addressLine1}</p>
            ${address.addressLine2 ? `<p>${address.addressLine2}</p>` : ''}
            <p>${address.city}, ${address.state} - ${address.pincode}</p>
            <p>${address.country}</p>
          </div>
        </div>
      `;
    }
    
    function editAddress(addressId) {
      if (!window.AttralFirebase?.db) {
        console.error('Firebase not available');
        return;
      }
      
      window.AttralFirebase.db.collection('addresses')
        .doc(addressId)
        .get()
        .then(doc => {
          if (doc.exists) {
            const address = doc.data();
            editingAddressId = addressId;
            
            // Populate form with address data
            qs('full-name').value = address.fullName || '';
            qs('phone').value = address.phone || '';
            qs('address-line1').value = address.addressLine1 || '';
            qs('address-line2').value = address.addressLine2 || '';
            qs('city').value = address.city || '';
            qs('state').value = address.state || '';
            qs('pincode').value = address.pincode || '';
            qs('is-default').checked = address.isDefault || false;
            
            showAddressForm();
          }
        })
        .catch(error => {
          console.error('Error loading address for edit:', error);
          alert('Error loading address details');
        });
    }
    
    function deleteAddress(addressId) {
      if (!confirm('Are you sure you want to delete this address?')) {
        return;
      }
      
      if (!window.AttralFirebase?.db) {
        console.error('Firebase not available');
        return;
      }
      
      const user = window.AttralFirebase.auth.currentUser;
      if (!user) return;
      
      window.AttralFirebase.db.collection('addresses')
        .doc(addressId)
        .delete()
        .then(() => {
          console.log('Address deleted successfully');
          loadSavedAddresses(user.uid);
        })
        .catch(error => {
          console.error('Error deleting address:', error);
          alert('Error deleting address');
        });
    }
    
    // Simplified direct save function
    async function saveAddressDirect(formData) {
      console.log('saveAddressDirect called with:', formData);
      
      // Show loading state
      const saveBtn = document.getElementById('save-address');
      const originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px; margin-right: 8px;"></span>Saving...';
      saveBtn.disabled = true;
      
      try {
        // Check Firebase availability
        if (!window.AttralFirebase) {
          throw new Error('Firebase not loaded');
        }
        
        if (!window.AttralFirebase.auth) {
          throw new Error('Authentication not available');
        }
        
        if (!window.AttralFirebase.db) {
          throw new Error('Database not available');
        }
        
        // Ensure user is authenticated
        const user = await ensureUserAuthenticated();
        console.log('User authenticated:', user.uid, user.email || 'Anonymous');
        console.log('User is anonymous:', user.isAnonymous);
        
        // Prepare address data
        const addressData = {
          uid: user.uid,
          fullName: formData.fullName.trim(),
          phone: formData.phone.trim(),
          addressLine1: formData.addressLine1.trim(),
          addressLine2: formData.addressLine2.trim(),
          city: formData.city.trim(),
          state: formData.state,
          pincode: formData.pincode.trim(),
          country: formData.country.trim(),
          isDefault: formData.isDefault,
          createdAt: new Date(),
          updatedAt: new Date()
        };
        
        console.log('Address data prepared:', addressData);
        
        // Save to Firebase
        const addressesRef = window.AttralFirebase.db.collection('addresses');
        
        if (editingAddressId) {
          // Update existing address
          console.log('Updating existing address:', editingAddressId);
          addressesRef.doc(editingAddressId).update(addressData)
            .then(() => {
              console.log('Address updated successfully');
              showSuccessMessage('Address updated successfully!');
              hideAddressForm();
              loadSavedAddresses(user.uid);
            })
            .catch(error => {
              console.error('Error updating address:', error);
              
              if (error.code === 'permission-denied') {
                showErrorMessage('Permission denied. Please check Firestore security rules or contact support.');
                console.error('Firestore rules issue. Rules should allow: request.auth.uid == resource.data.uid');
              } else if (error.code === 'unavailable') {
                showErrorMessage('Database temporarily unavailable. Please try again.');
              } else {
                showErrorMessage('Error updating address: ' + error.message);
              }
            });
        } else {
          // Add new address
          console.log('Adding new address');
          addressesRef.add(addressData)
            .then(() => {
              console.log('Address added successfully');
              showSuccessMessage('Address saved successfully!');
              hideAddressForm();
              loadSavedAddresses(user.uid);
            })
            .catch(error => {
              console.error('Error adding address:', error);
              
              if (error.code === 'permission-denied') {
                showErrorMessage('Permission denied. Please check Firestore security rules or contact support.');
                console.error('Firestore rules issue. Rules should allow: request.auth.uid == resource.data.uid');
              } else if (error.code === 'unavailable') {
                showErrorMessage('Database temporarily unavailable. Please try again.');
              } else {
                showErrorMessage('Error saving address: ' + error.message);
              }
            });
        }
        
      } catch (error) {
        console.error('Error in saveAddressDirect:', error);
        showErrorMessage(error.message);
      } finally {
        // Restore button state
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
      }
    }
    
    // Helper functions for user feedback
    function showSuccessMessage(message) {
      alert('✅ ' + message);
    }
    
    function showErrorMessage(message) {
      alert('❌ ' + message);
    }

    function saveAddress(formData) {
      console.log('saveAddress function called with:', formData);
      
      // Check if Firebase is available
      if (!window.AttralFirebase) {
        console.error('Firebase not available');
        alert('Firebase not loaded. Please refresh the page and try again.');
        return;
      }
      
      if (!window.AttralFirebase.auth) {
        console.error('Firebase auth not available');
        alert('Authentication not available. Please refresh the page and try again.');
        return;
      }
      
      if (!window.AttralFirebase.db) {
        console.error('Firebase database not available');
        alert('Database not available. Please refresh the page and try again.');
        return;
      }
      
      const user = window.AttralFirebase.auth.currentUser;
      if (!user) {
        console.error('User not authenticated');
        alert('Please sign in to save addresses');
        return;
      }
      
      console.log('User authenticated:', user.uid);
      
      const addressData = {
        uid: user.uid,
        fullName: formData.fullName,
        phone: formData.phone,
        addressLine1: formData.addressLine1,
        addressLine2: formData.addressLine2,
        city: formData.city,
        state: formData.state,
        pincode: formData.pincode,
        country: formData.country,
        isDefault: formData.isDefault || false,
        createdAt: editingAddressId ? 
          window.AttralFirebase.firestore.FieldValue.serverTimestamp() : 
          window.AttralFirebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: window.AttralFirebase.firestore.FieldValue.serverTimestamp()
      };
      
      // If setting as default, unset other default addresses
      if (addressData.isDefault) {
        console.log('Saving address as default, checking existing defaults...');
        return window.AttralFirebase.db.collection('addresses')
          .where('uid', '==', user.uid)
          .where('isDefault', '==', true)
          .get()
          .then(snapshot => {
            console.log('Found existing default addresses:', snapshot.size);
            const batch = window.AttralFirebase.db.batch();
            
            // Unset existing default addresses
            snapshot.forEach(doc => {
              batch.update(doc.ref, { isDefault: false });
            });
            
            // Save new/updated address
            if (editingAddressId) {
              console.log('Updating existing address:', editingAddressId);
              batch.update(window.AttralFirebase.db.collection('addresses').doc(editingAddressId), addressData);
            } else {
              console.log('Adding new address');
              batch.set(window.AttralFirebase.db.collection('addresses').doc(), addressData);
            }
            
            return batch.commit();
          })
          .then(() => {
            console.log('Address saved successfully');
            alert('Address saved successfully!');
            hideAddressForm();
            loadSavedAddresses(user.uid);
          })
          .catch(error => {
            console.error('Error saving address:', error);
            alert('Error saving address: ' + error.message);
          });
      } else {
        // Save without default logic
        console.log('Saving address without default logic');
        if (editingAddressId) {
          console.log('Updating existing address:', editingAddressId);
          return window.AttralFirebase.db.collection('addresses')
            .doc(editingAddressId)
            .update(addressData)
            .then(() => {
              console.log('Address updated successfully');
              alert('Address updated successfully!');
              hideAddressForm();
              loadSavedAddresses(user.uid);
            })
            .catch(error => {
              console.error('Error updating address:', error);
              alert('Error updating address: ' + error.message);
            });
        } else {
          console.log('Adding new address');
          return window.AttralFirebase.db.collection('addresses')
            .add(addressData)
            .then(() => {
              console.log('Address added successfully');
              alert('Address saved successfully!');
              hideAddressForm();
              loadSavedAddresses(user.uid);
            })
            .catch(error => {
              console.error('Error adding address:', error);
              alert('Error adding address: ' + error.message);
            });
        }
      }
    }
    
    function validateAddressForm(formData) {
      const errors = [];
      
      if (!formData.fullName.trim()) errors.push('Full name is required');
      if (!formData.phone.trim()) errors.push('Phone number is required');
      if (!/^[6-9]\d{9}$/.test(formData.phone.replace(/\D/g, ''))) {
        errors.push('Please enter a valid 10-digit phone number');
      }
      if (!formData.addressLine1.trim()) errors.push('Address line 1 is required');
      if (!formData.city.trim()) errors.push('City is required');
      if (!formData.state) errors.push('State is required');
      if (!formData.pincode.trim()) errors.push('Pincode is required');
      if (!/^\d{6}$/.test(formData.pincode)) {
        errors.push('Please enter a valid 6-digit pincode');
      }
      
      return errors;
    }
    
    // Event Listeners for Address Management
    document.addEventListener('DOMContentLoaded', function() {
      // Add address button
      const addAddressBtn = qs('add-address-btn');
      if (addAddressBtn) {
        addAddressBtn.addEventListener('click', showAddressForm);
      }
      
      // Cancel address form
      const cancelAddressBtn = qs('cancel-address');
      if (cancelAddressBtn) {
        cancelAddressBtn.addEventListener('click', hideAddressForm);
      }
      
      // Test Firebase button
      const testFirebaseBtn = qs('test-firebase');
      if (testFirebaseBtn) {
        testFirebaseBtn.addEventListener('click', function() {
          console.log('Testing Firebase connection...');
          
          if (!window.AttralFirebase) {
            alert('❌ Firebase not loaded');
            return;
          }
          
          if (!window.AttralFirebase.auth) {
            alert('❌ Firebase Auth not available');
            return;
          }
          
          if (!window.AttralFirebase.db) {
            alert('❌ Firebase Database not available');
            return;
          }
          
          const user = window.AttralFirebase.auth.currentUser;
          if (!user) {
            alert('❌ User not signed in');
            return;
          }
          
          alert('✅ Firebase is working! User: ' + (user.email || user.uid) + (user.isAnonymous ? ' (Anonymous)' : ''));
        });
      }
      
      // Direct click handler for save address button
      const saveAddressBtn = qs('save-address');
      if (saveAddressBtn) {
        saveAddressBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Save address button clicked directly');
          
          // Collect form data directly
          const formData = {
            fullName: document.getElementById('full-name')?.value || '',
            phone: document.getElementById('phone')?.value || '',
            addressLine1: document.getElementById('address-line1')?.value || '',
            addressLine2: document.getElementById('address-line2')?.value || '',
            city: document.getElementById('city')?.value || '',
            state: document.getElementById('state')?.value || '',
            pincode: document.getElementById('pincode')?.value || '',
            country: document.getElementById('country')?.value || '',
            isDefault: document.getElementById('is-default')?.checked || false
          };
          
          console.log('Form data collected:', formData);
          
          // Basic validation
          if (!formData.fullName.trim()) {
            alert('Please enter your full name');
            document.getElementById('full-name').focus();
            return;
          }
          
          if (!formData.phone.trim()) {
            alert('Please enter your phone number');
            document.getElementById('phone').focus();
            return;
          }
          
          if (!formData.addressLine1.trim()) {
            alert('Please enter your address');
            document.getElementById('address-line1').focus();
            return;
          }
          
          if (!formData.city.trim()) {
            alert('Please enter your city');
            document.getElementById('city').focus();
            return;
          }
          
          if (!formData.state) {
            alert('Please select your state');
            document.getElementById('state').focus();
            return;
          }
          
          if (!formData.pincode.trim()) {
            alert('Please enter your pincode');
            document.getElementById('pincode').focus();
            return;
          }
          
          console.log('Basic validation passed, proceeding to save...');
          
          // Call save function
          saveAddressDirect(formData);
        });
      }
      
      // Phone number formatting
      const phoneInput = qs('phone');
      if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length > 10) value = value.substring(0, 10);
          e.target.value = value;
        });
      }
      
      // Pincode formatting
      const pincodeInput = qs('pincode');
      if (pincodeInput) {
        pincodeInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length > 6) value = value.substring(0, 6);
          e.target.value = value;
        });
      }
    });
    
    // Update loadUserDashboardData to include addresses and affiliate data
    const originalLoadUserDashboardData = loadUserDashboardData;
    loadUserDashboardData = function() {
      originalLoadUserDashboardData();
      const user = window.AttralFirebase?.auth?.currentUser;
      if (user) {
        loadSavedAddresses(user.uid);
        loadAffiliateData(user.uid);
      }
    };
    
    // Test Firebase connectivity
    function testFirebaseConnection() {
      console.log('Testing Firebase connection...');
      console.log('Current domain:', window.location.host);
      console.log('Current origin:', window.location.origin);
      console.log('AttralFirebase available:', !!window.AttralFirebase);
      console.log('Auth available:', !!window.AttralFirebase?.auth);
      console.log('Database available:', !!window.AttralFirebase?.db);
      console.log('Current user:', window.AttralFirebase?.auth?.currentUser);
      
      if (window.AttralFirebase?.db) {
        // Test database write with user authentication
        const user = window.AttralFirebase.auth?.currentUser;
        if (!user) {
          console.error('No authenticated user for database test');
          return;
        }
        
        console.log('Testing database write with user:', user.uid);
        const testRef = window.AttralFirebase.db.collection('test').doc(user.uid);
        testRef.set({
          timestamp: new Date(),
          test: true,
          uid: user.uid
        }).then(() => {
          console.log('Firebase database write test successful');
          // Clean up test document
          testRef.delete();
        }).catch(error => {
          console.error('Firebase database write test failed:', error);
          console.error('Error details:', error.code, error.message);
        });
      }
    }
    
    // Enhanced Firebase test with better error reporting
    function testFirebaseDetailed() {
      console.log('=== DETAILED FIREBASE TEST ===');
      
      if (!window.AttralFirebase) {
        console.error('❌ AttralFirebase not available');
        return;
      }
      
      if (!window.AttralFirebase.auth) {
        console.error('❌ Firebase Auth not available');
        return;
      }
      
      if (!window.AttralFirebase.db) {
        console.error('❌ Firebase Database not available');
        return;
      }
      
      const user = window.AttralFirebase.auth.currentUser;
      if (!user) {
        console.error('❌ No authenticated user');
        return;
      }
      
      console.log('✅ User authenticated:', user.uid, user.email);
      console.log('✅ User is anonymous:', user.isAnonymous);
      
      // Test Firestore rules by trying to read user document
      window.AttralFirebase.db.collection('users').doc(user.uid).get()
        .then(doc => {
          console.log('✅ User document read successful:', doc.exists);
        })
        .catch(error => {
          console.error('❌ User document read failed:', error);
        });
      
      // Test Firestore write with addresses collection
      const testAddressRef = window.AttralFirebase.db.collection('addresses').doc();
      testAddressRef.set({
        uid: user.uid,
        test: true,
        timestamp: new Date()
      }).then(() => {
        console.log('✅ Address collection write test successful');
        testAddressRef.delete();
      }).catch(error => {
        console.error('❌ Address collection write test failed:', error);
        console.error('Error code:', error.code);
        console.error('Error message:', error.message);
      });
    }
    
    // Run Firebase test after a delay to ensure everything is loaded
    setTimeout(testFirebaseConnection, 2000);
    setTimeout(testFirebaseDetailed, 3000);
    
    // Function to trigger affiliate index creation
    function createAffiliateIndexes() {
      if (!window.AttralFirebase?.db) {
        console.log('Firebase not available');
        return;
      }
      
      const user = window.AttralFirebase.auth.currentUser;
      if (!user) {
        console.log('User not authenticated');
        return;
      }
      
      console.log('Triggering affiliate index creation...');
      
      // This will trigger index creation for affiliate_applications
      window.AttralFirebase.db.collection('affiliate_applications')
        .where('uid', '==', user.uid)
        .where('status', '==', 'pending')
        .get()
        .then(() => console.log('affiliate_applications index ready'))
        .catch(error => {
          if (error.message.includes('index')) {
            console.log('Create affiliate_applications index:', error.message);
            // The error message will contain the link to create the index
          }
        });
      
      // This will trigger index creation for affiliate_commissions
      window.AttralFirebase.db.collection('affiliate_commissions')
        .where('uid', '==', user.uid)
        .orderBy('createdAt', 'desc')
        .get()
        .then(() => console.log('affiliate_commissions index ready'))
        .catch(error => {
          if (error.message.includes('index')) {
            console.log('Create affiliate_commissions index:', error.message);
          }
        });
      
      // This will trigger index creation for affiliate_performance
      window.AttralFirebase.db.collection('affiliate_performance')
        .where('uid', '==', user.uid)
        .orderBy('timestamp', 'desc')
        .get()
        .then(() => console.log('affiliate_performance index ready'))
        .catch(error => {
          if (error.message.includes('index')) {
            console.log('Create affiliate_performance index:', error.message);
          }
        });
      
      // This will trigger index creation for affiliate_referrals
      window.AttralFirebase.db.collection('affiliate_referrals')
        .where('uid', '==', user.uid)
        .orderBy('timestamp', 'desc')
        .get()
        .then(() => console.log('affiliate_referrals index ready'))
        .catch(error => {
          if (error.message.includes('index')) {
            console.log('Create affiliate_referrals index:', error.message);
          }
        });
      
      // This will trigger index creation for affiliate_payouts
      window.AttralFirebase.db.collection('affiliate_payouts')
        .where('uid', '==', user.uid)
        .orderBy('createdAt', 'desc')
        .get()
        .then(() => console.log('affiliate_payouts index ready'))
        .catch(error => {
          if (error.message.includes('index')) {
            console.log('Create affiliate_payouts index:', error.message);
          }
        });
    }
    
    // Run affiliate index creation after Firebase is loaded
    setTimeout(createAffiliateIndexes, 4000);
    
    // Quick fix for Firestore rules issue
    function ensureUserAuthenticated() {
      return new Promise((resolve, reject) => {
        if (!window.AttralFirebase || !window.AttralFirebase.auth) {
          reject(new Error('Firebase not available'));
          return;
        }
        
        const user = window.AttralFirebase.auth.currentUser;
        if (user && !user.isAnonymous) {
          resolve(user);
          return;
        }
        
        // If no user or anonymous, try to sign in anonymously
        console.log('No authenticated user, attempting anonymous sign-in...');
        window.AttralFirebase.auth.signInAnonymously()
          .then(userCredential => {
            console.log('Anonymous sign-in successful:', userCredential.user.uid);
            resolve(userCredential.user);
          })
          .catch(error => {
            console.error('Anonymous sign-in failed:', error);
            reject(error);
          });
      });
    }
    
    // Affiliate Data Management Functions
    function loadAffiliateData(uid) {
      if (!window.AttralFirebase?.db) {
        console.log('Firebase not available for loading affiliate data');
        return;
      }
      
      console.log('Loading affiliate data for user:', uid);
      
      // Load affiliate application status
      loadAffiliateApplication(uid);
      
      // Load affiliate performance data
      loadAffiliatePerformance(uid);
      
      // Load affiliate commissions
      loadAffiliateCommissions(uid);
    }
    
    function loadAffiliateApplication(uid) {
      window.AttralFirebase.db.collection('affiliate_applications')
        .where('uid', '==', uid)
        .limit(1)
        .get()
        .then(snapshot => {
          if (!snapshot.empty) {
            const doc = snapshot.docs[0];
            const application = doc.data();
            console.log('Affiliate application found:', application);
            
            // Update UI with affiliate status
            updateAffiliateStatus(application);
          } else {
            console.log('No affiliate application found');
            updateAffiliateStatus(null);
          }
        })
        .catch(error => {
          console.error('Error loading affiliate application:', error);
        });
    }
    
    function loadAffiliatePerformance(uid) {
      window.AttralFirebase.db.collection('affiliate_performance')
        .where('uid', '==', uid)
        .orderBy('timestamp', 'desc')
        .limit(10)
        .get()
        .then(snapshot => {
          const performance = [];
          snapshot.forEach(doc => {
            performance.push({ id: doc.id, ...doc.data() });
          });
          console.log('Affiliate performance loaded:', performance);
          
          // Update UI with performance data
          updateAffiliatePerformance(performance);
        })
        .catch(error => {
          console.error('Error loading affiliate performance:', error);
        });
    }
    
    function loadAffiliateCommissions(uid) {
      window.AttralFirebase.db.collection('affiliate_commissions')
        .where('uid', '==', uid)
        .orderBy('createdAt', 'desc')
        .limit(20)
        .get()
        .then(snapshot => {
          const commissions = [];
          snapshot.forEach(doc => {
            commissions.push({ id: doc.id, ...doc.data() });
          });
          console.log('Affiliate commissions loaded:', commissions);
          
          // Update UI with commissions data
          updateAffiliateCommissions(commissions);
        })
        .catch(error => {
          console.error('Error loading affiliate commissions:', error);
        });
    }
    
    function saveAffiliateApplication(applicationData) {
      return new Promise((resolve, reject) => {
        if (!window.AttralFirebase?.db) {
          reject(new Error('Firebase not available'));
          return;
        }
        
        const user = window.AttralFirebase.auth.currentUser;
        if (!user) {
          reject(new Error('User not authenticated'));
          return;
        }
        
        const application = {
          uid: user.uid,
          email: user.email,
          status: 'pending',
          applicationDate: new Date(),
          ...applicationData
        };
        
        window.AttralFirebase.db.collection('affiliate_applications')
          .add(application)
          .then(docRef => {
            console.log('Affiliate application saved:', docRef.id);
            resolve(docRef.id);
          })
          .catch(error => {
            console.error('Error saving affiliate application:', error);
            reject(error);
          });
      });
    }
    
    function saveAffiliateReferral(referralData) {
      return new Promise((resolve, reject) => {
        if (!window.AttralFirebase?.db) {
          reject(new Error('Firebase not available'));
          return;
        }
        
        const user = window.AttralFirebase.auth.currentUser;
        if (!user) {
          reject(new Error('User not authenticated'));
          return;
        }
        
        const referral = {
          uid: user.uid,
          affiliateId: user.uid,
          timestamp: new Date(),
          ...referralData
        };
        
        window.AttralFirebase.db.collection('affiliate_referrals')
          .add(referral)
          .then(docRef => {
            console.log('Affiliate referral saved:', docRef.id);
            resolve(docRef.id);
          })
          .catch(error => {
            console.error('Error saving affiliate referral:', error);
            reject(error);
          });
      });
    }
    
    function updateAffiliateStatus(application) {
      // Update affiliate status in the dashboard
      const affiliateStatusElement = document.getElementById('affiliate-status');
      if (affiliateStatusElement) {
        if (application) {
          affiliateStatusElement.innerHTML = `
            <div class="affiliate-status ${application.status}">
              <h4>Affiliate Status: ${application.status.charAt(0).toUpperCase() + application.status.slice(1)}</h4>
              <p>Applied: ${new Date(application.applicationDate).toLocaleDateString()}</p>
              ${application.status === 'approved' ? '<p>🎉 Congratulations! You are an approved affiliate.</p>' : ''}
            </div>
          `;
        } else {
          affiliateStatusElement.innerHTML = `
            <div class="affiliate-status not-applied">
              <h4>Not Yet an Affiliate</h4>
              <p>Apply to become an affiliate and start earning commissions!</p>
              <button class="btn-primary" onclick="showAffiliateApplication()">Apply Now</button>
            </div>
          `;
        }
      }
    }
    
    function updateAffiliatePerformance(performance) {
      // Update affiliate performance in the dashboard
      const performanceElement = document.getElementById('affiliate-performance');
      if (performanceElement && performance.length > 0) {
        let performanceHTML = '<h4>Recent Performance</h4><ul>';
        performance.forEach(item => {
          performanceHTML += `
            <li>
              <strong>${item.type}:</strong> ${item.value}
              <span class="date">${new Date(item.timestamp).toLocaleDateString()}</span>
            </li>
          `;
        });
        performanceHTML += '</ul>';
        performanceElement.innerHTML = performanceHTML;
      }
    }
    
    function updateAffiliateCommissions(commissions) {
      // Update affiliate commissions in the dashboard
      const commissionsElement = document.getElementById('affiliate-commissions');
      if (commissionsElement && commissions.length > 0) {
        let commissionsHTML = '<h4>Recent Commissions</h4><ul>';
        commissions.forEach(commission => {
          commissionsHTML += `
            <li>
              <strong>₹${commission.amount}:</strong> ${commission.description}
              <span class="date">${new Date(commission.createdAt).toLocaleDateString()}</span>
            </li>
          `;
        });
        commissionsHTML += '</ul>';
        commissionsElement.innerHTML = commissionsHTML;
      }
    }
    
    function showAffiliateApplication() {
      // Show affiliate application form
      const applicationData = {
        businessType: 'Individual',
        website: '',
        socialMedia: '',
        marketingExperience: 'Beginner',
        expectedMonthlySales: '1-10',
        additionalInfo: ''
      };
      
      if (confirm('Would you like to apply to become an affiliate?')) {
        saveAffiliateApplication(applicationData)
          .then(() => {
            alert('✅ Affiliate application submitted successfully!');
            loadAffiliateData(window.AttralFirebase.auth.currentUser.uid);
          })
          .catch(error => {
            alert('❌ Error submitting application: ' + error.message);
          });
      }
    }
    
    // Emergency bypass function to test Firestore rules
    function testFirestoreBypass() {
      if (!window.AttralFirebase?.db) {
        alert('Firebase not available');
        return;
      }
      
      const user = window.AttralFirebase.auth.currentUser;
      if (!user) {
        alert('User not authenticated');
        return;
      }
      
      console.log('Testing Firestore bypass...');
      
      // Try to write to test collection with minimal data
      window.AttralFirebase.db.collection('test').doc('bypass-test').set({
        uid: user.uid,
        timestamp: new Date(),
        test: true
      }).then(() => {
        alert('✅ Firestore write successful! Rules are working.');
        console.log('Firestore bypass test successful');
      }).catch(error => {
        alert('❌ Firestore write failed: ' + error.message);
        console.error('Firestore bypass test failed:', error);
        
        if (error.code === 'permission-denied') {
          alert('🚨 PERMISSION DENIED - Firestore rules need to be updated!');
          console.log('Go to: https://console.firebase.google.com/project/e-commerce-1d40f/firestore/rules');
          console.log('Replace rules with: allow read, write: if request.auth != null;');
        }
      });
    }
    
    // Add bypass test button to console
    console.log('🔧 Emergency Firestore Test Function Available');
    console.log('Run: testFirestoreBypass() to test Firestore rules');
  </script>
</body>
</html>
